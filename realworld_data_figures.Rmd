---
title: "Realworld Data Figures"
output: html_document
---

```{r,message=FALSE,warning=FALSE}
library(splatter)
library(Seurat)
library(speckle)
library(DCATS)
library(ggplot2)
library(tidyverse)
library(tidymodels)
library(diffcyt)
library(caret)
```

```{r}
source("functions.r")
```

## Experiment 7

## real-world data 1

## Experiment 7

The 'group' column started with 'B' is the indicators of replicates

```{r}
exp7_data <- read.csv("./data/real_world/Exp7_Adam_2017/celltypelabels_Haber.txt", sep="") %>% 
  rownames_to_column("cell") %>% 
  separate(cell, c("group", "barcode", "condition", "cluster"), sep = "_") %>% 
  mutate(group = as.factor(group),
         condition = as.factor(condition),
         cluster = as.factor(cluster)) %>% 
  dplyr::select(-x)

head(exp7_data)
summary(exp7_data)

exp7_data %>% 
  group_by(group, condition) %>% 
  summarise(n = n())
```

```{r}
geneExpM <- read.delim("./data/real_world/Exp7_Adam_2017/GSE92332_SalmHelm_UMIcounts.txt", header=TRUE)
test2 = colnames(geneExpM)
test2a = str_split(test2, "_")
barcode = rep(NA, length(test2))
group = rep(NA, length(test2))
for (i in 1:length(test2)) {
  barcode[i] = test2a[[i]][2]
  group[i] = test2a[[i]][1]
}
test2b = data.frame(barcode = barcode, group = group) %>% 
  filter(barcode %in% exp7_data$barcode)

test2b %>% group_by(group) %>% 
  summarise(n = n())
```

```{r}
seuratObj <- CreateSeuratObject(counts = geneExpM, project="Exp7")
seuratObj <- NormalizeData(seuratObj)
seuratObj <- FindVariableFeatures(seuratObj, selection.method = "vst", nfeatures = 2000)
seuratObj <- ScaleData(seuratObj)
seuratObj <- RunPCA(seuratObj, npcs = 30, verbose = FALSE)
```

```{r}
exp7DF = seuratObj@reductions$pca@cell.embeddings %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column("cell") %>% 
  separate(cell, c("group", "barcode", "condition", "cluster"), sep = "_")

## check whether there is duplicate ID -> No with cellID, Yes with only barcode
#exp7 %>% group_by(cell) %>% summarise(n = n()) %>% filter(n != 1)
```

Define a recipe

```{r}
exp7_model = exp7DF %>% select(-barcode)
set.seed(123) 
# create CV object from training data
exp7_cv <- vfold_cv(exp7_model)
exp7_split <- initial_split(exp7_model, prop = 3/4)
# define the recipe
exp7_recipe <- 
  # which consists of the formula (outcome ~ predictors)
  recipe(cluster ~ ., data = exp7_model)
exp7_recipe
```

Specify the model

```{r}
rf_model <- 
  # specify that the model is a random forest
  rand_forest() %>%
  # specify that the `mtry` parameter needs to be tuned
  set_args(mtry = tune()) %>%
  # select the engine/package that underlies the model
  set_engine("ranger", importance = "impurity") %>%
  # choose either the continuous regression or binary classification mode
  set_mode("classification") 
```

```{r}
svm_mod <-
  svm_rbf(cost = tune(), rbf_sigma = tune()) %>%
  set_mode("classification") %>%
  set_engine("kernlab")
```

Put it all together in a workflow

```{r}
# set the workflow
rf_workflow <- workflow() %>%
  # add the recipe
  add_recipe(exp7_recipe) %>%
  # add the model
  add_model(rf_model)
```

Tune the parameters

```{r}
# specify which values eant to try
rf_grid <- expand.grid(mtry = 4:7)
# extract results
rf_tune_results <- rf_workflow %>%
  tune_grid(resamples = exp7_cv, #CV object
            grid = rf_grid, # grid of values to try
            metrics = metric_set(accuracy, roc_auc) # metrics we care about
            )
```

Finalize the workflow

```{r}
param_final <- rf_tune_results %>%
  select_best(metric = "accuracy")
param_final

rf_workflow <- rf_workflow %>%
  finalize_workflow(param_final)
```

```{r}
onefold_split = exp7_cv[[1]][[1]]
rf_fit <- rf_workflow %>%
  # fit on the training set and evaluate on test set
  last_fit(onefold_split)
```


```{r}
## control vs Hpoly.Day3
exp7_C3 = exp7_data %>% 
  filter(condition == "Control" | condition == "Hpoly.Day3") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_C3)
print(fisherP)

## control vs Hpoly.Day10
exp7_C10 = exp7_data %>% 
  filter(condition == "Control" | condition == "Hpoly.Day10") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_C10)
print(fisherP)

## control vs Salmonella
exp7_CS = exp7_data %>% 
  filter(condition == "Control" | condition == "Salmonella") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_CS)
print(fisherP)
```
