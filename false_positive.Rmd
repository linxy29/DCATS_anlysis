---
title: "False positive Control"
author: "Xinyi Lin"
date: "10/3/2020"
output: html_document
---

Problems need to solve:

2. scDC: doesn't work

3. ROC curve? 

4. DCATS: true matrix Hungarian method; knn matrix: change order(updata package)

5. paper: figures in standard format; choose which cases 

Some finding:

1. Identity matrix works the best

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r,message=FALSE,warning=FALSE}
library(splatter)
library(Seurat)
library(speckle)
library(DCATS)
library(ggplot2)
library(tidyverse)
library(diffcyt)
```

```{r}
source("functions.r")
```

## Experiment 6

Import data, we only need 'GSE96583_batch2.total.tsne.df'

```{r}
GSE96583_batch2.total.tsne.df <- read.delim("D:/#Codes/R/Ho_DCATS/data/GSE96583_batch2.total.tsne.df.tsv")
summary(GSE96583_batch2.total.tsne.df)
# check NA
apply(is.na(GSE96583_batch2.total.tsne.df),2,sum)
```

No cluster have different proportion in 'ctrl' and 'stim' group.

```{r}
# data preprocessing 
batchlabels <- GSE96583_batch2.total.tsne.df[,6][!is.na(GSE96583_batch2.total.tsne.df[,6])]
conditionlabels <- GSE96583_batch2.total.tsne.df[,4][!is.na(GSE96583_batch2.total.tsne.df[,6])]
batch2info <- table(conditionlabels,batchlabels)

# plotting 
heat_matrix(batch2info,show_value = TRUE)
```

```{r}
exp6_df = GSE96583_batch2.total.tsne.df %>% 
  filter(!is.na(cell)) %>% 
  group_by(cell, stim) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = "stim", values_from = "n")

exp6_mat = data.matrix(exp6_df[,c(2,3)])

params = splatEstimate(exp6_mat)
sim = splatSimulate(params)
```

Simulate our own data based on GSE96583_batch2.total.tsne.df

## Experiment 7

```{r}
# CR_Exp7_1 
# data preprocessing
Fig6_tSNE <- read.delim("./data/Fig6_tSNE.txt")
subjectnameswhole <- Fig6_tSNE[,1]
subjectnameswhole <- subjectnameswhole[2:length(subjectnameswhole)]
celltypelabels <- gsub(".*_","",subjectnameswhole)
conditionnames <- gsub(".*[AGCT]_","",subjectnameswhole)
conditionnames <- gsub("_.*","",conditionnames)
subjectinfo <- table(conditionnames,celltypelabels)
micenames <- gsub("_.*","",subjectnameswhole)
indivsubjectnames <- sapply(seq_len(9842),function(t){paste(micenames[t],conditionnames[t],sep="_")})
indivsubjectinfo <- table(indivsubjectnames,celltypelabels)
properord <- c(1,3,4,5,6,7,8,9,10,2)
indivsubjectinfo <- sapply(properord,function(t){indivsubjectinfo[t,]})
indivsubjectinfo <- t(indivsubjectinfo)
rownames(indivsubjectinfo) <- unique(indivsubjectnames)
combinations <- t(combn(seq_len(4),2))
setupnames <- c("Control","Hpoly.Day3","Hpoly.Day10","Salmonella")
combination_setup <- list()
for (i in 1:6){
  k <- combinations[i,]
  a <- k[1]
  b <- k[2]
  comparisons_names <- paste(setupnames[a],"vs",setupnames[b],sep="_")
  combination_setup[[i]] <- comparisons_names
}
```

## HCC data

```{r}
HCC_seurat <- readRDS("/storage/holab/hcc_data/RDS_files/SCT/HCC.final.SCT_pc10_res0.1.rds")
```

```{r}
count_dgCM = HCC_seurat@assays$RNA@counts
params <- splatEstimate(as.matrix(count_dgCM))
params
saveRDS(params, "./data/HCCparams.rds")
```

## mnnCT7

```{r}
mnnCT7_seurat <- readRDS("/storage/holab/Nelson/mnnCT7.rds")
```

```{r}
count_mnnCT7 = mnnCT7_seurat@assays$RNA@counts
```

## Simulate data

small cluster: 0.01-0.05

```{r}
set.seed(123)
probNor = c(0.57, 0.11, 0.31, 0.01)
probMut = c(0.57, 0.11, 0.31, 0.01)
setresolu = 0.15
batch_size = 22000
de_prob = c(0.15, 0.40, 0.02, 0.14)
  
sim_list = simualtion(probNor, probMut, de_prob, batch_size)
integratedSamples = runSeurat(sim_list, batch_size, setresolu)
saveRDS(integratedSamples, "./data/integratedSamples_neg.rds")
integratedSamples = readRDS("./data/integratedSamples_neg.rds")
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
Res = getPandTimeFSDD4(integratedSamples, sim_list, batch_size)
print(Res)
```

Try to use parameters extract from HCC data. Need to use parallel. 

```{r,warning=FALSE, message=FALSE}
library(future)
# check the current active plan
plan()
```

```{r}
# change the current plan to access parallelization
plan("multiprocess", workers = 4)
plan()
options(future.globals.maxSize = 2000 * 1024^2)
```

When clusters' numbers equals to four

```{r}
set.seed(123)
probNor = c(0.57, 0.11, 0.31, 0.01)
probMut = c(0.57, 0.11, 0.31, 0.01)
setresolu = 0.08
batch_size = 20000
de_prob = c(0.15, 0.40, 0.02, 0.14)
```

```{r}
sim_list = simualtionHCC(probNor, probMut, batch_size =  batch_size)
integratedSamples = runSeurat(sim_list, batch_size, setresolu)
saveRDS(integratedSamples, "./data/integratedSamples_HCC4.rds")
integratedSamples = readRDS("./data/integratedSamples_HCC4.rds")
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
Res = getPandTimeFSDD4(integratedSamples, sim_list, batch_size)
print(Res)
```

When clusters' numbers equals to six

```{r}
set.seed(123)
probNor = c(0.52, 0.11, 0.20, 0.01, 0.01, 0.15)
probMut = c(0.52, 0.11, 0.20, 0.01, 0.01, 0.15)
setresolu = 0.1
batch_size = 10000
de_prob = c(0.15, 0.40, 0.02, 0.14, 0.02, 0.17)
```

```{r}
sim_list = simualtionHCC(probNor, probMut, batch_size =  batch_size)
integratedSamples = runSeurat(sim_list, batch_size, setresolu)
saveRDS(integratedSamples, "./data/integratedSamples_HCC6.rds")
integratedSamples = readRDS("./data/integratedSamples_HCC6.rds")
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
Res = getPandTimeFSDD6(integratedSamples, sim_list, batch_size)
print(Res)
```


Try to set ‘de.downProb’ and ‘de.facLoc’.


