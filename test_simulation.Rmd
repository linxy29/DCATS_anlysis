---
title: "test_simulation"
author: "Xinyi Lin"
date: "2/23/2021"
output: html_document
---

This file is used to test whether the evaluation process has problems

```{r, message=FALSE}
library(tidyverse)
library(DCATS)
```

```{r}
source("functionsV2.r")
options(future.globals.maxSize = 20000 * 1024^2) # 20G memory
```

## one simulation, two condition

Consistent sample size

### try situation with more negative cases

```{r}
sample_size = 1000
```

```{r}
rep1 = 2
rep2 = 3
cluster_num = 9
probC1 = c(rep(0.1, 8), 0.2)  # True proportions
probC2 = c(rep(0.1, 7), 0.15, 0.15)
truthRes = c(rep("N", 7), "P", "P")
```

```{r}
simil_mat = get_similarity_mat(cluster_num, confuse_rate=0)
print(simil_mat)
```

```{r, warning=FALSE}
numb_cond1 = rmultinom(rep1, sample_size, probC1) %>% t()
numb_cond2 = rmultinom(rep2, sample_size, probC2) %>% t()
### DCATS
betabin_noBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = FALSE)
betabin_wBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = TRUE, similarity_mat = simil_mat)
betabin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = FALSE)
bin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = TRUE)
### fisher
fisher_pvals1 = getFisher(numb_cond1, numb_cond2)
pvalsDF = data.frame(truth = truthRes, noBC_pvals = betabin_noBC$pvals, wBC_pavls = betabin_wBC$pvals, betabin_pvals = betabin_wM$pvals, bin_pvals = bin_wM$pvals, fisher_pvals = fisher_pvals1)
pvalsDF %>% 
  mutate(noBC_res = ifelse(noBC_pvals < 0.05, "P","N"),
         wBC_res = ifelse(wBC_pavls < 0.05, "P", "N"),
         betabin_res = ifelse(betabin_pvals < 0.05, "P", "N"),
         bin_res = ifelse(bin_pvals < 0.05, "P", "N"),
         fisher_res = ifelse(fisher_pvals < 0.05, "P", "N"),) %>% 
  dplyr::select(truth, contains("_res")) %>% print()
```

### try situation with more positive cases

```{r}
rep1 = 2
rep2 = 3
cluster_num = 7
probC1 = c(rep(0.1, 4), 0.3, 0.15, 0.15)  # True proportions
probC2 = c(rep(0.15, 4), 0.1, 0.15, 0.15)
truthRes = c(rep("P", 5), "N", "N")
```

```{r}
simil_mat = get_similarity_mat(cluster_num, confuse_rate=0)
print(simil_mat)
```

```{r, warning=FALSE}
numb_cond1 = rmultinom(rep1, sample_size, probC1) %>% t()
numb_cond2 = rmultinom(rep2, sample_size, probC2) %>% t()
### DCATS
betabin_noBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = FALSE)
betabin_wBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = TRUE, similarity_mat = simil_mat)
betabin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = FALSE)
bin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = TRUE)
### fisher
fisher_pvals1 = getFisher(numb_cond1, numb_cond2)
pvalsDF = data.frame(truth = truthRes, noBC_pvals = betabin_noBC$pvals, wBC_pavls = betabin_wBC$pvals, betabin_pvals = betabin_wM$pvals, bin_pvals = bin_wM$pvals, fisher_pvals = fisher_pvals1)
pvalsDF %>% 
  mutate(noBC_res = ifelse(noBC_pvals < 0.05, "P","N"),
         wBC_res = ifelse(wBC_pavls < 0.05, "P", "N"),
         betabin_res = ifelse(betabin_pvals < 0.05, "P", "N"),
         bin_res = ifelse(bin_pvals < 0.05, "P", "N"),
         fisher_res = ifelse(fisher_pvals < 0.05, "P", "N"),) %>% 
  dplyr::select(truth, contains("_res")) %>% print()
```

Without similarity matrix, betabin boostrap will be too sensitive while bin has the similar sensitivity as fisher. `noBC` and `wBC` might be too flexible?

## add uniform matrix

```{r}
sample_size = 1000
```

```{r}
rep1 = 2
rep2 = 3
cluster_num = 9
probC1 = c(rep(0.1, 8), 0.2)  # True proportions
probC2 = c(rep(0.1, 7), 0.15, 0.15)
truthRes = c(rep("N", 7), "P", "P")
```

```{r}
simil_mat = get_similarity_mat(cluster_num, confuse_rate=0.1)
print(simil_mat)
```

```{r, warning=FALSE}
numb_cond1 = rmultinom(rep1, sample_size, probC1) %>% t()
numb_cond2 = rmultinom(rep2, sample_size, probC2) %>% t()
### DCATS
betabin_noBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = FALSE)
betabin_wBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = TRUE, similarity_mat = simil_mat)
betabin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = FALSE)
bin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = TRUE)
### fisher
fisher_pvals1 = getFisher(numb_cond1, numb_cond2)
pvalsDF = data.frame(truth = truthRes, noBC_pvals = betabin_noBC$pvals, wBC_pavls = betabin_wBC$pvals, betabin_pvals = betabin_wM$pvals, bin_pvals = bin_wM$pvals, fisher_pvals = fisher_pvals1)
pvalsDF %>% 
  mutate(noBC_res = ifelse(noBC_pvals < 0.05, "P","N"),
         wBC_res = ifelse(wBC_pavls < 0.05, "P", "N"),
         betabin_res = ifelse(betabin_pvals < 0.05, "P", "N"),
         bin_res = ifelse(bin_pvals < 0.05, "P", "N"),
         fisher_res = ifelse(fisher_pvals < 0.05, "P", "N"),) %>% 
  dplyr::select(truth, contains("_res")) %>% print()
```

### try situation with more positive cases

```{r}
rep1 = 2
rep2 = 3
cluster_num = 7
probC1 = c(rep(0.1, 4), 0.3, 0.15, 0.15)  # True proportions
probC2 = c(rep(0.15, 4), 0.1, 0.15, 0.15)
truthRes = c(rep("P", 5), "N", "N")
```

```{r}
simil_mat = get_similarity_mat(cluster_num, confuse_rate=0.1)
print(simil_mat)
```

```{r, warning=FALSE}
numb_cond1 = rmultinom(rep1, sample_size, probC1) %>% t()
numb_cond2 = rmultinom(rep2, sample_size, probC2) %>% t()
### DCATS
betabin_noBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = FALSE)
betabin_wBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = TRUE, similarity_mat = simil_mat)
betabin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = FALSE)
bin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = TRUE)
### fisher
fisher_pvals1 = getFisher(numb_cond1, numb_cond2)
pvalsDF = data.frame(truth = truthRes, noBC_pvals = betabin_noBC$pvals, wBC_pavls = betabin_wBC$pvals, betabin_pvals = betabin_wM$pvals, bin_pvals = bin_wM$pvals, fisher_pvals = fisher_pvals1)
pvalsDF %>% 
  mutate(noBC_res = ifelse(noBC_pvals < 0.05, "P","N"),
         wBC_res = ifelse(wBC_pavls < 0.05, "P", "N"),
         betabin_res = ifelse(betabin_pvals < 0.05, "P", "N"),
         bin_res = ifelse(bin_pvals < 0.05, "P", "N"),
         fisher_res = ifelse(fisher_pvals < 0.05, "P", "N"),) %>% 
  dplyr::select(truth, contains("_res")) %>% print()
```

After adding uniform similarity matrix, the sensitivity: betabin < bin < noBC&WBC

## evalulate the influence of other similarity matrix

```{r}
sample_size = 1000
```

```{r}
rep1 = 2
rep2 = 3
cluster_num = 9
probC1 = c(rep(0.1, 8), 0.2)  # True proportions
probC2 = c(rep(0.1, 7), 0.15, 0.15)
truthRes = c(rep("N", 7), "P", "P")
```

```{r}
simil_mat = get_similarity_mat(cluster_num, confuse_rate=0.1)
misV = simil_mat[,1]*0.3
simil_mat[,1] = simil_mat[,1]*0.7
simil_mat[,3] = simil_mat[,3] + misV
print(simil_mat)
```

```{r, warning=FALSE}
numb_cond1 = rmultinom(rep1, sample_size, probC1) %>% t()
numb_cond2 = rmultinom(rep2, sample_size, probC2) %>% t()
### DCATS
betabin_noBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = FALSE)
betabin_wBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = TRUE, similarity_mat = simil_mat)
betabin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = FALSE)
bin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = TRUE)
### fisher
fisher_pvals1 = getFisher(numb_cond1, numb_cond2)
pvalsDF = data.frame(truth = truthRes, noBC_pvals = betabin_noBC$pvals, wBC_pavls = betabin_wBC$pvals, betabin_pvals = betabin_wM$pvals, bin_pvals = bin_wM$pvals, fisher_pvals = fisher_pvals1)
pvalsDF %>% 
  mutate(noBC_res = ifelse(noBC_pvals < 0.05, "P","N"),
         wBC_res = ifelse(wBC_pavls < 0.05, "P", "N"),
         betabin_res = ifelse(betabin_pvals < 0.05, "P", "N"),
         bin_res = ifelse(bin_pvals < 0.05, "P", "N"),
         fisher_res = ifelse(fisher_pvals < 0.05, "P", "N"),) %>% 
  dplyr::select(truth, contains("_res")) %>% print()
```

### try situation with more positive cases

```{r}
rep1 = 2
rep2 = 3
cluster_num = 7
probC1 = c(rep(0.1, 4), 0.3, 0.15, 0.15)  # True proportions
probC2 = c(rep(0.15, 4), 0.1, 0.15, 0.15)
truthRes = c(rep("P", 5), "N", "N")
```

```{r}
simil_mat = get_similarity_mat(cluster_num, confuse_rate=0.1)
misV = simil_mat[,1]*0.2
simil_mat[,1] = simil_mat[,1]*0.8
simil_mat[,3] = simil_mat[,3] + misV
print(simil_mat)
```

```{r, warning=FALSE}
numb_cond1 = rmultinom(rep1, sample_size, probC1) %>% t()
numb_cond2 = rmultinom(rep2, sample_size, probC2) %>% t()
### DCATS
betabin_noBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = FALSE)
betabin_wBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = TRUE, similarity_mat = simil_mat)
betabin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = FALSE)
bin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = TRUE)
### fisher
fisher_pvals1 = getFisher(numb_cond1, numb_cond2)
pvalsDF = data.frame(truth = truthRes, noBC_pvals = betabin_noBC$pvals, wBC_pavls = betabin_wBC$pvals, betabin_pvals = betabin_wM$pvals, bin_pvals = bin_wM$pvals, fisher_pvals = fisher_pvals1)
pvalsDF %>% 
  mutate(noBC_res = ifelse(noBC_pvals < 0.05, "P","N"),
         wBC_res = ifelse(wBC_pavls < 0.05, "P", "N"),
         betabin_res = ifelse(betabin_pvals < 0.05, "P", "N"),
         bin_res = ifelse(bin_pvals < 0.05, "P", "N"),
         fisher_res = ifelse(fisher_pvals < 0.05, "P", "N"),) %>% 
  dplyr::select(truth, contains("_res")) %>% print()
```

A un-uniform matrix will make DCATS less sensitive

## change sample size

```{r}
rep1 = 2
rep2 = 3
cluster_num = 9
probC1 = c(rep(0.1, 8), 0.2)  # True proportions
probC2 = c(rep(0.1, 7), 0.15, 0.15)
truthRes = c(rep("N", 7), "P", "P")
```

```{r}
simil_mat = get_similarity_mat(cluster_num, confuse_rate=0.1)
print(simil_mat)
```

```{r, warning=FALSE}
numb_cond1 = sapply(runif(rep1, 700, 2000), function(x){rmultinom(1, x, probC1)}) %>% t()
numb_cond2 = sapply(runif(rep2, 700, 2000), function(x){rmultinom(1, x, probC2)}) %>% t()
### DCATS
betabin_noBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = FALSE)
betabin_wBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = TRUE, similarity_mat = simil_mat)
betabin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = FALSE)
bin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = TRUE)
### fisher
fisher_pvals1 = getFisher(numb_cond1, numb_cond2)
pvalsDF = data.frame(truth = truthRes, noBC_pvals = betabin_noBC$pvals, wBC_pavls = betabin_wBC$pvals, betabin_pvals = betabin_wM$pvals, bin_pvals = bin_wM$pvals, fisher_pvals = fisher_pvals1)
pvalsDF %>% 
  mutate(noBC_res = ifelse(noBC_pvals < 0.05, "P","N"),
         wBC_res = ifelse(wBC_pavls < 0.05, "P", "N"),
         betabin_res = ifelse(betabin_pvals < 0.05, "P", "N"),
         bin_res = ifelse(bin_pvals < 0.05, "P", "N"),
         fisher_res = ifelse(fisher_pvals < 0.05, "P", "N"),) %>% 
  dplyr::select(truth, contains("_res")) %>% print()
```

### try situation with more positive cases

```{r}
rep1 = 2
rep2 = 3
cluster_num = 7
probC1 = c(rep(0.1, 4), 0.3, 0.15, 0.15)  # True proportions
probC2 = c(rep(0.15, 4), 0.1, 0.15, 0.15)
truthRes = c(rep("P", 5), "N", "N")
```

```{r}
simil_mat = get_similarity_mat(cluster_num, confuse_rate=0.1)
print(simil_mat)
```

```{r, warning=FALSE}
numb_cond1 = sapply(runif(rep1, 700, 2000), function(x){rmultinom(1, x, probC1)}) %>% t()
numb_cond2 = sapply(runif(rep2, 700, 2000), function(x){rmultinom(1, x, probC2)}) %>% t()
### DCATS
betabin_noBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = FALSE)
betabin_wBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = TRUE, similarity_mat = simil_mat)
betabin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = FALSE)
bin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = TRUE)
### fisher
fisher_pvals1 = getFisher(numb_cond1, numb_cond2)
pvalsDF = data.frame(truth = truthRes, noBC_pvals = betabin_noBC$pvals, wBC_pavls = betabin_wBC$pvals, betabin_pvals = betabin_wM$pvals, bin_pvals = bin_wM$pvals, fisher_pvals = fisher_pvals1)
pvalsDF %>% 
  mutate(noBC_res = ifelse(noBC_pvals < 0.05, "P","N"),
         wBC_res = ifelse(wBC_pavls < 0.05, "P", "N"),
         betabin_res = ifelse(betabin_pvals < 0.05, "P", "N"),
         bin_res = ifelse(bin_pvals < 0.05, "P", "N"),
         fisher_res = ifelse(fisher_pvals < 0.05, "P", "N"),) %>% 
  dplyr::select(truth, contains("_res")) %>% print()
```

Using different sample size for each replicates have few chance to cause false positive in fisher.

## try to simulate multiple time and calculate sensitivity and specificity

```{r}
rep1 = 2
rep2 = 3
cluster_num = 9
probC1 = c(rep(0.1, 8), 0.2)  # True proportions
probC2 = c(rep(0.1, 7), 0.15, 0.15)
truthRes = c(rep("N", 7), "P", "P")
```

```{r, warning=FALSE}
simulation_size = 20
simulation_time = 5
set.seed(123)
simulationDF_list = vector(mode = "list", length = simulation_time)
simil_mat = get_similarity_mat(cluster_num, confuse_rate=0.1)
for (j in 1:simulation_time) {
  simulationDF = data.frame()
  for (i in 1:simulation_size){
    ### calculate 
    numb_cond1 = sapply(runif(rep1, 700, 2000), function(x){rmultinom(1, x, probC1)}) %>% t()
    numb_cond2 = sapply(runif(rep2, 700, 2000), function(x){rmultinom(1, x, probC2)}) %>% t()
    ### DCATS
    betabin_noBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = FALSE)
    betabin_wBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = TRUE, similarity_mat = simil_mat)
    betabin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = FALSE)
    bin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = TRUE)
    ### fisher
    fisher_pvals1 = getFisher(numb_cond1, numb_cond2)
    all_res = data.frame(cluster = c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P")[1:cluster_num], truth = truthRes, noBC_pvals = betabin_noBC$pvals, wBC_pavls = betabin_wBC$pvals, betabin_pvals = betabin_wM$pvals, bin_pvals = bin_wM$pvals, fisher_pvals = fisher_pvals1)
    simulationDF = rbind(simulationDF, all_res)
    }
  simulationDF_list[[j]] = simulationDF
}
## send email after finishing
sendEmail("Simulation is done!!")
```

```{r}
evaluationDF = data.frame()
len = length(simulationDF_list)
for (j in 1:len){
  simulationDF = simulationDF_list[[j]] %>% na.omit()
  methods = colnames(simulationDF)[3:dim(simulationDF)[2]] %>% str_remove("_pvals")
  numb_mthd = length(methods)
  mcc = rep(NA, numb_mthd)
  auc = rep(NA, numb_mthd)
  sensitivity = rep(NA, numb_mthd)
  FNR = rep(NA, numb_mthd)
  FPR = rep(NA, numb_mthd)
  specificity = rep(NA, numb_mthd)
  truth = simulationDF$truth
  for (i in 3:dim(simulationDF)[2]){
    auc[i-2] = getROC(simulationDF$truth, simulationDF[,i])$auc
    pred = simulationDF[, i]
    pred_res = ifelse(pred < 0.05, "P", "N")
    TP <- sum(pred_res=="P"&truth=="P")
    TN <- sum(pred_res=="N"&truth=="N")
    FP <- sum(pred_res=="P"&truth=="N")
    FN <- sum(pred_res=="N"&truth=="P")
    truthN = TN + FP
    truthP = FN + TP
    predP = TP + FP
    predN = FN + TN
    mcc[i-2] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
    sensitivity[i-2] = TP/truthP
    specificity[i-2] = TN/truthN
    FNR[i-2] = FN/truthP
    FPR[i-2] = FP/truthN
    
    res = data.frame(trial = as.character(j), methods = methods, mcc = mcc, auc = auc, sensitivity = sensitivity, specificity = specificity, FNR = FNR, FPR = FPR)
    }
    evaluationDF = rbind(evaluationDF, res)
}
```

```{r}
evaluationDF %>% 
  select(-mcc, -FNR, -FPR) %>% 
  pivot_longer(auc:specificity, names_to = "statistics", values_to = "value") %>% 
  ggplot(aes(x = statistics, y = value, color = methods)) +
  geom_boxplot()
  
```

## add dirichlet

```{r}
rep1 = 2
rep2 = 3
cluster_num = 5
concentration = 90
probC1 = c(0.2, 0.2, 0.1, 0.3, 0.2)
probC2 = c(0.2, 0.2, 0.1, 0.15, 0.35)
truthRes = c("N", "N", "N", "P", "P")
```

```{r, warning=FALSE}
set.seed(123)
simulation_size = 20
simulation_time = 5
simulationDF_list = vector(mode = "list", length = simulation_time)
simil_mat = get_similarity_mat(cluster_num, confuse_rate=0.1)
for (j in 1:simulation_time) {
  simulationDF = data.frame()
  for (i in 1:simulation_size){
    ## get numbers for each cell type
    numb_cond1 = matrix(nrow = rep1, ncol = cluster_num)
    numb_cond2 = matrix(nrow = rep2, ncol = cluster_num)
    for (rep in 1:rep1) {
      prop_cond1 <- MCMCpack::rdirichlet(1, probC1 * concentration)
      numb_cond1[rep, ] <- rmultinom(1, runif(1, 700, 2000), prop_cond1)}
    for (rep in 1:rep2) {
      prop_cond2 <- MCMCpack::rdirichlet(1, probC2 * concentration)
      numb_cond2[rep, ] <- rmultinom(1, runif(1, 700, 2000), prop_cond2)}
    ### DCATS
    betabin_noBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = FALSE)
    betabin_wBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = TRUE, similarity_mat = simil_mat)
    betabin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = FALSE)
    bin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = TRUE)
    ### fisher
    fisher_pvals1 = getFisher(numb_cond1, numb_cond2)
    all_res = data.frame(cluster = c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P")[1:cluster_num], truth = truthRes, noBC_pvals = betabin_noBC$pvals, wBC_pvals = betabin_wBC$pvals, betabin_pvals = betabin_wM$pvals, bin_pvals = bin_wM$pvals, fisher_pvals = fisher_pvals1)
    simulationDF = rbind(simulationDF, all_res)
    }
  simulationDF_list[[j]] = simulationDF
}
## send email after finishing
sendEmail("Simulation is done!!")
```

```{r}
evaluationDF = data.frame()
len = length(simulationDF_list)
for (j in 1:len){
  simulationDF = simulationDF_list[[j]] %>% na.omit()
  methods = colnames(simulationDF)[3:dim(simulationDF)[2]] %>% str_remove("_pvals")
  numb_mthd = length(methods)
  mcc = rep(NA, numb_mthd)
  auc = rep(NA, numb_mthd)
  sensitivity = rep(NA, numb_mthd)
  FNR = rep(NA, numb_mthd)
  FPR = rep(NA, numb_mthd)
  specificity = rep(NA, numb_mthd)
  truth = simulationDF$truth
  for (i in 3:dim(simulationDF)[2]){
    auc[i-2] = getROC(simulationDF$truth, simulationDF[,i])$auc
    pred = simulationDF[, i]
    pred_res = ifelse(pred < 0.05, "P", "N")
    TP <- sum(pred_res=="P"&truth=="P")
    TN <- sum(pred_res=="N"&truth=="N")
    FP <- sum(pred_res=="P"&truth=="N")
    FN <- sum(pred_res=="N"&truth=="P")
    truthN = TN + FP
    truthP = FN + TP
    predP = TP + FP
    predN = FN + TN
    mcc[i-2] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
    sensitivity[i-2] = TP/truthP
    specificity[i-2] = TN/truthN
    FNR[i-2] = FN/truthP
    FPR[i-2] = FP/truthN
    
    res = data.frame(trial = as.character(j), methods = methods, mcc = mcc, auc = auc, sensitivity = sensitivity, specificity = specificity, FNR = FNR, FPR = FPR)
    }
    evaluationDF = rbind(evaluationDF, res)
}
```

```{r}
evaluationDF %>% 
  dplyr::select(-FNR, -FPR) %>% 
  pivot_longer(mcc:specificity, names_to = "statistics", values_to = "value") %>% 
  ggplot(aes(x = statistics, y = value, color = methods)) +
  geom_boxplot()
```

```{r}
simulationDF = data.frame()
for (i in 1:length(simulationDF_list)){
  simulationDF = rbind(simulationDF, simulationDF_list[[i]])
}
resDF = simulationDF %>% 
  mutate(betabin_res = ifelse(betabin_pvals < 0.05, "P", "N"),
         bin_res = ifelse(bin_pvals < 0.05, "P", "N"),
         fisher_res = ifelse(fisher_pvals < 0.05, "P", "N"),
         noBC_res = ifelse(noBC_pvals < 0.05, "P", "N"),
         wBC_res = ifelse(wBC_pvals < 0.05, "P", "N")) %>% 
  dplyr::select(cluster, truth, contains("_res"))
```

```{r}
resDF %>% 
  na.omit() %>% 
  mutate(betabin_match = ifelse(truth == betabin_res, 1, 0),
         bin_match = ifelse(truth == bin_res, 1, 0),
         fisher_match = ifelse(truth == fisher_res, 1, 0),
         noBC_match = ifelse(truth == noBC_res, 1, 0),
         wBC_match = ifelse(truth == wBC_res, 1, 0)) %>% 
  group_by(cluster) %>% 
  summarise(betabin_mr = sum(betabin_match)/(simulation_size*simulation_time),
            bin_mr = sum(bin_match)/(simulation_size*simulation_time),
            fisher_mr = sum(fisher_match)/(simulation_size*simulation_time),
            noBC_mr = sum(noBC_match)/(simulation_size*simulation_time),
            wBC_mr = sum(wBC_match)/(simulation_size*simulation_time))
```

DCATS do not have significant benefit with the adding of dirichlet. DCATS needs a relatively large gap to give positive result. 

## test in a three cluster scenario

```{r}
rep1 = 2
rep2 = 3
cluster_num = 3
concentration = 90
probC1 = c(1/3, 1/3, 1/3)  # True proportions
probC2 = c(1/3, 1/2, 1/6)
truthRes = c("N", "P", "P")
```

```{r, warning=FALSE}
simulation_size = 20
simulation_time = 20
set.seed(123)
simulationDF_list = vector(mode = "list", length = simulation_time)
simil_mat = get_similarity_mat(cluster_num, confuse_rate=0.1)
for (j in 1:simulation_time) {
  simulationDF = data.frame()
  for (i in 1:simulation_size){
    ## get numbers for each cell type
    numb_cond1 = matrix(nrow = rep1, ncol = cluster_num)
    numb_cond2 = matrix(nrow = rep2, ncol = cluster_num)
    for (rep in 1:rep1) {
      prop_cond1 <- MCMCpack::rdirichlet(1, probC1 * concentration)
      numb_cond1[rep, ] <- rmultinom(1, runif(1, 700, 2000), prop_cond1)}
    for (rep in 1:rep2) {
      prop_cond2 <- MCMCpack::rdirichlet(1, probC2 * concentration)
      numb_cond2[rep, ] <- rmultinom(1, runif(1, 700, 2000), prop_cond2)}
    ### DCATS
    betabin_noBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = FALSE)
    betabin_wBC = betabinLRT_rw(numb_cond1, numb_cond2, bias_corr = TRUE, similarity_mat = simil_mat)
    betabin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = FALSE)
    bin_wM = dcats_betabinRW(numb_cond1, numb_cond2, similarity_mat = simil_mat, n_samples = 50, binom_only = TRUE)
    ### fisher
    fisher_pvals1 = getFisher(numb_cond1, numb_cond2)
    all_res = data.frame(cluster = c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P")[1:cluster_num], truth = truthRes, noBC_pvals = betabin_noBC$pvals, wBC_pvals = betabin_wBC$pvals, betabin_pvals = betabin_wM$pvals, bin_pvals = bin_wM$pvals, fisher_pvals = fisher_pvals1)
    simulationDF = rbind(simulationDF, all_res)
    }
  simulationDF_list[[j]] = simulationDF
}
## send email after finishing
sendEmail("Simulation is done!!")
```

```{r}
evaluationDF = data.frame()
len = length(simulationDF_list)
for (j in 1:len){
  simulationDF = simulationDF_list[[j]] %>% na.omit()
  methods = colnames(simulationDF)[3:dim(simulationDF)[2]] %>% str_remove("_pvals")
  numb_mthd = length(methods)
  mcc = rep(NA, numb_mthd)
  auc = rep(NA, numb_mthd)
  sensitivity = rep(NA, numb_mthd)
  FNR = rep(NA, numb_mthd)
  FPR = rep(NA, numb_mthd)
  specificity = rep(NA, numb_mthd)
  truth = simulationDF$truth
  for (i in 3:dim(simulationDF)[2]){
    auc[i-2] = getROC(simulationDF$truth, simulationDF[,i])$auc
    pred = simulationDF[, i]
    pred_res = ifelse(pred < 0.05, "P", "N")
    TP <- sum(pred_res=="P"&truth=="P")
    TN <- sum(pred_res=="N"&truth=="N")
    FP <- sum(pred_res=="P"&truth=="N")
    FN <- sum(pred_res=="N"&truth=="P")
    truthN = TN + FP
    truthP = FN + TP
    predP = TP + FP
    predN = FN + TN
    mcc[i-2] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
    sensitivity[i-2] = TP/truthP
    specificity[i-2] = TN/truthN
    FNR[i-2] = FN/truthP
    FPR[i-2] = FP/truthN
  }
    res = data.frame(trial = as.character(j), methods = methods, mcc = mcc, auc = auc, sensitivity = sensitivity, specificity = specificity, FNR = FNR, FPR = FPR)
    evaluationDF = rbind(evaluationDF, res)
}
```

```{r}
evaluationDF %>% 
  dplyr::select(-FNR, -FPR) %>% 
  pivot_longer(mcc:specificity, names_to = "statistics", values_to = "value") %>% 
  ggplot(aes(x = statistics, y = value, color = methods)) +
  geom_boxplot()
```

When the cluster number is smaller(3 vs 9), DCATS seems to perform better. Test what kind of situation, fisher will fail.

```{r}
simulationDF_list[[1]] = simulationDF
resDF = simulationDF %>% 
  mutate(betabin_res = ifelse(betabin_pvals < 0.05, "P", "N"),
         bin_res = ifelse(bin_pvals < 0.05, "P", "N"),
         fisher_res = ifelse(fisher_pvals < 0.05, "P", "N"),
         noBC_res = ifelse(noBC_pvals < 0.05, "P", "N"),
         wBC_res = ifelse(wBC_pvals < 0.05, "P", "N")) %>% 
  dplyr::select(cluster, truth, contains("_res"))
```

Matching rate

```{r}
resDF %>% 
  mutate(betabin_match = ifelse(truth == betabin_res, 1, 0),
         bin_match = ifelse(truth == bin_res, 1, 0),
         fisher_match = ifelse(truth == fisher_res, 1, 0),
         noBC_match = ifelse(truth == noBC_res, 1, 0),
         wBC_match = ifelse(truth == wBC_res, 1, 0)) %>% 
  group_by(cluster) %>% 
  summarise(betabin_mr = sum(betabin_match)/simulation_size,
            bin_mr = sum(bin_match)/simulation_size,
            fisher_mr = sum(fisher_match)/simulation_size,
            noBC_mr = sum(noBC_match)/simulation_size,
            wBC_mr = sum(wBC_match)/simulation_size)
```

## Add simple gene expression information

```{r, message=FALSE, warning=FALSE}
library(Seurat)
library(SeuratWrappers)
library(speckle)
library(DCATS)
library(ggplot2)
library(tidyverse)
library(diffcyt)
library(MCMCpack)
library(scdney)
```

```{r}
set.seed(123)
gene_num = 100
cell_num = 1000
sim_matA = matrix(nrow = gene_num, ncol = cell_num)
for (i in 1:gene_num) {
  sim_matA[i,] = rnorm(cell_num, mean = i*2, sd = 4) %>% abs()
}

sim_matB = sim_matA
for (i in 1:20) {
  sim_matB[i,] = sim_matA[i,] + rnorm(cell_num, 4, 2)
}

sim_matC = sim_matA
for (i in 20:40) {
  sim_matC[i,] = sim_matA[i,] + rnorm(cell_num, 6, 2)
}

sim_matD = sim_matA
for (i in 20:40) {
  sim_matC[i,] = sim_matA[i,] + rnorm(cell_num, 6, 2)
}

sim_matE = sim_matA
for (i in 20:40) {
  sim_matC[i,] = sim_matA[i,] + rnorm(cell_num, 6, 2)
}

sim_matF = sim_matA
for (i in 20:40) {
  sim_matC[i,] = sim_matA[i,] + rnorm(cell_num, 6, 2)
}

sim_mat = cbind(sim_matA, sim_matB, sim_matC)
colnames(sim_mat) = str_c("cell", as.character(1:(cell_num*3)))
rownames(sim_mat) = str_c("gene", as.character(1:gene_num))
origLabels = c(rep("clusterA", cell_num), rep("clusterB", cell_num), rep("clusterC", cell_num)) %>% as.factor()
```

```{r}
seuratObj <- CreateSeuratObject(counts = sim_mat)
Idents(seuratObj) = origLabels
seuratObj <- NormalizeData(seuratObj, verbose = FALSE)
seuratObj <- FindVariableFeatures(seuratObj, selection.method = "vst", nfeatures = 2000, verbose = FALSE)
seuratObj <- ScaleData(seuratObj)
seuratObj <- RunPCA(seuratObj, features = VariableFeatures(object = seuratObj))
seuratObj <- FindNeighbors(seuratObj, dims = 1:20, verbose = FALSE)
seuratObj <- FindClusters(seuratObj, resolution = 0.4, verbose = FALSE)
seuratObj <- RunUMAP(seuratObj, dims = 1:20, verbose = FALSE)
seuratObj[['orig.ident']] = origLabels
DimPlot(seuratObj, reduction = "umap", group.by = "orig.ident")
```

If change the order of cluster to sample, the total proportion might not follow the dirichlet distribution as we thought!!!!!!!!!!!!!!!!!!!!!!!!!!!

```{r}
cluster_num = 8  # numbers of clusters
concentration = 100 # indicate how simulated proportion far away from true, the larger the closer
setresolu = 0.8
rep1 = 5
rep2 = 4
simulation_times = 50
sample_size1 = 1000
sample_size2 = 1500
cell_pool = "splatter"  # cell pool used, can be selected from ("SPAR", "splatter", "realWorld")
more_negative = ""
```

```{r}
## cluster num == 8
probC1 = c(rep(0.1, 6), 0.2, 0.2)  # True proportions
probC2 = c(rep(0.1, 3), 0.05, 0.15, 0.2, 0.2, 0.1)
truthRes = c(rep("N", 3), rep("P", 3), "N", "P")
```

```{r}
## cluster num == 10
probC1 = c(rep(0.1, 5), 0.05, 0.05, 0.05, 0.1, 0.15)  # True proportions
probC2 = c(rep(0.1, 10))
truthRes = c(rep("N", 5), rep("P", 5))
```

```{r}
## cluster num == 12
probC1 = c(rep(0.1, 4), 0.05, 0.05, 0.05, 0.15, 0.05, 0.05, 0.1, 0.1)  # True proportions
probC2 = c(rep(0.1, 8), rep(0.05, 4))
truthRes = c(rep("N", 4), rep("P", 4), "N", "N", "P", "P")
```

```{r}
## cluster num == 14
probC1 = c(rep(0.1, 2), rep(0.05, 8), rep(0.1, 4))  # True proportions
probC2 = c(rep(0.1, 6), rep(0.05, 8))
truthRes = c(rep("N", 2), rep("P", 4), rep("N", 4), rep("P", 4))
```

```{r, message=FALSE, warning=FALSE}
source("functionsV2.r")
source("glm.R")     # for scDC
options(future.globals.maxSize = 15000 * 1024^2)
```

```{r}
if (more_negative == ""){
  if (cluster_num == 3){
  probC1 = c(1/3, 1/3, 1/3)  # True proportions
  probC2 = c(1/3, 1/2, 1/6)
  truthRes = c("N", "P", "P")
  } else if (cluster_num == 5){
    #probC1 = c(0.2, 0.2, 0.1, 0.3, 0.2)
    #probC2 = c(0.2, 0.2, 0.1, 0.15, 0.35)
    #truthRes = c("N", "N", "N", "P", "P")
    probC1 = c(0.2, 0.2, 0.2, 0.3, 0.1)
    probC2 = c(0.2, 0.2, 0.35, 0.15, 0.1)
    truthRes = c("N", "N", "P", "P", "N")
    } else if (cluster_num == 7){
    probC1 = c(rep(0.1, 4), rep(0.2, 3))
    probC2 = c(0.1, 0.1, 0.2, 0.05, 0.2, 0.3, 0.05)
    truthRes = c("N", "N", "P", "P", "N", "P", "P")
    } else if (cluster_num == 12) {
      probC1 = c(rep(0.1, 4), rep(0.2, 2), rep(0.05, 2), rep(0.025, 4))
      probC2 = c(0.1, 0.1, 0.15, 0.05, 0.2, 0.1, 0.05, 0.1, 0.025, 0.025, 0.05, 0.05)
      truthRes = c("N", "N", "P", "P", "N", "P", "N", "P", "N", "N", "P", "P")
    }
  }
```

```{r}
if (more_negative == "_pN"){
  if (cluster_num == 3){
    probC1 = c(1/3, 1/3, 1/3)  # True proportions
    probC2 = c(1/3, 1/2, 1/6)
    truthRes = c("N", "P", "P")
    } else if (cluster_num == 7){
      probC1 = c(rep(0.1, 4), rep(0.2, 3))
      probC2 = c(0.1, 0.1, 0.1, 0.15, 0.2, 0.3, 0.05)
      truthRes = c("N", "N", "N", "P", "N", "P", "P")
      } else if (cluster_num == 12) {
        probC1 = c(rep(0.1, 4), rep(0.2, 2), rep(0.05, 2), rep(0.025, 4))
        probC2 = c(0.1, 0.1, 0.1, 0.1, 0.2, 0.15, 0.05, 0.075, 0.05, 0.025, 0.025, 0.025)
        truthRes = c("N", "N", "N", "N", "N", "P", "N", "P", "P", "N", "N", "N")
      }
  }
```

```{r}
if (cell_pool == "splatter"){
  load(str_c("./data/cells_pool", as.character(cluster_num), "_splatter.RData"))
} else if (cell_pool == "SPAR") {
    load(str_c("./data/cells_pool", as.character(cluster_num), "_SPARSim.RData"))
  
} else if (cell_pool == "realWorld") {
    load(str_c("./data/cells_pool", as.character(cluster_num), "_realWorld.RData"))
}
```

```{r, message=FALSE, warning=FALSE, echo=FALSE}
## output data
simulationDF = data.frame()  # data frame to store test result
time = matrix(NA, nrow = simulation_times, ncol = 8) # matrix contains time for each test need in each simulation and time need to calculate svm/rf matrix
true_countL = vector(mode = "list", length = simulation_times) # list contains the count table of each true cluster
seurat_countL = vector(mode = "list", length = simulation_times) # list contains the count table of each cluster defined by seurat
knn_matrixL = vector(mode = "list", length = simulation_times) # list contains the knn matrix getting from each simulation
true_matrixL = vector(mode = "list", length = simulation_times) # list contains the true similarity matrix getting from each simulation
rf_matrixL = vector(mode = "list", length = simulation_times) # list contains the knn matrix getting from each simulation
svm_matrixL = vector(mode = "list", length = simulation_times) # list contains the true similarity matrix getting from each simulation

set.seed(123)
for (sim in 1:simulation_times){
  print(sim)
  timeL = rep(NA, 8) # DCATS w/wto similarity matrix, fisher, speckle, diffcyt, scDC
  ## simulation
  simulation = simulator_fastMNN(totals1 = runif(rep1, sample_size1, sample_size2), totals2 = runif(rep2, sample_size1, sample_size2), probC1, probC2, setresolu, sim_mat)
  if (is.na(simulation)[1] == FALSE){
    true_countL[[sim]] = c(cond1 = simulation$numb_cond1, cond2 = simulation$numb_cond2)
    
    ## data convert
    numb_cond1 = simulation$dfRes %>% 
      filter(condition == "Cond1") %>%
      group_by(clusterRes, batch) %>% 
      summarise(n = n()) %>% 
      pivot_wider(names_from = "clusterRes", values_from = "n") %>% 
      column_to_rownames(var = "batch")
    numb_cond2 = simulation$dfRes %>% 
      filter(condition == "Cond2") %>%
      group_by(clusterRes, batch) %>% 
      summarise(n = n()) %>% 
      pivot_wider(names_from = "clusterRes", values_from = "n") %>% 
      column_to_rownames(var = "batch")
    numb_cond1[is.na(numb_cond1)] <- 0
    numb_cond2[is.na(numb_cond2)] <- 0
    conf.mat <- table(simulation$trueLabels, Idents(simulation$integratedSamples))
    true.conf <- conf.mat/rowSums(conf.mat)
    library(clue)
    order2 = as.vector(solve_LSAP(true.conf, maximum = TRUE))
    L_sum1 = colSums(numb_cond1)
    L_sum2 = colSums(numb_cond2)
    decider = sum(L_sum1 > 10)+sum(L_sum2 > 10)
    if (decider == cluster_num*2) {   # if one cluster has least than 10 cells in one condition, then won't continue
      seurat_countL[[sim]] = list(cond1 = numb_cond1[,order2], cond2 = numb_cond2[,order2])
      
      ## Get matrices
      ### KNN matrix
      graphs = simulation$integratedSamples@graphs$RNA_snn
      labels = Idents(simulation$integratedSamples)
      knn_mat = KNN_transition(graphs, labels)
      order1 = colnames(numb_cond1)
      simil_matK = knn_mat[order1, order1]
      knn_matrixL[[sim]] = simil_matK
      ### True matrix
      simil_matT = true.conf[,order2]
      true_matrixL[[sim]] = simil_matT
      ### Uniform matrix
      simil_matU = get_similarity_mat(cluster_num, confuse_rate=0.1)
      ### svm&rf
      mlDF = simulation$integratedSamples@reductions$pca@cell.embeddings %>% 
        as.data.frame() %>% 
        tibble::rownames_to_column("cellID") %>% 
        merge(simulation$dfRes, by = "cellID") %>% 
        dplyr::select(-cellID)
      set.seed(123)
      t7start = Sys.time()
      simil_matRF = get_similarity_matRW(method = "rf", df = mlDF)
      timeL[7] = Sys.time() - t7start
      t8start = Sys.time()
      simil_matSVM = get_similarity_matRW(method = "svm", df = mlDF)
      timeL[8] = Sys.time() - t8start
      rf_matrixL[[sim]] = simil_matRF
      svm_matrixL[[sim]] = simil_matSVM
      
      ## Test
      ### DCATS---betabinLRT
      t1start = Sys.time()
      betabin_noBC = betabinLRT_rw(as.matrix(numb_cond1), as.matrix(numb_cond2), bias_corr = FALSE)
      timeL[1] = Sys.time() - t1start
      ###  DCATS---betabinLRT with Bias correction from similarity matrix
      betabin_wBC_K = betabinLRT_rw(as.matrix(numb_cond1), as.matrix(numb_cond2), bias_corr = TRUE, similarity_mat = simil_matK)
      betabin_wBC_U = betabinLRT_rw(as.matrix(numb_cond1), as.matrix(numb_cond2), bias_corr = TRUE, similarity_mat = simil_matU)
      betabin_wBC_T = betabinLRT_rw(as.matrix(numb_cond1), as.matrix(numb_cond2), bias_corr = TRUE, similarity_mat = simil_matT)
      betabin_wBC_RF = betabinLRT_rw(as.matrix(numb_cond1), as.matrix(numb_cond2), bias_corr = TRUE, similarity_mat = simil_matRF)
      betabin_wBC_SVM = betabinLRT_rw(as.matrix(numb_cond1), as.matrix(numb_cond2), bias_corr = TRUE, similarity_mat = simil_matSVM)
      ## DCATS---betabin with similarity matrix (backward-forward)
      t2start = Sys.time()
      betabin_wMK = dcats_betabinRW(as.matrix(numb_cond1), as.matrix(numb_cond2), similarity_mat = simil_matK, n_samples = 50, binom_only = FALSE)
      timeL[2] = Sys.time() - t2start
      betabin_wMU = dcats_betabinRW(as.matrix(numb_cond1), as.matrix(numb_cond2), similarity_mat = simil_matU, n_samples = 50, binom_only = FALSE)
      betabin_wMT = dcats_betabinRW(as.matrix(numb_cond1), as.matrix(numb_cond2), similarity_mat = simil_matT, n_samples = 50, binom_only = FALSE)
      betabin_wMRF = dcats_betabinRW(as.matrix(numb_cond1), as.matrix(numb_cond2), similarity_mat = simil_matRF, n_samples = 50, binom_only = FALSE)
      betabin_wMSVM = dcats_betabinRW(as.matrix(numb_cond1), as.matrix(numb_cond2), similarity_mat = simil_matSVM, n_samples = 50, binom_only = FALSE)
      bin_wMK = dcats_betabinRW(as.matrix(numb_cond1), as.matrix(numb_cond2), similarity_mat = simil_matK, n_samples = 50)
      bin_wMU = dcats_betabinRW(as.matrix(numb_cond1), as.matrix(numb_cond2), similarity_mat = simil_matU, n_samples = 50)
      bin_wMT = dcats_betabinRW(as.matrix(numb_cond1), as.matrix(numb_cond2), similarity_mat = simil_matT, n_samples = 50)
      bin_wMRF = dcats_betabinRW(as.matrix(numb_cond1), as.matrix(numb_cond2), similarity_mat = simil_matRF, n_samples = 50)
      bin_wMSVM = dcats_betabinRW(as.matrix(numb_cond1), as.matrix(numb_cond2), similarity_mat = simil_matSVM, n_samples = 50)
      ## Fisher's exact test
      t3start = Sys.time()
      fisher_pvals = getFisher(as.matrix(numb_cond1), as.matrix(numb_cond2))
      timeL[3] = Sys.time() - t3start
      ## speckle
      t4start = Sys.time()
      speckleRes = propeller(clusters = simulation$dfRes$clusterRes, sample = simulation$dfRes$batch, group = simulation$dfRes$condition) %>% 
        dplyr::rename(cluster = BaselineProp.clusters,
                      speckle_pvals = FDR) %>%
        dplyr::select(cluster, speckle_pvals)
      timeL[4] = Sys.time() - t4start
      ## diffcyt
      t5start = Sys.time()
      diffcytP = getDiffcyt(numb_cond1, numb_cond2, simulation$dfRes)
      timeL[5] = Sys.time() - t5start
      ## scDC
      t6start = Sys.time()
      res_scDC <- scDC_noClustering(cellTypes = simulation$dfRes$clusterRes, simulation$dfRes$batch, calCI = TRUE, calCI_method = c("percentile", "BCa", "multinom"),nboot = 1000, verbose = FALSE)
      res_GLM <- fitGLM(res_scDC, c(rep("cond1",rep1*cluster_num),rep("cond2",rep2*cluster_num)), pairwise = FALSE, fixed_only = TRUE, verbose = FALSE)
      timeL[6] = Sys.time() - t6start
      scDCRes_temp = summary(res_GLM$pool_res_fixed)
      scDCRes = scDCRes_temp[c(cluster_num+1,(dim(scDCRes_temp)[1]-cluster_num+2):dim(scDCRes_temp)[1]),]
      
      ## results
      cluster_map = data.frame(cluster = colnames(numb_cond1[,order2]), truth = truthRes) %>% 
        arrange(cluster)
      all_res = cluster_map %>% 
        mutate(betabin_noBC_pvals = betabin_noBC$pvals,
               betabin_wBCK_pvals = betabin_wBC_K$pvals,
               betabin_wBCU_pvals = betabin_wBC_U$pvals,
               betabin_wBCT_pvals = betabin_wBC_T$pvals,
               betabin_wBCRF_pvals = betabin_wBC_RF$pvals,
               betabin_wBCSVM_pvals = betabin_wBC_SVM$pvals,
               betabin_wMK_pvals = betabin_wMK$pvals,
               betabin_wMU_pvals = betabin_wMU$pvals,
               betabin_wMT_pvals = betabin_wMT$pvals,
               betabin_wMRF_pvals = betabin_wMRF$pvals,
               betabin_wMSVM_pvals = betabin_wMSVM$pvals,
               bin_wMK_pvals = bin_wMK$pvals,
               bin_wMU_pvals = bin_wMU$pvals,
               bin_wMT_pvals = bin_wMT$pvals,
               bin_wMRF_pvals = bin_wMRF$pvals,
               bin_wMSVM_pvals = bin_wMSVM$pvals,
               fisher_pvals = fisher_pvals,
               scDC_pvals = scDCRes$p.value) %>%
        merge(speckleRes, by = "cluster") %>% 
        merge(diffcytP, by = "cluster")
      simulationDF = rbind(simulationDF, all_res)
      time[sim,] = timeL
    }
  }
}

## send email after finishing
sendEmail('Simulation is done!!')
```

```{r}
file_name = str_c("./data/simulationRES/replicates", as.character(rep1), "&", as.character(rep2), "_K", as.character(cluster_num), "_con", as.character(concentration), "_", cell_pool, more_negative, sample_size1, "&", sample_size2, ".RData")
colnames(time) = c("DCATS_wtoM", "DCATS_wM", "fisher", "speckle", "diffcyt", "scDC", "rfM", "svmM")
save(simulationDF, time, true_countL, seurat_countL, knn_matrixL, true_matrixL, file = file_name)
head(simulationDF, 15)
```

Test for one simulation

```{r}
knn_matrixL[[1]] %>% print()
true_matrixL[[1]] %>% print()
rf_matrixL[[1]] %>% print()
svm_matrixL[[1]] %>% print()
simSeuratOj = simulation$integratedSamples
simSeuratOj[['orig.ident']] = simulation$trueLabels
DimPlot(simSeuratOj, reduction = "umap", group.by = "orig.ident") %>% print()
DimPlot(simSeuratOj, reduction = "umap") %>% print()
```

```{r}
load(file_name)
simulationDF = simulationDF %>% na.omit()
methods = colnames(simulationDF)[3:dim(simulationDF)[2]] %>% str_remove("_pvals")
numb_mthd = length(methods)
mcc = rep(NA, numb_mthd)
auc = rep(NA, numb_mthd)
auprc = rep(NA, numb_mthd)
sensitivity = rep(NA, numb_mthd)
specificity = rep(NA, numb_mthd)
truth = simulationDF$truth
for (i in 3:dim(simulationDF)[2]){
  auc[i-2] = getROC(simulationDF$truth, simulationDF[,i])$auc
  pred = simulationDF[, i]
  pred_res = ifelse(pred < 0.05, "P", "N")
  TP <- sum(pred_res=="P"&truth=="P")
  TN <- sum(pred_res=="N"&truth=="N")
  FP <- sum(pred_res=="P"&truth=="N")
  FN <- sum(pred_res=="N"&truth=="P")
  truthN = TN + FP
  truthP = FN + TP
  predP = TP + FP
  predN = FN + TN
  mcc[i-2] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
  auprc[i-2] = binaryROC(pred, truth)$AUPRC
  sensitivity[i-2] = TP/truthP
  specificity[i-2] = TN/truthN
}
res = data.frame(methods = methods, mcc = mcc, auc = auc, sensitivity = sensitivity, specificity = specificity) %>% 
  arrange(desc(mcc)) %>% 
  #filter(methods == "betabin_wMK" | methods == "diffcyt" | methods == "speckle" | methods == "fisher" | methods == "scDC")
print(res)
```

```{r}
simulationDF %>% 
  filter(cluster %in% c("A", "B", "C", "D", "E", "F")) %>% 
  pivot_longer(betabin_noBC_pvals:diffcyt_pvals, names_to = "methods", values_to = "pvals") %>% 
  mutate(methods = str_remove(methods, "_pvals")) %>% 
  ggplot(aes(x = methods, y = pvals)) + 
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45)) + 
  facet_grid(.~cluster)
```

```{r}
simulationDF %>% 
  filter(cluster %in% c("G", "H", "I", "J", "K", "L")) %>% 
  pivot_longer(betabin_noBC_pvals:diffcyt_pvals, names_to = "methods", values_to = "pvals") %>% 
  mutate(methods = str_remove(methods, "_pvals")) %>% 
  ggplot(aes(x = methods, y = pvals)) + 
  geom_boxplot() + 
  theme(axis.text.x = element_text(angle = 45)) + 
  facet_grid(.~cluster)
```

Check the time cost for each test and calculating rf/svm confusion matrices

```{r}
print("Time")
apply(na.omit(time), 2, mean)
```

