---
title: "Real word data"
author: "Xinyi Lin"
date: "10/27/2020"
output: html_document
---

Try different real world data

Read real world data and some basic information

* Simulation data: experiment 1, 2, 4

* real word data: experiment 3, 5, 6, 7

* no data of exp6

* Exp 3, 5, 7 only fisher works, don’t have batches-> speckle and diffcyt don’t work

* Exp5: BM1, BM2, BM3 have far more less cells than AML

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r,message=FALSE,warning=FALSE}
library(splatter)
library(Seurat)
library(speckle)
library(DCATS)
library(ggplot2)
library(tidyverse)
library(diffcyt)
```

```{r}
source("functions.r")
```

```{r}
theme_set(theme_classic()+
    theme(panel.border = element_blank(),
          legend.key = element_blank(),
          axis.ticks = element_blank(),
          panel.grid = element_blank(),
          panel.grid.minor = element_blank(), 
          panel.grid.major = element_blank(),
          panel.background = element_blank(),
          legend.background = element_blank(),
          plot.background = element_rect(fill = "transparent",colour = NA))+
      theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14)))
```

```{r}
# get the design + count matrix. replicates should be indicated with column names `donor` and cluster should be indicated with names `cluster_names`
getCount = function(metadata) {
  metadata %>% 
    group_by(condition, donor, cluster_names) %>% 
    summarise(n = n()) %>% 
    pivot_wider(names_from = cluster_names, values_from = n) %>% 
    replace(is.na(.), 0) %>% 
    column_to_rownames("donor")
}
```

Fisher's exact test

```{r}
get_fisherP = function(data = data){
  data_sum = data %>% 
    group_by(condition) %>% 
    summarise(n = n())
  
  data_count = data %>% 
    group_by(cluster, condition) %>% 
    summarise(n = n()) %>% 
    pivot_wider(names_from = "cluster", values_from = "n") %>% 
    mutate_all(~replace(., is.na(.), 0))

  fisher_pvals = rep(NA,ncol(data_count)-1)
  cluster_name = colnames(data_count)[-1]
  for (i in 2:ncol(data_count)) {
    cot_table = cbind(data_count[, i], data_sum$n-data_count[, i])
    fisher_pvals[i-1] = fisher.test(cot_table)$p.value
    }
  
  fisherP = data.frame(cluster = cluster_name, fisher_pvals = fisher_pvals)
  return(fisherP)
}
```

## Experiment 3

TIP is the one Hepheas used

```{r}
exp3_GFP <- read.delim("./data/real_world/Exp3_Farbehi_2019/GFP_tSNE_cluster_ID_table.txt") %>% 
  mutate(cluster = as.factor(cluster),
         experiment = as.factor(experiment))
exp3_TIP <- read.delim("./data/real_world/Exp3_Farbehi_2019/TIP_tSNE_cluster_ID_table.txt") %>% 
  mutate(cluster = as.factor(cluster),
         experiment = as.factor(experiment))
head(exp3_GFP)
head(exp3_TIP)
summary(exp3_GFP)
summary(exp3_TIP)
```

diffcyt and speckle cannot works without batch

```{r, eval=FALSE}
cell_numberL = exp3_TIP_37_sum$n
# Function to create random data (one sample)
d_random <- function(cell_number, mean = 0, sd = 1, ncol = 20, cofactor = 5) {
  d <- sinh(matrix(rnorm(cell_number*20, mean, sd), ncol = ncol)) * cofactor
  colnames(d) <- paste0("marker", sprintf("%02d", 1:ncol))
  return(d)
}
# Create random data (without differential signal)
set.seed(123)
d_input <- list(
  sample1 = d_random(cell_number = cell_numberL[1]), 
  sample2 = d_random(cell_number = cell_numberL[2])
)
experiment_info <- data.frame(
  sample_id = factor(exp3_TIP_37_sum$experiment), 
  stringsAsFactors = FALSE
)
marker_info <- data.frame(
  channel_name = paste0("channel", sprintf("%03d", 1:20)), 
  marker_name = paste0("marker", sprintf("%02d", 1:20)), 
  marker_class = factor(c(rep("type", 10), rep("state", 10)), 
                          levels = c("type", "state", "none")), 
  stringsAsFactors = FALSE
)
# Prepare data
d_se <- prepareData(d_input, experiment_info, marker_info)
# Transform data
d_se <- transformData(d_se)
# Generate clusters
d_se <- generateClusters(d_se)
# Replace with our simulated data info
d_se@elementMetadata$sample_id = exp3_TIP_37$experiment
d_se@elementMetadata$cluster_id = exp3_TIP_37$cluster
# Calculate counts
d_counts <- calcCounts(d_se)
# Create design matrix
design <- createDesignMatrix(experiment_info, cols_design = "sample_id")
# Create contrast matrix
contrast <- createContrast(c(0, 1))
# Test for differential abundance (DA) of clusters
res_DA <- testDA_edgeR(d_counts, design, contrast)
diffcytP = topTable(res_DA, format_vals = TRUE) %>% 
  as.data.frame() %>% 
  rownames_to_column("cluster") %>% 
  dplyr::rename(diffcyt_pvals = p_adj) %>% 
  select(cluster, diffcyt_pvals)
```

```{r}
## MI-Day3 vs MI-Day7
exp3_TIP_37 = exp3_TIP %>% 
  filter(experiment != "Sham") %>% 
  dplyr::rename(condition = experiment)
fisherP = get_fisherP(exp3_TIP_37)
print(fisherP)

## Sham vs MI-Day7
exp3_TIP_S3 = exp3_TIP %>% 
  filter(experiment != "MI-Day 7") %>% 
  dplyr::rename(condition = experiment)
fisherP = get_fisherP(exp3_TIP_S3)
print(fisherP)

## Sham vs MI-Day3
exp3_TIP_S7 = exp3_TIP %>% 
  filter(experiment != "MI-Day 3") %>% 
  dplyr::rename(condition = experiment)
fisherP = get_fisherP(exp3_TIP_S7)
print(fisherP)
```

## Experiment 5

```{r}
exp5_AML <- read.delim("./data/real_word/Exp5_Galen/GSM3587924_AML1012-D0.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "AML")
head(exp5_AML)
summary(exp5_AML)

exp5_BM1 <- read.delim("./data/real_word/Exp5_Galen/GSM3587996_BM1.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM1")
head(exp5_BM1)
summary(exp5_BM1)

exp5_BM2 <- read.delim("./data/real_word/Exp5_Galen/GSM3587997_BM2.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM2")
head(exp5_BM2)
summary(exp5_BM2)

exp5_BM3 <- read.delim("./data/real_word/Exp5_Galen/GSM3587999_BM3.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM3")
head(exp5_BM3)
summary(exp5_BM3)

exp5_BM4 <- read.delim("./data/real_word/Exp5_Galen/GSM3588001_BM4.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM4")
head(exp5_BM4)
summary(exp5_BM4)
```

BM1, BM2, BM3 have far more less cells than AML

```{r}
## AML vs BM1
exp5_A1 = rbind(exp5_AML, exp5_BM1)
fisherP = get_fisherP(exp5_A1)
print(fisherP)

## AML vs BM2
exp5_A2 = rbind(exp5_AML, exp5_BM2)
fisherP = get_fisherP(exp5_A2)
print(fisherP)

## AML vs BM3
exp5_A3 = rbind(exp5_AML, exp5_BM3)
fisherP = get_fisherP(exp5_A3)
print(fisherP)

## AML vs BM4
exp5_A4 = rbind(exp5_AML, exp5_BM4)
fisherP = get_fisherP(exp5_A4)
print(fisherP)
```

## Experiment 6

```{r}
matrix1 = readMM(gzfile("./data/real_word/Exp6_Kang/GSM2560248_2.1.mtx.gz")) %>% 
  as.matrix()
matrix2 = readMM(gzfile("./data/real_word/Exp6_Kang/GSM2560249_2.2.mtx.gz")) %>% 
  as.matrix()
```

```{r}
data_dir1 = "./data/real_world/Exp6_Kang/GSM2560248"
list.files(data_dir1) # Should show barcodes.tsv, genes.tsv, and matrix.mtx
expression_matrix1 <- Read10X(data.dir = data_dir1)
seuratObj1 = CreateSeuratObject(counts = expression_matrix1)
seuratObj1 = AddMetaData(object = seuratObj1, metadata = rep("ctrl1", dim(seuratObj1)[2]), col.name = 'sample')

data_dir2 = "./data/real_world/Exp6_Kang/GSM2560249"
list.files(data_dir2) # Should show barcodes.tsv, genes.tsv, and matrix.mtx
expression_matrix2 <- Read10X(data.dir = data_dir2)
seuratObj2 = CreateSeuratObject(counts = expression_matrix2)
seuratObj2 = AddMetaData(object = seuratObj2, metadata = rep("ctrl2", dim(seuratObj2)[2]), col.name = 'sample')
```

```{r}
cluster_info = read.delim("./data/real_world/Exp6_Kang/GSE96583_batch2.total.tsne.df.tsv") 
cluster_info %>% group_by(stim, cell) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cell, values_from = n) %>% 
  column_to_rownames("stim")
summary(as.factor(cluster_info$cell))
```

```{r}
ggplot(cluster_info, aes(x = tsne1, y = tsne2, color = cell)) +
  geom_point() +
  facet_grid(. ~ stim)
```

```{r}
ctrl1 = cluster_info %>% 
  filter(cell %in% c("CD4 T cells", "CD14+ Monocytes", "FCGR3A+ Monocytes")) %>% 
  filter(stim == "ctrl")
ctrl2 = cluster_info %>% 
  filter(cell %in% c("CD4 T cells", "CD14+ Monocytes", "FCGR3A+ Monocytes")) %>% 
  filter(stim == "stim")

mat1 = subset(seuratObj1, cells = rownames(ctrl1))@assays$RNA@counts %>% 
  as.matrix()
mat2 = subset(seuratObj2, cells = rownames(ctrl2))@assays$RNA@counts %>% 
  as.matrix()
```


## Experiment 7

The 'group' column started with 'B' is not useful here.

```{r}
exp7_data <- read.csv("./data/real_world/Exp7_Adam_2017/celltypelabels_Haber.txt", sep="") %>% 
  rownames_to_column("cell") %>% 
  separate(cell, c("group", "barcode", "condition", "cluster"), sep = "_") %>% 
  mutate(group = as.factor(group),
         condition = as.factor(condition),
         cluster = as.factor(cluster)) %>% 
  select(-x)

head(exp7_data)
summary(exp7_data)

exp7_data %>% 
  group_by(group, condition) %>% 
  summarise(n = n())
```

```{r}
## control vs Hpoly.Day3
exp7_C3 = exp7_data %>% 
  filter(condition == "Control" | condition == "Hpoly.Day3") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_C3)
print(fisherP)

## control vs Hpoly.Day10
exp7_C10 = exp7_data %>% 
  filter(condition == "Control" | condition == "Hpoly.Day10") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_C10)
print(fisherP)

## control vs Salmonella
exp7_CS = exp7_data %>% 
  filter(condition == "Control" | condition == "Salmonella") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_CS)
print(fisherP)
```

## Davie 2018

```{r}
Davie2018 = read.delim(gzfile("/storage/holab/linxy/DCATS/Davie2018_WholeBrain_57k_Metadata.tsv.gz")) %>% janitor::clean_names()
summary(Davie2018)
```

Need some big cluster to do clustering

```{r}
Davie2018_info = Davie2018 %>% 
  mutate(annotation = ifelse(str_detect(annotation, "^\\d"), "unknown", annotation)) %>% 
  group_by(age, annotation) %>% 
  summarise(n = n()) %>% 
  #filter(n > 10) %>% 
  filter(annotation %in% c("A/B-KC", "A/B*-KC", "adPN/C15&kn", "Astrocyte-like", "C3", "Clock", "Cortex_glia", "Dm8/Dm11", "Dm9", "Ensheathing_glia", "G-KC", "L4/L5", "Lamina_monopolar", "Lawf1", "Lawf2", "Mi1", "Mip", "PAM", "Peptidergic", "Perineurial_glia", "Photoreceptors", "Plasmatocytes", "Pm1/Pm2", "Pm1/Pm2/Pm3", "Serotonergic", "Subperineurial_glia", "T1", "T2", "T3", "T4/T5", "Tm1/TmY8", "Tm5ab", "Tm5c", "TmY14", "Tyraminergic", "unknown", "MBON", "Chiasm_glia")) %>% 
  pivot_wider(names_from = annotation, values_from = n) %>% 
  mutate(glia = Chiasm_glia + Cortex_glia + Ensheathing_glia + Perineurial_glia + Subperineurial_glia) %>% 
  select(-Chiasm_glia, -Cortex_glia, -Ensheathing_glia, -Perineurial_glia, Subperineurial_glia)

Davie2018_info[is.na(Davie2018_info)] = 0
```

```{r}
design_mat = Davie2018_info[,1] %>% as.matrix()
count_mat = Davie2018_info[,2:dim(Davie2018_info)[2]] %>% as.matrix()
res = dcats_GLM(count_mat, design_mat)
res$pvals %>% as.matrix() %>%  .[.<0.05]
```


## Hochgerner 2018

```{r}
Hochgerner2018 = read.delim(gzfile("/storage/holab/linxy/DCATS/Hochgerner2018_metadata_barcodes_24185cells.txt.gz")) %>% janitor::clean_names() %>% 
  mutate_if(is.character, as.factor)
summary(Hochgerner2018)
```

```{r}
Hochgerner2018 %>% 
  group_by(characteristics_cell_cluster) %>% 
  summarise(n = n())

Hochgerner2018_info = Hochgerner2018 %>% 
  group_by(characteristics_cell_cluster, characteristics_age, characteristics_strain) %>% 
  summarise(n = n()) %>% 
  filter(characteristics_cell_cluster != "") %>% 
  pivot_wider(names_from = characteristics_cell_cluster, values_from = n)

Hochgerner2018_info

design_mat = Hochgerner2018_info[,1:2] %>% as.matrix()
count_mat = Hochgerner2018_info[,3:dim(Hochgerner2018_info)[2]] %>% as.matrix()
count_mat[is.na(count_mat)] = 0
count_mat
```

```{r}
dcats_GLM <- function(count_mat, design_mat, similarity_mat=NULL, n_samples=50,
                      pseudo_count=NULL,  base_model='NULL') {
  # Output matrices
  coeffs     <- matrix(NA, ncol(count_mat), ncol(design_mat))
  coeffs_err <- matrix(NA, ncol(count_mat), ncol(design_mat))
  LR_vals    <- matrix(NA, ncol(count_mat), ncol(design_mat))
  LRT_pvals  <- matrix(NA, ncol(count_mat), ncol(design_mat))
  LRT_fdr    <- matrix(NA, ncol(count_mat), ncol(design_mat))

  # Check colnames
  if (is.null(colnames(count_mat)))
    colnames(count_mat) <- paste0('cell_type_', seq(ncol(count_mat)))
  if (is.null(colnames(design_mat)))
    colnames(design_mat) <- paste0('factor_', seq(ncol(design_mat)))

  # Add rownames and colnames
  rownames(LR_vals) <- rownames(LRT_pvals) <- rownames(LRT_fdr) <-
    rownames(coeffs) <- rownames(coeffs_err) <- colnames(count_mat)
  colnames(LR_vals) <- colnames(LRT_pvals) <- colnames(LRT_fdr) <-
    colnames(coeffs) <- colnames(coeffs_err) <- colnames(design_mat)
  
  
  ## using estimated the latent cell counts
  count_latent = count_mat
  if(!is.null(similarity_mat)) {
    for (i in seq_len(nrow(count_mat))) {
      count_latent[i, ] <- sum(count_mat[i, ]) *
        multinom_EM(count_mat[i, ], similarity_mat, verbose = FALSE)$mu
    }
  }
  
  K <- ncol(count_mat) ## number of cell types
  if (is.null(similarity_mat)) {
    n_samples <- 1
  }
  
  if (!is.null(n_samples) && !is.null(similarity_mat)) {
    count_use <- matrix(0, nrow(count_mat) * n_samples, K)
    for (i in seq_len(nrow(count_mat))) {
      idx <- seq((i - 1) * n_samples + 1, i * n_samples)
      for (j in seq_len(K)) {
        count_use[idx, ] <- (
          count_use[idx, ] + t(rmultinom(n_samples, count_latent[i, j], similarity_mat[j, ])))
      }
    }
  } else{
    count_use <- count_mat
  }
  
  # adding pseudo counts
  if (is.null(pseudo_count)) {
    if (any(colMeans(count_mat) == 0)) {
      print(paste("Empty cell type exists in at least one conidtion;",
                  "adding replicate & condition specific pseudo count:"))
      count_use <- count_use + 1
    }
  } else {
    count_use = count_use + pseudo_count
  }
  
  count_use = round(count_use)
  
  # Test each factor
  for (m in seq_len(ncol(count_use))) {
    for (k in seq_len(ncol(design_mat))) {
      df_use <- data.frame(n1 = count_use[, m], total=rowSums(count_use))
      df_use <- cbind(df_use, as.data.frame(design_mat)[, k, drop=FALSE])

      df_tmp <- df_use[!is.na(design_mat[, k]), ]
      
      ## model fitting using betabin
      fm0 <- aod::betabin(cbind(n1, total-n1) ~ 1, ~ 1, data = df_tmp)
      formula_fix <- as.formula(paste0('cbind(n1, total-n1)', '~ 1+',
                                         colnames(design_mat)[k], sep=''))
      fm1 <- aod::betabin(formula_fix, ~ 1, data = df_tmp)

      ## ignore the fitting if the hessian matrix is singular
      if (length(fm1@varparam) < 4 || is.na(fm1@varparam[2, 2])) {next}

      LR_vals[m, k] <- fm0@dev - fm1@dev
      LRT_pvals[m, k] <- pchisq(LR_vals[m, k], df=1, lower.tail = FALSE, log.p = FALSE)

      coeffs[m, k] <- fm1@param[2]
      coeffs_err[m, k] <- fm1@varparam[2, 2]
    }
  }

  # Return list
  LRT_fdr[,] <- p.adjust(LRT_pvals, method = 'fdr')
  res <- list('ceoffs'=coeffs, 'coeffs_err'=coeffs_err,
              'LR_vals'=LR_vals, 'pvals'=LRT_pvals, 'fdr'=LRT_fdr)
  res
}
```

```{r}
dcats_GLM(count_mat, design_mat)
```

## Schafflick_2020

```{r}
library(readxl)    
read_excel_allsheets <- function(filename, tibble = FALSE) {
    # I prefer straight data.frames
    # but if you like tidyverse tibbles (the default with read_excel)
    # then just pass tibble = TRUE
    sheets <- readxl::excel_sheets(filename)
    x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
    if(!tibble) x <- lapply(x, as.data.frame)
    names(x) <- sheets
    x
}
flow_rw1 <- read_excel_allsheets("./data/real_world/Schafflick_2020/flow_cellcounts.xlsx")
```

```{r}
## check data format
flow_rw1$csf_ctrl %>% print()
flow_rw1$csf_ms
```

I can't find the information of each cell getting from flow cytometry process, thus I used the uniform confusion matrix here.

For this dataset, as we don't know the total numbers of cells, we can get the result. 

### csf_ctrl vs csf_ms

```{r}
simil_matU = get_similarity_matRW(dim(flow_rw1$csf_ctrl)[2], confuse_rate=0.1)
colnames(flow_rw1$csf_ctrl)
truth = c("P", "N", "N", "P", "N", "P", "N", "N", "N", "N", "P", "P")
```

```{r}
numb_cond1 =round(as.matrix(flow_rw1$csf_ctrl) * 10^4)
numb_cond2 =round(as.matrix(flow_rw1$csf_ms) * 10^4)
```

```{r}
## DCATS
simil_matU = get_similarity_matRW(dim(flow_rw1$csf_ctrl)[2], confuse_rate=0.1)
betabin_wMU = dcats_betabin(numb_cond1, numb_cond2, similarity_mat = simil_matU, n_samples = 100)
## Fisher
fisher_pvals = getFisher(numb_cond1, numb_cond2)
all_res = data.frame(cluster = colnames(flow_rw1$csf_ctrl), truth = truth) %>% 
  mutate(betabin_wMU_pvals = betabin_wMU$pvals,
         fisher_pvals = fisher_pvals) %>%
  mutate(betabin_wMU_Res = ifelse(betabin_wMU_pvals < 0.05, "P","N"),
         fisher_Res = ifelse(fisher_pvals < 0.05, "P","N"))
```

## Kaufmann 2021

```{r}
#pathSPC = "/storage/holab/linxy"  ## for server
pathSPC = "D:/Data"
```

```{r}
#Kaufmann2021 = read.delim(gzfile("/storage/holab/linxy/DCATS/Kaufmann2021_metadata_per_sample.csv.gz"), sep = ",") %>% janitor::clean_names()
Kaufmann2021 = read.delim(gzfile(str_c(pathSPC, "/DCATS/Kaufmann2021_metadata_per_cell.csv.gz")), sep = ",") %>% 
  janitor::clean_names() %>% 
  mutate_if(is.character, as.factor)
head(Kaufmann2021)
summary(Kaufmann2021)
Kaufmann2021 %>% group_by(group) %>% 
  summarise(donor = unique(donor)) %>% 
  summarise(n = n())
```

## treated vs untreated

should give positive result for T09&T06 -> wrong

```{r}
res_mat = Kaufmann2021 %>% filter(group == "MS1_nat" | group == "MS1") %>% 
  group_by(donor, cluster_names, sex, age_sampling, natalizumab_treatment) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cluster_names, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  mutate(donor = str_c(donor, "_", natalizumab_treatment)) %>% 
  column_to_rownames("donor")
res_mat %>% print()
```

```{r}
count_mat = res_mat %>% select(B01:T11) %>% 
  as.matrix()
design_mat = res_mat %>% select(sex:natalizumab_treatment) %>% 
  as.matrix()
  
print(count_mat)
print(design_mat)

simil_mat = create_simMat(dim(count_mat)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = count_mat, design_mat = design_mat, similarity_mat = simil_mat)
sig_GLM = ifelse(res_GLM$LRT_pvals < 0.05, "P", "N") 
print(sig_GLM)
print(res_GLM$LRT_pvals)
print(res_GLM$pvals)
```

```{r}
res_mat %>% 
  rownames_to_column("donor") %>% 
  group_by(donor, natalizumab_treatment) %>% 
  pivot_longer(names_to = "cell_type", values_to = "n", B01:T11) %>% 
  mutate(prop = n/sum(n)) %>% 
  
  ggplot(aes(x = cell_type, y = prop)) +
    geom_boxplot(aes(color = natalizumab_treatment)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

## cohort-1

should give negative results for T09 -> true

```{r}
res_mat = Kaufmann2021 %>% filter(group == "HI1" | group == "MS1") %>% 
  group_by(donor, cluster_names, sex, age_sampling, group) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cluster_names, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  #mutate(donor = str_c(donor, "_", natalizumab_treatment)) %>% 
  column_to_rownames("donor")
res_mat %>% print()
```

```{r}
count_mat = res_mat %>% select(B01:T11) %>% 
  as.matrix()
design_mat = res_mat %>% select(sex:group) %>% 
  as.matrix()
  
print(count_mat)
print(design_mat)

simil_mat = create_simMat(dim(count_mat)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = count_mat, design_mat = design_mat, similarity_mat = simil_mat)
sig_GLM = ifelse(res_GLM$pvals < 0.05, "P", "N") 
print(sig_GLM)
```

## cohort-2

should give negative results for T09 -> true

```{r}
res_mat = Kaufmann2021 %>% filter(group == "HI2" | group == "MS2") %>% 
  group_by(donor, cluster_names, age_sampling, group) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cluster_names, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  #mutate(donor = str_c(donor, "_", natalizumab_treatment)) %>% 
  column_to_rownames("donor")
res_mat %>% print()
```

```{r}
count_mat = res_mat %>% select(B01:T11) %>% 
  as.matrix()
design_mat = res_mat %>% select(age_sampling, group) %>% 
  as.matrix()
  
print(count_mat)
print(design_mat)

simil_mat = create_simMat(dim(count_mat)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = count_mat, design_mat = design_mat, similarity_mat = simil_mat)
sig_GLM = ifelse(res_GLM$LRT_pvals < 0.05, "P", "N") 
print(sig_GLM)
```

## Peng2018

Pei1-run1n2 is P10 control 2, Pei2-run1n2 is P10 control 3 and WT-run1n2 is P10 control 1.

```{r}
Peng2018 <- read.delim("./data/real_world/Peng_2018/Peng2018_meta.txt") %>% 
  janitor::clean_names() %>% 
  separate(name_type, c("group", "barcode"), sep = "[_]") %>% 
  mutate(group = ifelse(group == "Pei1-run1n2", "Ctrl-P10-2", group),
         group = ifelse(group == "Pei2-run1n2", "Ctrl-P10-3", group),
         group = ifelse(group == "WT-run1n2", "Ctrl-P10-1", group)) %>% 
  separate(group, c("treatment", "condition", "donor"), sep = "[-]") %>% 
  mutate(donor = str_c(condition, "-", donor)) %>% 
  mutate_if(is.character, as.factor) %>% 
  rename(cluster_names = cluster_group)
head(Peng2018)
summary(Peng2018)
```


## P6 vs P10

```{r}
resDF = getCount(Peng2018)
print(resDF)
```

The cell proportion here is not consistant with what describe in the paper. Use other files

```{r}
Peng2018_p6 <- read.delim("./data/real_world/Peng_2018/Peng2018_P6_coord.txt")[-1,] %>% 
  janitor::clean_names() %>% 
  separate(name, c("group", "barcode"), sep = "[_]") %>% 
  separate(group, c("treatment", "condition", "donor"), sep = "[-]") %>% 
  mutate(donor = str_c(condition, "-", donor)) %>% 
  mutate_if(is.character, as.factor) %>% 
  rename(cluster_names = category)
```

```{r}
resDF_p6 = getCount(Peng2018_p6)
print(resDF_p6)
```

```{r}
Peng2018_p10 <- read.delim(gzfile("./data/real_world/Peng_2018/Peng2018_P10_coord.gz"))[-1,] %>% 
  janitor::clean_names() %>% 
  separate(name, c("group", "barcode"), sep = "[_]") %>% 
  mutate(group = ifelse(group == "Pei1-run1n2", "Ctrl-P10-2", group),
         group = ifelse(group == "Pei2-run1n2", "Ctrl-P10-3", group),
         group = ifelse(group == "WT-run1n2", "Ctrl-P10-1", group)) %>% 
  separate(group, c("treatment", "condition", "donor"), sep = "[-]") %>% 
  mutate(donor = str_c(condition, "-", donor)) %>% 
  mutate_if(is.character, as.factor) %>% 
  rename(cluster_names = category)
```

```{r}
resDF_p10 = getCount(Peng2018_p10) %>% 
  mutate(dCM = dCM1 + dCM2 + dCM3,
         mCM = mCM1 + mCM2) %>% 
  select(-dCM1, -dCM2, -dCM3, -mCM1, -mCM2, -LEC) %>% 
  rename(`PC/SMC` = `Per/SMC`)
print(resDF_p10)
```

```{r}
resDF = rbind(resDF_p6, resDF_p10)
```

```{r}
resDF %>% 
  rownames_to_column("donor") %>% 
  group_by(donor, condition) %>% 
  pivot_longer(names_to = "cell_type", values_to = "n", BC:pCM) %>% 
  mutate(prop = n/sum(n)) %>% 
  
  ggplot(aes(x = cell_type, y = prop)) +
    geom_boxplot(aes(color = condition))
```


```{r}
count_mat = resDF %>% select(-condition) %>% as.matrix()
design_mat = resDF$condition %>% as.matrix()
colnames(design_mat) = "time"
simil_mat = create_simMat(dim(count_mat)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = count_mat, design_mat = design_mat, similarity_mat = simil_mat)
ifelse(res_GLM$pvals < 0.05, "P", "N") 
print(res_GLM$LR_vals)
print(res_GLM$pvals)
```

## Cui_2019

```{r}
library(readxl)
Cui_2019 <- read_excel("data/real_world/Cui_2019.xlsx") %>% 
  janitor::clean_names() %>% 
  mutate(time = str_extract(cell_name, '[5-9]W|1[0-9]W|2[0-5]W')) %>% 
  mutate(cluster = str_replace(cluster, "\\(", "_"),
         cluster = str_remove(cluster, "\\)"))
```

Have no replicate in this case, as we only have one replicate, should works.

```{r}
Cui2019_res = Cui_2019 %>% 
  group_by(cluster, time) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cluster, values_from = n) %>% 
  janitor::clean_names() %>% 
  mutate(time = as.numeric(str_remove(time, 'W'))) %>% 
  mutate(stage = ifelse(time<8&time>4, "early", "late"),
         stage = ifelse(time<18&time>8, "mid", stage))

Cui2019_count = Cui2019_res %>% 
  select(-time,-stage) %>% 
  replace(is.na(.), 0) %>% 
  mutate(other = c1_5w + c5_valvar_cell + c6_ep,
         immune = c7_mast_cell + c8_macrophage + c9_b_t_cells) %>% 
  select(-c1_5w, -c5_valvar_cell, -c6_ep, -c7_mast_cell, -c8_macrophage, -c9_b_t_cells) %>% 
  as.matrix()

Cui2019_design = Cui2019_res %>% 
  #mutate(time = as.numeric(str_remove(time, 'W'))) %>% 
  select(time, stage)
print(Cui2019_count)
print(Cui2019_design)
```

```{r}
simil_mat = create_simMat(dim(Cui2019_count)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = Cui2019_count, design_mat = Cui2019_design, similarity_mat = simil_mat)
ifelse(res_GLM$LRT_pvals < 0.05, "P", "N") 
ifelse(res_GLM$pvals < 0.05, "P", "N") 
print(res_GLM$LR_vals)
print(res_GLM$pvals)
```

Compare them seperately

```{r}
Cui2019_count = Cui2019_res %>% 
  filter(stage %in% c("early", "mid")) %>% 
  select(-time,-stage) %>% 
  replace(is.na(.), 0) %>% 
  mutate(other = c1_5w + c5_valvar_cell + c6_ep,
         immune = c7_mast_cell + c8_macrophage + c9_b_t_cells) %>% 
  select(-c1_5w, -c5_valvar_cell, -c6_ep, -c7_mast_cell, -c8_macrophage, -c9_b_t_cells) %>% 
  as.matrix()
Cui2019_design = Cui2019_res %>% 
  filter(stage %in% c("early", "mid")) %>% 
  #mutate(time = as.numeric(str_remove(time, 'W'))) %>% 
  select(time, stage)
print(Cui2019_count)
print(Cui2019_design)
simil_mat = create_simMat(dim(Cui2019_count)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = Cui2019_count, design_mat = Cui2019_design, similarity_mat = simil_mat)
ifelse(res_GLM$LRT_pvals < 0.05, "P", "N") 
ifelse(res_GLM$pvals < 0.05, "P", "N") 
print(res_GLM$LR_vals)
print(res_GLM$pvals)
```

```{r}
Cui2019_count = Cui2019_res %>% 
  filter(stage %in% c("late", "mid")) %>% 
  select(-time,-stage) %>% 
  replace(is.na(.), 0) %>% 
  mutate(other = c1_5w + c5_valvar_cell + c6_ep,
         immune = c7_mast_cell + c8_macrophage + c9_b_t_cells) %>% 
  select(-c1_5w, -c5_valvar_cell, -c6_ep, -c7_mast_cell, -c8_macrophage, -c9_b_t_cells) %>% 
  as.matrix()
Cui2019_design = Cui2019_res %>% 
  filter(stage %in% c("late", "mid")) %>% 
  #mutate(time = as.numeric(str_remove(time, 'W'))) %>% 
  select(time, stage)
print(Cui2019_count)
print(Cui2019_design)
simil_mat = create_simMat(dim(Cui2019_count)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = Cui2019_count, design_mat = Cui2019_design, similarity_mat = simil_mat)
ifelse(res_GLM$LRT_pvals < 0.05, "P", "N") 
ifelse(res_GLM$pvals < 0.05, "P", "N") 
print(res_GLM$LR_vals)
print(res_GLM$pvals)
```

## Ren 2021

COVID-19 immune features revealed by a large-scale single-cell transcriptome atlas

First look at PBMC data.

```{r}
library(readxl)
Ren2021_cell = read.csv(gzfile("./data/real_world/Ren_2021/cell_annotation.csv.gz")) %>% 
  janitor::clean_names()
Ren2021_donors = read_excel("data/real_world/Ren_2021/donors_info.xlsx") %>% 
  janitor::clean_names()
```

```{r}
pbmc_sampleL = Ren2021_donors %>% 
  filter(sample_type == "frozen PBMC" | sample_type == "fresh PBMC") %>% 
  .$sample_id %>% 
  unique()

sample_patient = Ren2021_donors %>% select(sample_id, patient_id)
```

### major type

```{r}
count_mat = Ren2021_cell %>% 
  filter(sample_id %in% pbmc_sampleL) %>% 
  group_by(sample_id, major_type) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = major_type, values_from = n) %>% 
  arrange(sample_id) %>% 
  column_to_rownames("sample_id") %>% 
  replace(is.na(.), 0) %>% 
  as.matrix()
```

```{r}
design_mat = Ren2021_donors %>% 
  filter(sample_id %in% pbmc_sampleL) %>% 
  mutate(state = ifelse(sample_time == "control", "control", str_c(co_vid_19_severity, "_", sample_time))) %>% 
  select(sample_id, city, age, sex, sample_type, state) %>% 
  #unique() %>% 
  arrange(sample_id) %>% 
  column_to_rownames("sample_id")
```

```{r}
simil_mat = create_simMat(dim(count_mat)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = count_mat, design_mat = design_mat, similarity_mat = simil_mat)
#ifelse(res_GLM$LRT_pvals < 0.05, "P", "N") 
ifelse(res_GLM$pvals < 0.05, "P", "N") 
#print(res_GLM$LR_vals)
print(res_GLM$pvals)
```

Separate into different group comparison

control vs mild/moderate_progression

```{r}
design_mat_sub = design_mat %>% 
  filter(state == "control" | state == "mild/moderate_progression")
count_mat_sub = count_mat[rownames(design_mat_sub),]

simil_mat = create_simMat(dim(count_mat_sub)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = count_mat_sub, design_mat = design_mat_sub, similarity_mat = simil_mat)
#ifelse(res_GLM$LRT_pvals < 0.05, "P", "N") 
ifelse(res_GLM$pvals < 0.05, "P", "N") 
#print(res_GLM$LR_vals)
print(res_GLM$pvals)
```

Separate into different group comparison

control vs severe/critical_progression

```{r}
design_mat_sub = design_mat %>% 
  filter(state == "control" | state == "severe/critical_progression")
count_mat_sub = count_mat[rownames(design_mat_sub),]

simil_mat = create_simMat(dim(count_mat_sub)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = count_mat_sub, design_mat = design_mat_sub, similarity_mat = simil_mat)
#ifelse(res_GLM$LRT_pvals < 0.05, "P", "N") 
ifelse(res_GLM$pvals < 0.05, "P", "N") 
#print(res_GLM$LR_vals)
print(res_GLM$pvals)
```

```{r}
count_mat_sub %>% as.data.frame() %>% 
  cbind(design_mat_sub) %>% 
  rownames_to_column("sample_id") %>% 
  pivot_longer(names_to = "cell_type", values_to = "n", B:Neu) %>% 
  group_by(sample_id) %>% 
  mutate(prop = n/sum(n)) %>% 
  ggplot(aes(x = cell_type, y = prop)) +
    geom_boxplot(aes(color = state))
```

mild/moderate_convalescence vs mild/moderate_progression

```{r}
design_mat_sub = design_mat %>% 
  filter(state == "mild/moderate_convalescence" | state == "mild/moderate_progression")
count_mat_sub = count_mat[rownames(design_mat_sub),]

simil_mat = create_simMat(dim(count_mat_sub)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = count_mat_sub, design_mat = design_mat_sub, similarity_mat = simil_mat)
#ifelse(res_GLM$LRT_pvals < 0.05, "P", "N") 
ifelse(res_GLM$pvals < 0.05, "P", "N") 
#print(res_GLM$LR_vals)
print(res_GLM$pvals)
```

```{r}
count_mat_sub %>% as.data.frame() %>% 
  cbind(design_mat_sub) %>% 
  rownames_to_column("sample_id") %>% 
  pivot_longer(names_to = "cell_type", values_to = "n", B:Neu) %>% 
  group_by(sample_id) %>% 
  mutate(prop = n/sum(n)) %>% 
  ggplot(aes(x = cell_type, y = prop)) +
    geom_boxplot(aes(color = state))
```

severe/critical_convalescence vs severe/critical_progression

```{r}
design_mat_sub = design_mat %>% 
  filter(state == "severe/critical_convalescence" | state == "severe/critical_progression")
count_mat_sub = count_mat[rownames(design_mat_sub),]

simil_mat = create_simMat(dim(count_mat_sub)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = count_mat_sub, design_mat = design_mat_sub, similarity_mat = simil_mat)
#ifelse(res_GLM$LRT_pvals < 0.05, "P", "N") 
ifelse(res_GLM$pvals < 0.05, "P", "N") 
#print(res_GLM$LR_vals)
print(res_GLM$pvals)
```

```{r}
count_mat_sub %>% as.data.frame() %>% 
  cbind(design_mat_sub) %>% 
  rownames_to_column("sample_id") %>% 
  pivot_longer(names_to = "cell_type", values_to = "n", B:Neu) %>% 
  group_by(sample_id) %>% 
  mutate(prop = n/sum(n)) %>% 
  ggplot(aes(x = cell_type, y = prop)) +
    geom_boxplot(aes(color = state))
```

mild/moderate_progression vs severe/critical_progression

```{r}
design_mat_sub = design_mat %>% 
  filter(state == "mild/moderate_progression" | state == "severe/critical_progression")
count_mat_sub = count_mat[rownames(design_mat_sub),]

simil_mat = create_simMat(dim(count_mat_sub)[2], confuse_rate=0.1)
res_GLM = dcats_GLM(count_mat = count_mat_sub, design_mat = design_mat_sub, similarity_mat = simil_mat)
#ifelse(res_GLM$LRT_pvals < 0.05, "P", "N") 
ifelse(res_GLM$pvals < 0.05, "P", "N") 
#print(res_GLM$LR_vals)
print(res_GLM$pvals)
```

```{r}
count_mat_sub %>% as.data.frame() %>% 
  cbind(design_mat_sub) %>% 
  rownames_to_column("sample_id") %>% 
  pivot_longer(names_to = "cell_type", values_to = "n", B:Neu) %>% 
  group_by(sample_id) %>% 
  mutate(prop = n/sum(n)) %>% 
  ggplot(aes(x = cell_type, y = prop)) +
    geom_boxplot(aes(color = state))
```

## sub type

```{r}
Neu_count = Ren2021_cell %>% 
  merge(sample_patient) %>% 
  filter(sample_id %in% pbmc_sampleL) %>% 
  group_by(patient_id, celltype) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = celltype, values_from = n) %>% 
  column_to_rownames("patient_id") %>% 
  select(starts_with("Neu")) %>% 
  replace(is.na(.), 0) %>% 
  rowSums()
Macro_count = Ren2021_cell %>% 
  merge(sample_patient) %>% 
  filter(sample_id %in% pbmc_sampleL) %>% 
  group_by(patient_id, celltype) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = celltype, values_from = n) %>% 
  column_to_rownames("patient_id") %>% 
  select(starts_with("Macro")) %>% 
  replace(is.na(.), 0) %>% 
  rowSums()
```
```{r}
count_mat = Ren2021_cell %>% 
  merge(sample_patient) %>% 
  filter(sample_id %in% pbmc_sampleL) %>% 
  group_by(patient_id, celltype) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = celltype, values_from = n) %>% 
  column_to_rownames("patient_id") %>% 
  select(-starts_with("Neu"), -starts_with("Macro")) %>% 
  mutate(Neu = Neu_count,
         Macro = Macro_count)
```



## Codes

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```
