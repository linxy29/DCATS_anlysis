---
title: "Real word data"
author: "Xinyi Lin"
date: "10/27/2020"
output: html_document
---

Try different real world data

Read real world data and some basic information

* Simulation data: experiment 1, 2, 4

* real word data: experiment 3, 5, 6, 7

* no data of exp6

* Exp 3, 5, 7 only fisher works, don’t have batches-> speckle and diffcyt don’t work

* Exp5: BM1, BM2, BM3 have far more less cells than AML

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r,message=FALSE,warning=FALSE}
library(splatter)
library(Seurat)
library(speckle)
library(DCATS)
library(ggplot2)
library(tidyverse)
library(diffcyt)
```

```{r}
source("functions.r")
```

Fisher's exact test

```{r}
get_fisherP = function(data = data){
  data_sum = data %>% 
    group_by(condition) %>% 
    summarise(n = n())
  
  data_count = data %>% 
    group_by(cluster, condition) %>% 
    summarise(n = n()) %>% 
    pivot_wider(names_from = "cluster", values_from = "n") %>% 
    mutate_all(~replace(., is.na(.), 0))

  fisher_pvals = rep(NA,ncol(data_count)-1)
  cluster_name = colnames(data_count)[-1]
  for (i in 2:ncol(data_count)) {
    cot_table = cbind(data_count[, i], data_sum$n-data_count[, i])
    fisher_pvals[i-1] = fisher.test(cot_table)$p.value
    }
  
  fisherP = data.frame(cluster = cluster_name, fisher_pvals = fisher_pvals)
  return(fisherP)
}
```

## Experiment 3

TIP is the one Hepheas used

```{r}
exp3_GFP <- read.delim("./data/real_world/Exp3_Farbehi_2019/GFP_tSNE_cluster_ID_table.txt") %>% 
  mutate(cluster = as.factor(cluster),
         experiment = as.factor(experiment))
exp3_TIP <- read.delim("./data/real_world/Exp3_Farbehi_2019/TIP_tSNE_cluster_ID_table.txt") %>% 
  mutate(cluster = as.factor(cluster),
         experiment = as.factor(experiment))
head(exp3_GFP)
head(exp3_TIP)
summary(exp3_GFP)
summary(exp3_TIP)
```

diffcyt and speckle cannot works without batch

```{r, eval=FALSE}
cell_numberL = exp3_TIP_37_sum$n
# Function to create random data (one sample)
d_random <- function(cell_number, mean = 0, sd = 1, ncol = 20, cofactor = 5) {
  d <- sinh(matrix(rnorm(cell_number*20, mean, sd), ncol = ncol)) * cofactor
  colnames(d) <- paste0("marker", sprintf("%02d", 1:ncol))
  return(d)
}
# Create random data (without differential signal)
set.seed(123)
d_input <- list(
  sample1 = d_random(cell_number = cell_numberL[1]), 
  sample2 = d_random(cell_number = cell_numberL[2])
)
experiment_info <- data.frame(
  sample_id = factor(exp3_TIP_37_sum$experiment), 
  stringsAsFactors = FALSE
)
marker_info <- data.frame(
  channel_name = paste0("channel", sprintf("%03d", 1:20)), 
  marker_name = paste0("marker", sprintf("%02d", 1:20)), 
  marker_class = factor(c(rep("type", 10), rep("state", 10)), 
                          levels = c("type", "state", "none")), 
  stringsAsFactors = FALSE
)
# Prepare data
d_se <- prepareData(d_input, experiment_info, marker_info)
# Transform data
d_se <- transformData(d_se)
# Generate clusters
d_se <- generateClusters(d_se)
# Replace with our simulated data info
d_se@elementMetadata$sample_id = exp3_TIP_37$experiment
d_se@elementMetadata$cluster_id = exp3_TIP_37$cluster
# Calculate counts
d_counts <- calcCounts(d_se)
# Create design matrix
design <- createDesignMatrix(experiment_info, cols_design = "sample_id")
# Create contrast matrix
contrast <- createContrast(c(0, 1))
# Test for differential abundance (DA) of clusters
res_DA <- testDA_edgeR(d_counts, design, contrast)
diffcytP = topTable(res_DA, format_vals = TRUE) %>% 
  as.data.frame() %>% 
  rownames_to_column("cluster") %>% 
  dplyr::rename(diffcyt_pvals = p_adj) %>% 
  select(cluster, diffcyt_pvals)
```

```{r}
## MI-Day3 vs MI-Day7
exp3_TIP_37 = exp3_TIP %>% 
  filter(experiment != "Sham") %>% 
  dplyr::rename(condition = experiment)
fisherP = get_fisherP(exp3_TIP_37)
print(fisherP)

## Sham vs MI-Day7
exp3_TIP_S3 = exp3_TIP %>% 
  filter(experiment != "MI-Day 7") %>% 
  dplyr::rename(condition = experiment)
fisherP = get_fisherP(exp3_TIP_S3)
print(fisherP)

## Sham vs MI-Day3
exp3_TIP_S7 = exp3_TIP %>% 
  filter(experiment != "MI-Day 3") %>% 
  dplyr::rename(condition = experiment)
fisherP = get_fisherP(exp3_TIP_S7)
print(fisherP)
```

## Experiment 5

```{r}
exp5_AML <- read.delim("./data/real_word/Exp5_Galen/GSM3587924_AML1012-D0.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "AML")
head(exp5_AML)
summary(exp5_AML)

exp5_BM1 <- read.delim("./data/real_word/Exp5_Galen/GSM3587996_BM1.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM1")
head(exp5_BM1)
summary(exp5_BM1)

exp5_BM2 <- read.delim("./data/real_word/Exp5_Galen/GSM3587997_BM2.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM2")
head(exp5_BM2)
summary(exp5_BM2)

exp5_BM3 <- read.delim("./data/real_word/Exp5_Galen/GSM3587999_BM3.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM3")
head(exp5_BM3)
summary(exp5_BM3)

exp5_BM4 <- read.delim("./data/real_word/Exp5_Galen/GSM3588001_BM4.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM4")
head(exp5_BM4)
summary(exp5_BM4)
```

BM1, BM2, BM3 have far more less cells than AML

```{r}
## AML vs BM1
exp5_A1 = rbind(exp5_AML, exp5_BM1)
fisherP = get_fisherP(exp5_A1)
print(fisherP)

## AML vs BM2
exp5_A2 = rbind(exp5_AML, exp5_BM2)
fisherP = get_fisherP(exp5_A2)
print(fisherP)

## AML vs BM3
exp5_A3 = rbind(exp5_AML, exp5_BM3)
fisherP = get_fisherP(exp5_A3)
print(fisherP)

## AML vs BM4
exp5_A4 = rbind(exp5_AML, exp5_BM4)
fisherP = get_fisherP(exp5_A4)
print(fisherP)
```

## Experiment 6

```{r}
matrix1 = readMM(gzfile("./data/real_word/Exp6_Kang/GSM2560248_2.1.mtx.gz")) %>% 
  as.matrix()
matrix2 = readMM(gzfile("./data/real_word/Exp6_Kang/GSM2560249_2.2.mtx.gz")) %>% 
  as.matrix()
```

```{r}
data_dir1 = "./data/real_word/Exp6_Kang/GSM2560248"
list.files(data_dir1) # Should show barcodes.tsv, genes.tsv, and matrix.mtx
expression_matrix1 <- Read10X(data.dir = data_dir1)
seuratObj1 = CreateSeuratObject(counts = expression_matrix1)
seuratObj1 = AddMetaData(object = seuratObj1, metadata = rep("ctrl1", dim(seuratObj1)[2]), col.name = 'sample')

data_dir2 = "./data/real_word/Exp6_Kang/GSM2560249"
list.files(data_dir2) # Should show barcodes.tsv, genes.tsv, and matrix.mtx
expression_matrix2 <- Read10X(data.dir = data_dir2)
seuratObj2 = CreateSeuratObject(counts = expression_matrix2)
seuratObj2 = AddMetaData(object = seuratObj2, metadata = rep("ctrl2", dim(seuratObj2)[2]), col.name = 'sample')
```

```{r}
cluster_info = read.delim("./data/real_world/Exp6_Kang/GSE96583_batch2.total.tsne.df.tsv") 
cluster_info %>% group_by(stim, cell) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cell, values_from = n) %>% 
  column_to_rownames("stim")
summary(as.factor(cluster_info$cell))
```

```{r}
ggplot(cluster_info, aes(x = tsne1, y = tsne2, color = cell)) +
  geom_point() +
  facet_grid(. ~ stim)
```

```{r}
ctrl1 = cluster_info %>% 
  filter(cell %in% c("CD4 T cells", "CD14+ Monocytes", "FCGR3A+ Monocytes")) %>% 
  filter(stim == "ctrl")
ctrl2 = cluster_info %>% 
  filter(cell %in% c("CD4 T cells", "CD14+ Monocytes", "FCGR3A+ Monocytes")) %>% 
  filter(stim == "stim")

mat1 = subset(seuratObj1, cells = rownames(ctrl1))@assays$RNA@counts %>% 
  as.matrix()
mat2 = subset(seuratObj2, cells = rownames(ctrl2))@assays$RNA@counts %>% 
  as.matrix()
```


## Experiment 7

The 'group' column started with 'B' is not useful here.

```{r}
exp7_data <- read.csv("./data/real_world/Exp7_Adam_2017/celltypelabels_Haber.txt", sep="") %>% 
  rownames_to_column("cell") %>% 
  separate(cell, c("group", "barcode", "condition", "cluster"), sep = "_") %>% 
  mutate(group = as.factor(group),
         condition = as.factor(condition),
         cluster = as.factor(cluster)) %>% 
  select(-x)

head(exp7_data)
summary(exp7_data)

exp7_data %>% 
  group_by(group, condition) %>% 
  summarise(n = n())
```

```{r}
## control vs Hpoly.Day3
exp7_C3 = exp7_data %>% 
  filter(condition == "Control" | condition == "Hpoly.Day3") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_C3)
print(fisherP)

## control vs Hpoly.Day10
exp7_C10 = exp7_data %>% 
  filter(condition == "Control" | condition == "Hpoly.Day10") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_C10)
print(fisherP)

## control vs Salmonella
exp7_CS = exp7_data %>% 
  filter(condition == "Control" | condition == "Salmonella") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_CS)
print(fisherP)
```

## Davie 2018

```{r}
Davie2018 = read.delim(gzfile("/storage/holab/linxy/DCATS/Davie2018_WholeBrain_57k_Metadata.tsv.gz")) %>% janitor::clean_names()
summary(Davie2018)
```

Need some big cluster to do clustering

```{r}
Davie2018_info = Davie2018 %>% 
  mutate(annotation = ifelse(str_detect(annotation, "^\\d"), "unknown", annotation)) %>% 
  group_by(age, annotation) %>% 
  summarise(n = n()) %>% 
  #filter(n > 10) %>% 
  filter(annotation %in% c("A/B-KC", "A/B*-KC", "adPN/C15&kn", "Astrocyte-like", "C3", "Clock", "Cortex_glia", "Dm8/Dm11", "Dm9", "Ensheathing_glia", "G-KC", "L4/L5", "Lamina_monopolar", "Lawf1", "Lawf2", "Mi1", "Mip", "PAM", "Peptidergic", "Perineurial_glia", "Photoreceptors", "Plasmatocytes", "Pm1/Pm2", "Pm1/Pm2/Pm3", "Serotonergic", "Subperineurial_glia", "T1", "T2", "T3", "T4/T5", "Tm1/TmY8", "Tm5ab", "Tm5c", "TmY14", "Tyraminergic", "unknown", "MBON", "Chiasm_glia")) %>% 
  pivot_wider(names_from = annotation, values_from = n) %>% 
  mutate(glia = Chiasm_glia + Cortex_glia + Ensheathing_glia + Perineurial_glia + Subperineurial_glia) %>% 
  select(-Chiasm_glia, -Cortex_glia, -Ensheathing_glia, -Perineurial_glia, Subperineurial_glia)

Davie2018_info[is.na(Davie2018_info)] = 0
```

```{r}
design_mat = Davie2018_info[,1] %>% as.matrix()
count_mat = Davie2018_info[,2:dim(Davie2018_info)[2]] %>% as.matrix()
res = dcats_GLM(count_mat, design_mat)
res$pvals %>% as.matrix() %>%  .[.<0.05]
```


## Hochgerner 2018

```{r}
Hochgerner2018 = read.delim(gzfile("/storage/holab/linxy/DCATS/Hochgerner2018_metadata_barcodes_24185cells.txt.gz")) %>% janitor::clean_names() %>% 
  mutate_if(is.character, as.factor)
summary(Hochgerner2018)
```

```{r}
Hochgerner2018 %>% 
  group_by(characteristics_cell_cluster) %>% 
  summarise(n = n())

Hochgerner2018_info = Hochgerner2018 %>% 
  group_by(characteristics_cell_cluster, characteristics_age, characteristics_strain) %>% 
  summarise(n = n()) %>% 
  filter(characteristics_cell_cluster != "") %>% 
  pivot_wider(names_from = characteristics_cell_cluster, values_from = n)

Hochgerner2018_info

design_mat = Hochgerner2018_info[,1:2] %>% as.matrix()
count_mat = Hochgerner2018_info[,3:dim(Hochgerner2018_info)[2]] %>% as.matrix()
count_mat[is.na(count_mat)] = 0
count_mat
```

```{r}
dcats_GLM <- function(count_mat, design_mat, similarity_mat=NULL, n_samples=50,
                      pseudo_count=NULL,  base_model='NULL') {
  # Output matrices
  coeffs     <- matrix(NA, ncol(count_mat), ncol(design_mat))
  coeffs_err <- matrix(NA, ncol(count_mat), ncol(design_mat))
  LR_vals    <- matrix(NA, ncol(count_mat), ncol(design_mat))
  LRT_pvals  <- matrix(NA, ncol(count_mat), ncol(design_mat))
  LRT_fdr    <- matrix(NA, ncol(count_mat), ncol(design_mat))

  # Check colnames
  if (is.null(colnames(count_mat)))
    colnames(count_mat) <- paste0('cell_type_', seq(ncol(count_mat)))
  if (is.null(colnames(design_mat)))
    colnames(design_mat) <- paste0('factor_', seq(ncol(design_mat)))

  # Add rownames and colnames
  rownames(LR_vals) <- rownames(LRT_pvals) <- rownames(LRT_fdr) <-
    rownames(coeffs) <- rownames(coeffs_err) <- colnames(count_mat)
  colnames(LR_vals) <- colnames(LRT_pvals) <- colnames(LRT_fdr) <-
    colnames(coeffs) <- colnames(coeffs_err) <- colnames(design_mat)
  
  
  ## using estimated the latent cell counts
  count_latent = count_mat
  if(!is.null(similarity_mat)) {
    for (i in seq_len(nrow(count_mat))) {
      count_latent[i, ] <- sum(count_mat[i, ]) *
        multinom_EM(count_mat[i, ], similarity_mat, verbose = FALSE)$mu
    }
  }
  
  K <- ncol(count_mat) ## number of cell types
  if (is.null(similarity_mat)) {
    n_samples <- 1
  }
  
  if (!is.null(n_samples) && !is.null(similarity_mat)) {
    count_use <- matrix(0, nrow(count_mat) * n_samples, K)
    for (i in seq_len(nrow(count_mat))) {
      idx <- seq((i - 1) * n_samples + 1, i * n_samples)
      for (j in seq_len(K)) {
        count_use[idx, ] <- (
          count_use[idx, ] + t(rmultinom(n_samples, count_latent[i, j], similarity_mat[j, ])))
      }
    }
  } else{
    count_use <- count_mat
  }
  
  # adding pseudo counts
  if (is.null(pseudo_count)) {
    if (any(colMeans(count_mat) == 0)) {
      print(paste("Empty cell type exists in at least one conidtion;",
                  "adding replicate & condition specific pseudo count:"))
      count_use <- count_use + 1
    }
  } else {
    count_use = count_use + pseudo_count
  }
  
  count_use = round(count_use)
  
  # Test each factor
  for (m in seq_len(ncol(count_use))) {
    for (k in seq_len(ncol(design_mat))) {
      df_use <- data.frame(n1 = count_use[, m], total=rowSums(count_use))
      df_use <- cbind(df_use, as.data.frame(design_mat)[, k, drop=FALSE])

      df_tmp <- df_use[!is.na(design_mat[, k]), ]
      
      ## model fitting using betabin
      fm0 <- aod::betabin(cbind(n1, total-n1) ~ 1, ~ 1, data = df_tmp)
      formula_fix <- as.formula(paste0('cbind(n1, total-n1)', '~ 1+',
                                         colnames(design_mat)[k], sep=''))
      fm1 <- aod::betabin(formula_fix, ~ 1, data = df_tmp)

      ## ignore the fitting if the hessian matrix is singular
      if (length(fm1@varparam) < 4 || is.na(fm1@varparam[2, 2])) {next}

      LR_vals[m, k] <- fm0@dev - fm1@dev
      LRT_pvals[m, k] <- pchisq(LR_vals[m, k], df=1, lower.tail = FALSE, log.p = FALSE)

      coeffs[m, k] <- fm1@param[2]
      coeffs_err[m, k] <- fm1@varparam[2, 2]
    }
  }

  # Return list
  LRT_fdr[,] <- p.adjust(LRT_pvals, method = 'fdr')
  res <- list('ceoffs'=coeffs, 'coeffs_err'=coeffs_err,
              'LR_vals'=LR_vals, 'pvals'=LRT_pvals, 'fdr'=LRT_fdr)
  res
}
```

```{r}
dcats_GLM(count_mat, design_mat)
```

## Kaufmann 2021

```{r}
#pathSPC = "/storage/holab/linxy"  ## for server
pathSPC = "D:/Data"
```

```{r}
#Kaufmann2021 = read.delim(gzfile("/storage/holab/linxy/DCATS/Kaufmann2021_metadata_per_sample.csv.gz"), sep = ",") %>% janitor::clean_names()
Kaufmann2021 = read.delim(gzfile(str_c(pathSPC, "/DCATS/Kaufmann2021_metadata_per_cell.csv.gz")), sep = ",") %>% 
  janitor::clean_names() %>% 
  mutate_if(is.character, as.factor)
head(Kaufmann2021)
summary(Kaufmann2021)
Kaufmann2021 %>% group_by(group) %>% 
  summarise(donor = unique(donor)) %>% 
  summarise(n = n())
```

## treated vs untreated

should give positive result for T09&T06 -> correct

```{r}
numb_ms1Nat = Kaufmann2021 %>% 
  filter(group == "MS1_nat") %>% 
  group_by(donor, cluster_names) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cluster_names, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  column_to_rownames("donor") %>% 
  as.matrix()
numb_ms1 = Kaufmann2021 %>% 
  filter(group == "MS1") %>% 
  group_by(donor, cluster_names) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cluster_names, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  column_to_rownames("donor") %>% 
  as.matrix()
print(numb_ms1)
print(numb_ms1Nat)
```

```{r}
simil_mat = create_simMat(dim(numb_ms1)[2], confuse_rate=0.2)
res = dcats_betabin(numb_ms1Nat, numb_ms1, similarity_mat = simil_mat) %>% 
  mutate(wether_sig = ifelse(pvals < 0.05, "P", "N")) %>% 
  select(pvals, wether_sig)
```

```{r}
count_mat = rbind(numb_ms1Nat, numb_ms1)
design_mat = c(rep("ms1Nat", dim(numb_ms1Nat)[1]), rep("ms1", dim(numb_ms1)[1])) %>% as.matrix(ncol = 1)
res_GLM = dcats_GLM(count_mat = count_mat, design_mat = design_mat, similarity_mat = simil_mat)
sig_GLM = ifelse(res_GLM$pvals < 0.05, "P", "N") 
```

## cohort-1

should give negative results for T09 -> true

```{r}
numb_hi1 = Kaufmann2021 %>% 
  filter(group == "HI1") %>% 
  group_by(donor, cluster_names) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cluster_names, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  column_to_rownames("donor") %>% 
  as.matrix()
numb_ms1 = Kaufmann2021 %>% 
  filter(group == "MS1") %>% 
  group_by(donor, cluster_names) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cluster_names, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  column_to_rownames("donor") %>% 
  as.matrix()
print(numb_hi1)
print(numb_ms1)
```

```{r}
simil_mat = create_simMat(dim(numb_hi1)[2], confuse_rate=0.2)
res = dcats_betabin(numb_hi1, numb_ms1, similarity_mat = simil_mat) %>% 
  mutate(wether_sig = ifelse(pvals < 0.05, "P", "N")) %>% 
  select(pvals, wether_sig)
```

```{r}
count_mat = rbind(numb_hi1, numb_ms1Nat)
design_mat = c(rep("hi1", dim(numb_hi1)[1]), rep("ms1", dim(numb_ms1Nat)[1])) %>% as.matrix(ncol = 1)
res_GLM = dcats_GLM(count_mat = count_mat, design_mat = design_mat, similarity_mat = simil_mat)
sig_GLM = ifelse(res_GLM$pvals < 0.05, "P", "N") 
```

## cohort-2

should give negative results for T09 -> true

```{r}
numb_hi2 = Kaufmann2021 %>% 
  filter(group == "HI2") %>% 
  group_by(donor, cluster_names) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cluster_names, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  column_to_rownames("donor") %>% 
  as.matrix()
numb_ms2 = Kaufmann2021 %>% 
  filter(group == "MS2") %>% 
  group_by(donor, cluster_names) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = cluster_names, values_from = n) %>% 
  replace(is.na(.), 0) %>% 
  column_to_rownames("donor") %>% 
  as.matrix()
print(numb_hi2)
print(numb_ms2)
```

```{r}
simil_mat = create_simMat(dim(numb_hi2)[2], confuse_rate=0.2)
count_mat = rbind(numb_hi2, numb_ms2)
design_mat = c(rep("hi2", dim(numb_hi2)[1]), rep("ms2", dim(numb_ms2)[1])) %>% as.matrix(ncol = 1)
res_GLM = dcats_GLM(count_mat = count_mat, design_mat = design_mat, similarity_mat = simil_mat)
ifelse(res_GLM$pvals < 0.05, "P", "N") 
```

## Codes

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```
