---
title: "Simulation in Different Scenario(6 clusters)"
author: "Xinyi Lin"
date: "9/27/2020"
output: html_document
---

Using 6 clusters instead of 3 clusters

Problems need to solve:

2. scDC: doesn't work

3. ROC curve? 

4. DCATS: true matrix Hungarian method; knn matrix: change order(updata package)

5. paper: figures in standard format; choose which cases 

Some finding:

1. Identity matrix works the best

0.1, 0.2 keep the same, 0.1->0.05, 0.2->0.1, 0.2->0.25, 0.2->0.3

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r,message=FALSE,warning=FALSE}
library(splatter)
library(Seurat)
library(speckle)
library(DCATS)
library(ggplot2)
library(tidyverse)
library(diffcyt)
```

```{r}
source("functions.r")
```

```{r}
ROC_df = data.frame(cluster = factor(), dcats_pvalsT = numeric(), speckle_pvals = numeric(), dcats_pvalsI = numeric(), dcats_pvalsU = numeric(), dcats_pvalsK = numeric(), fisher_pvals = numeric(), diffcyt_pvals = numeric())
```

## Different batch size

Batch sizes are 1000, 1500, 2000, 2500.

```{r}
set.seed(123)
probNor = c(0.1, 0.2, 0.1, 0.2, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.05, 0.1, 0.25, 0.3)
de_prob = c(0.5,0.5,0.1, 0.1, 0.1, 0.1)

batch_size_list = seq(1000,2500,500)
setresolu_list = c(0.5, 0.3, 0.3, 0.4)
```

```{r,warning=FALSE,message=FALSE}
for (i in 1:4) {
  batch_size = batch_size_list[i]
  setresolu = setresolu_list[i]
  
  sim_list = simualtion(probNor, probMut, de_prob, batch_size)
  integratedSamples = runSeurat(sim_list, batch_size, setresolu)
  conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
  print(conf.mat)
  plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
  print(plot)
  Res = getPandTimeFSDD(integratedSamples, sim_list, batch_size)
  print(Res)
  ROC_df = rbind(ROC_df, Res$Res_df)
}
```

When the cluster B is close to other cluster.

```{r}
## test
set.seed(123)
probNor = c(0.1, 0.2, 0.1, 0.2, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.05, 0.1, 0.25, 0.3)
setresolu = 0.4
batch_size = 2000
de_prob = c(0.5,0.1,0.1, 0.1, 0.1, 0.1)
```

```{r, warning=FALSE,message=FALSE}
sim_list = simualtion(probNor, probMut, de_prob, batch_size)
integratedSamples = runSeurat(sim_list, batch_size, setresolu)
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
Res = getPandTimeFSDD(integratedSamples, sim_list, batch_size)
print(Res)
ROC_df = rbind(ROC_df, Res$Res_df)
```

Test whether different uniform matrix will influence the results, U1 is closer to identity matrix

```{r}
Res = getPandTimeTestU(integratedSamples, sim_list)
print(Res)
```

## Different de.prob

The de.prob of cluster B, C are 0.02, 0.04, 0.06, 0.08.

When de.prob equals to 0.04, only the fisher's exact test give the "correct" result.

```{r}
set.seed(123)
probNor = c(0.1, 0.2, 0.1, 0.2, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.05, 0.1, 0.25, 0.3)
batch_size = 1000

de_prob_list = seq(0.02, 0.10, 0.02)
setresolu_list = c(0.4, 0.4, 0.4, 0.3, 0.3)
```

```{r,warning=FALSE,message=FALSE}
for (i in 1:5) {
  de_prob = c(0.5,0.5,0.1, 0.1, de_prob_list[i], de_prob_list[i])
  setresolu = setresolu_list[i]
  
  sim_list = simualtion(probNor, probMut, de_prob, batch_size)
  integratedSamples = runSeurat(sim_list, batch_size, setresolu)
  conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
  print(conf.mat)
  plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
  print(plot)
  Res = getPandTimeFSDD(integratedSamples, sim_list)
  print(Res)
  ROC_df = rbind(ROC_df, Res$Res_df)
}
```

Reduce cluster number to three

```{r}
set.seed(123)
probNor = c(1/3,1/3,1/3)
probMut = c(1/2,1/6,1/3)
batch_size = 600

de_prob_list = seq(0.02, 0.08, 0.02)
setresolu_list = c(0.4, 0.4, 0.4, 0.3)
```

```{r,warning=FALSE,message=FALSE}
for (i in 1:2) {
  de_prob = c(de_prob_list[i], de_prob_list[i], 0.5)
  setresolu = setresolu_list[i]
  
  sim_list = simualtion(probNor, probMut, de_prob, batch_size)
  integratedSamples = runSeurat(sim_list, batch_size, setresolu)
  conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
  print(conf.mat)
  plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
  print(plot)
  Res = getPandTimeFSDD3(integratedSamples, sim_list, batch_size)
  print(Res)
  ROC_df = rbind(ROC_df, Res$Res_df)
}
```

## negative with different batch size

Batch sizes are 1000, 2000, 3000, 4000.

```{r}
set.seed(123)
probNor = c(0.1, 0.2, 0.1, 0.2, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.1, 0.2, 0.2, 0.2)
de_prob = c(0.5,0.5,0.1, 0.1, 0.1, 0.1)

batch_size_list = seq(1000,4000,1000)
setresolu_list = c(0.5, 0.3, 0.3, 0.3)
```

```{r,warning=FALSE,message=FALSE}
for (i in 1:4) {
  batch_size = batch_size_list[i]
  setresolu = setresolu_list[i]
  
  sim_list = simualtion(probNor, probMut, de_prob, batch_size)
  integratedSamples = runSeurat(sim_list, batch_size, setresolu)
  conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
  print(conf.mat)
  plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
  print(plot)
  Res = getPandTimeFSDD(integratedSamples, sim_list, batch_size)
  print(Res)
  ROC_df = rbind(ROC_df, Res$Res_df)
}
```

```{r, warning=FALSE, message=FALSE}
Truth = c(rep(c("P", "P", "N", "P", "N", "P"),3),c("P", "N", "P", "P", "P", "N"), rep(c("P", "P", "N", "P", "N", "P"), 6), c("P", "N", "P", "P", "N", "P"), rep("N", 24))
ROC_df = ROC_df %>% 
  mutate(truth = Truth)
head(ROC_df)
library(pROC)
par(pty = "s")
roc(ROC_df$truth, ROC_df$speckle_pvals, plot = TRUE, legacy.axes = TRUE, col = "#000000", print.auc = TRUE)
plot.roc(ROC_df$truth, ROC_df$dcats_pvalsT, col = "#E69F00", print.auc = TRUE, print.auc.y = .45, add = TRUE)
plot.roc(ROC_df$truth, ROC_df$dcats_pvalsI, col = "#56B4E9", print.auc = TRUE, print.auc.y = .40, add = TRUE)
plot.roc(ROC_df$truth, ROC_df$dcats_pvalsU, col = "#009E73", print.auc = TRUE, print.auc.y = .35, add = TRUE)
plot.roc(ROC_df$truth, ROC_df$dcats_pvalsK, col = "#F0E442", print.auc = TRUE, print.auc.y = .30, add = TRUE)
plot.roc(ROC_df$truth, ROC_df$fisher_pvals, col = "#0072B2", print.auc = TRUE, print.auc.y = .25, add = TRUE)
plot.roc(ROC_df$truth, ROC_df$diffcyt_pvals, col = "#D55E00", print.auc = TRUE, print.auc.y = .20, add = TRUE)
legend("bottomleft", legend=c("speckle", "dcatsT", "dcatsI", "dcatsU", "dcatsK", "fisher", "diffcyt"), col=c("Red", "Orange", "Gray", "Green", "Blue", "Purple", "Black"))
par(pty = "m")
```

## Codes

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```