---
title: "Figure Draft - Three plots version"
author: "Xinyi Lin"
date: "3/12/2022"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
knitr::opts_chunk$set(fig.width=12, fig.height=7)
```

```{r,message=FALSE,warning=FALSE}
#library(splatter)
library(Seurat)
library(speckle)
library(DCATS)
library(ggplot2)
library(tidyverse)
library(MCMCpack)
library(pROC)
library(patchwork)
library(ggpubr)
library(lattice)
```

```{r}
source("functionsV2.r")
options(future.globals.maxSize = 20000 * 1024^2) # 20G memory
```

```{r}
theme_set(theme_classic()+
            theme(panel.border = element_blank(),
          legend.key = element_blank(),
          axis.ticks = element_blank(),
          panel.grid = element_blank(),
          panel.grid.minor = element_blank(), 
          panel.grid.major = element_blank(),
          panel.background = element_blank(),
          legend.background = element_blank(),
          plot.background = element_rect(fill = "transparent",colour = NA)) + 
            theme(axis.text=element_text(size=12), axis.title=element_text(size=13))+
            theme(legend.title = element_text(size=13), #change legend title font size
                  legend.text = element_text(size=10)))
theme_set(theme_classic()+
            theme(panel.border = element_blank(),
          legend.key = element_blank(),
          axis.ticks = element_blank(),
          panel.grid = element_blank(),
          panel.grid.minor = element_blank(), 
          panel.grid.major = element_blank(),
          panel.background = element_blank(),
          legend.background = element_blank(),
          plot.background = element_rect(fill = "transparent",colour = NA)) + 
            theme(axis.text=element_text(size=12), axis.title=element_text(size=13))+
            theme(strip.text.x = element_text(size = 13), strip.text.y = element_text(size = 13)) +
            theme(plot.title = element_text(size = 13),plot.subtitle = element_text(size = 13)) +
            theme(legend.title = element_text(size=13), #change legend title font size
                  legend.text = element_text(size=10)) + 
  theme(plot.title = element_text(hjust = 0.5)))
```

## Bias Correction validation

Supplementary figures

```{r}
load("/storage/holab/linxy/DCATS/real_world/Kaufmann_2021/further_subset.RData")
p1 = DimPlot(Kaufmann2021_subset2, group.by = 'clusterRes') + ggtitle("Cell type annotation")
p2 = DimPlot(Kaufmann2021_subset2) + ggtitle("Seurat clustering")
p1 + p2
#ggsave("./plot/version2/bias_corretion_validate.png", bg = "transparent")
```

```{r}
load("/storage/holab/linxy/DCATS/real_world/Kaufmann_2021/Kaufmann2021Res.RData")
Kaufmann2021L$proportionDF %>% as.matrix() %>% t() %>% as.data.frame()
rmseDF = Kaufmann2021L$rmseL %>% unlist() %>% as.data.frame()
print(rmseDF)
colnames(rmseDF) = "rmse"
p2b = rmseDF %>% rownames_to_column("proportion") %>% 
  arrange(desc(rmse)) %>% 
  mutate(proportion = c("noBiasCorrection","BC (svm)", "BC (knn)", "BC (true)"),
         proportion = factor(proportion, levels = c("noBiasCorrection","BC (svm)", "BC (knn)", "BC (true)"))) %>% 
  ggplot(aes(x = proportion, y = rmse, fill = proportion)) +
  geom_bar(stat = "identity") +
  NoLegend()+
  ylab("Root mean square error") + 
  theme(axis.title.x = element_blank())
p2b
```

```{r}
(p1 + p2)/(p2b + p2b)
ggsave("./plot/bias_correction.png", bg = "transparent")
```


### Figure 1 - B

```{r}
load("/storage/holab/linxy/DCATS/simulation/toy_simulation.RData")
prop_cond1M = numb_cond1M[2:nrow(numb_cond1M),]/2000
prop_cond2M = numb_cond2M[2:nrow(numb_cond2M),]/2000
prop_cond1BCM = numb_cond1BCM[2:nrow(numb_cond1BCM),]/2000
prop_cond2BCM = numb_cond2BCM[2:nrow(numb_cond2BCM),]/2000
prop_true1M = true_cond1M[2:nrow(true_cond1M),]/2000
prop_true2M = true_cond2M[2:nrow(true_cond2M),]/2000
cond1DF = rbind(prop_cond1M, prop_cond1BCM, prop_cond2M, prop_cond2BCM, prop_true1M, prop_true2M) %>% as.data.frame() %>% 
  mutate(state = c(rep("Observed cell proportions", nrow(numb_cond1M)-1), rep("Corrected cell proportions", nrow(numb_cond1BCM)-1), rep("Observed cell proportions", nrow(numb_cond2M)-1), rep("Corrected cell proportions", nrow(numb_cond2BCM)-1), rep("True cell proportions", nrow(prop_true1M) + nrow(prop_true2M))),
         cond = c(rep("Condition 1", nrow(numb_cond1M) + nrow(numb_cond1BCM) -2), rep("Condition 2", nrow(numb_cond2M) + nrow(numb_cond2BCM) -2), rep("Condition 1", nrow(prop_true1M)), rep("Condition 2", nrow(prop_true2M)))) %>% 
  mutate(state = factor(state, levels = c("True cell proportions", "Observed cell proportions", "Corrected cell proportions")))
colnames(cond1DF) = c("A", "B", "C", "state", "cond")
```

```{r}
## this is the figure we want to use in the main text
sim_prop = cond1DF %>% 
  filter(state != "Corrected cell proportions") %>% 
  pivot_longer(A:C, names_to = "cellType", values_to = "proportion") %>% 
  ggplot(aes(cellType, proportion)) + 
  geom_boxplot(aes(col = cellType)) +
  facet_grid(cond~state) + 
  theme(legend.position = "none") +
  xlab("cell type")
sim_prop
```

```{r}
sim1_prop = cond1DF %>% 
  pivot_longer(A:C, names_to = "cellType", values_to = "proportion") %>% 
  ggplot(aes(cellType, proportion)) + 
  geom_boxplot(aes(col = cellType)) +
  facet_grid(cond~state) + 
  theme(legend.position = "none") +
  xlab("cell type")
sim1_prop
ggsave("./plot/sim1_proportion.png", bg = "transparent")
```

### Figure 2 - C

```{r}
evaluationDF = data.frame()
len = length(simulationDF_list)
#for (j in 1:8){
for (j in 1:len){
  simulationDF = simulationDF_list[[j]] %>% na.omit()
  method = colnames(simulationDF)[3:dim(simulationDF)[2]]
  numb_mthd = length(method)
  sensitivity = rep(NA, numb_mthd)
  specificity = rep(NA, numb_mthd)
  mcc = rep(NA, numb_mthd)
  auc = rep(NA, numb_mthd)
  prauc = rep(NA, numb_mthd)
  F1 = rep(NA, numb_mthd)
  
  truth = simulationDF$truth
  for (i in 3:dim(simulationDF)[2]){
    pred = simulationDF[, i]
    pred_res = ifelse(pred < 0.05, "P", "N")
    TP <- sum(pred_res=="P"&truth=="P")
    TN <- sum(pred_res=="N"&truth=="N")
    FP <- sum(pred_res=="P"&truth=="N")
    FN <- sum(pred_res=="N"&truth=="P")
    truthN = TN + FP
    truthP = FN + TP
    predP = TP + FP
    predN = FN + TN
    sensitivity[i-2] = TP/truthP
    specificity[i-2] = TN/truthN
    mcc[i-2] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
    auc[i-2] = getROC(truth, pred)$auc
    prauc[i-2] = getPRC(truth, pred)$prauc
    F1 = 2*TP/(2*TP+FP+FN)
    
    res = data.frame(trial = as.character(j), method = method, sensitivity = sensitivity, specificity = specificity, mcc = mcc, auc = auc, prauc = prauc, F1 = F1)
    }
    evaluationDF = rbind(evaluationDF, res)
}
```

```{r}
sim1_main = evaluationDF %>% 
  tidyr::separate(method, c("method", "condition"), sep = "_") %>% 
  dplyr::select(-sensitivity, -specificity) %>% 
  filter(condition != "test") %>% 
  filter(method %in% c("estPhi", "fisher")) %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method),
         method = ifelse(method == "estPhi", "DCATS", method)) %>% 
  ggplot(aes(x = condition, y = mcc, color = method)) + geom_boxplot() +
  scale_color_manual(values=c("#F8766D", "#00BFC4")) +
  theme(axis.title.x = element_blank()) + 
  theme(legend.position = "top") +
  ylab("MCC") +
  scale_x_discrete(labels=c("null" = "No bias correction", "withBC" = "With bias correction")) 
sim1_main
ggsave("./plot/sim1_main.png", bg = "transparent")
```

Simulation 1: Supplementary Plots

```{r}
evaluationDF %>% 
  tidyr::separate(method, c("method", "condition"), sep = "_") %>% 
  dplyr::select(-sensitivity, -specificity) %>% 
  filter(condition != "test") %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method),
         method = factor(method, levels = c("wtoPhi", "adjPhi", "avrgPhi", "estPhi", "Fisher"))) %>% 
  ggplot(aes(x = condition, y = auc, color = method)) + geom_boxplot() +
  theme(axis.title.x = element_blank()) + 
  ylab("AUC") +
  scale_x_discrete(labels=c("null" = "No bias correction", "withBC" = "With bias correction"))
ggsave("./plot/sim1_allAUC.png", bg = "transparent")
```

```{r}
evaluationDF %>% 
  tidyr::separate(method, c("method", "condition"), sep = "_") %>% 
  filter(condition != "test") %>% 
  dplyr::select(-auc, -prauc) %>% 
  pivot_longer(
    sensitivity:mcc,
    names_to = "statistics", 
    values_to = "value") %>% 
  mutate(condition = ifelse(condition == "null", "noBC", condition)) %>%
  ggplot(aes(x = condition, y = value, color = method)) + geom_boxplot() + facet_grid(.~statistics) +
  ylab("Value") +
    theme(axis.title.x = element_blank())
ggsave("./plot/sim1_statistics.png", bg = "transparent")
```

```{r}
supA1 = phiDF %>% 
  ggplot(aes(x = eachPhi1, y = estPhi1)) +
  geom_point(aes(col = cluster), size = 0.5) + 
  theme(legend.position = "none") +
  xlab("eachPhi (no BC)") +
  ylab("estPhi (no BC)")
supA2 = phiDF %>% 
  ggplot(aes(x = eachPhi2, y = estPhi2)) +
  geom_point(aes(col = cluster), size = 0.5) +
  theme(legend.position = "none") +
  xlab("eachPhi (with BC)") +
  ylab("estPhi (with BC)")
supA3 = phiDF %>% 
  ggplot(aes(x = eachPhi1, y = eachPhi2)) +
  geom_point(aes(col = cluster), size = 0.5) +
  theme(legend.position = "none") +
  xlab("eachPhi (no BC)") +
  ylab("eachPhi (with BC)")
supA4 = phiDF %>% 
  ggplot(aes(x = estPhi1, y = estPhi2)) +
  geom_point(aes(col = cluster), size = 0.5) +
  theme(legend.position = "bottom") +
  xlab("estPhi (no BC)") +
  ylab("estPhi (with BC)")
(supA1 + supA2)/(supA3 + supA4)
ggsave("./plot/sim1_phi.png", bg = "transparent", width = 8, height = 5)
```

```{r}
sim_prop + sim1_main
ggsave("./plot/version2/Fig1.png", bg = "transparent", width = 12, height = 10)
```

## Figure 2

### Figure 2-A

The Distribution of cell pool

```{r}
#load("D:/Data/DCATS/cells_pool8_splatter.RData")
load("/storage/holab/linxy/DCATS/cells_pool8_splatter.RData")
```

```{r}
seuratObj <- CreateSeuratObject(counts = sim_mat, project="Splatter")
seuratObj <- NormalizeData(seuratObj, verbose = FALSE)
seuratObj <- FindVariableFeatures(seuratObj, selection.method = "vst", nfeatures = 2000, verbose = FALSE)
seuratObj <- ScaleData(seuratObj)
seuratObj <- RunPCA(seuratObj, features = VariableFeatures(object = seuratObj))
seuratObj <- FindNeighbors(seuratObj, dims = 1:30, verbose = FALSE)
seuratObj <- FindClusters(seuratObj, resolution = 0.5, verbose = FALSE)
seuratObj <- RunUMAP(seuratObj, dims = 1:30, verbose = FALSE)
seuratObj[['orig.ident']] <- origLabels
DimPlot(seuratObj, reduction = "umap")
p1 = DimPlot(seuratObj, reduction = "umap", group.by = "orig.ident") + theme(legend.position="none") + ggtitle("Simulation data (8 Cell Types)")
```

```{r}
#load("D:/Data/DCATS/cells_pool10_splatter.RData")
load("/storage/holab/linxy/DCATS/cells_pool10_splatter.RData")
```

```{r}
seuratObj <- CreateSeuratObject(counts = sim_mat, project="Splatter")
seuratObj <- NormalizeData(seuratObj, verbose = FALSE)
seuratObj <- FindVariableFeatures(seuratObj, selection.method = "vst", nfeatures = 2000, verbose = FALSE)
seuratObj <- ScaleData(seuratObj)
seuratObj <- RunPCA(seuratObj, features = VariableFeatures(object = seuratObj))
seuratObj <- FindNeighbors(seuratObj, dims = 1:30, verbose = FALSE)
seuratObj <- FindClusters(seuratObj, resolution = 0.5, verbose = FALSE)
seuratObj <- RunUMAP(seuratObj, dims = 1:30, verbose = FALSE)
seuratObj[['orig.ident']] <- origLabels
DimPlot(seuratObj, reduction = "umap")
p2 = DimPlot(seuratObj, reduction = "umap", group.by = "orig.ident") + theme(legend.position="none", axis.title.y = element_blank())  + ggtitle("Simulation data (10 Cell Types)")
```

```{r}
#load("D:/Data/DCATS/cells_pool12_splatter.RData")
load("/storage/holab/linxy/DCATS/cells_pool12_splatter.RData")
```

```{r}
seuratObj <- CreateSeuratObject(counts = sim_mat, project="Splatter")
seuratObj <- NormalizeData(seuratObj, verbose = FALSE)
seuratObj <- FindVariableFeatures(seuratObj, selection.method = "vst", nfeatures = 2000, verbose = FALSE)
seuratObj <- ScaleData(seuratObj)
seuratObj <- RunPCA(seuratObj, features = VariableFeatures(object = seuratObj))
seuratObj <- FindNeighbors(seuratObj, dims = 1:30, verbose = FALSE)
seuratObj <- FindClusters(seuratObj, resolution = 0.5, verbose = FALSE)
seuratObj <- RunUMAP(seuratObj, dims = 1:30, verbose = FALSE)
seuratObj[['orig.ident']] <- origLabels
DimPlot(seuratObj, reduction = "umap")
p3 = DimPlot(seuratObj, reduction = "umap", group.by = "orig.ident") + theme(legend.position="none", axis.title.y = element_blank()) + ggtitle("Simulation data (12 Cell Types)")
```

```{r}
p1 + p2 + p3
ggsave("./plot/sim2_cellpool.png", bg = "transparent", width = 12, height = 4)
```

```{r}
#load("/storage/holab/linxy/DCATS/simulation/current/replicates3&3_K8_con100_splatter3000&3000para.RData")
load("/Users/linxy29/Documents/Data/DCATS/simulation/current/replicates3&3_K8_con100_splatter3000&3000para.RData")
```

Draw the proportion of different cell types and ROC curves

```{r}
clusterRes = data.frame()
seurat_count = data_frame()
true_count = data.frame()
for (idx in 1:length(oper)){
    if (!is.na(oper[[idx]][1])) {
      clusterRes = rbind(clusterRes, oper[[idx]]$clusterDF)
      oper[[idx]]$seurat_count$cond1 = oper[[idx]]$seurat_count$cond1 %>% 
        mutate(condition = "Condition 1")
      oper[[idx]]$seurat_count$cond2 = oper[[idx]]$seurat_count$cond2 %>% 
        mutate(condition = "Condition 2")
      seurat_count = rbind(seurat_count, oper[[idx]]$seurat_count$cond1)
      seurat_count = rbind(seurat_count, oper[[idx]]$seurat_count$cond2)
      oper[[idx]]$true_count = oper[[idx]]$true_count %>% as.data.frame() %>% mutate(condition = c(rep("Condition 1", 3), rep("Condition 2", 3)))
      true_count = rbind(true_count, oper[[idx]]$true_count)
      }
}
colnames(seurat_count) = c("P1", "P2", "N1", "N2", "N3", "P3", "N4", "P4", "condition")
colnames(true_count) = c("P1", "P2", "N1", "N2", "N3", "P3", "N4", "P4", "condition")
```

```{r}
sim2_prop = true_count %>% 
  pivot_longer(P1:P4, names_to = "cellType", values_to = "count") %>% 
  mutate(proportion = count/3000) %>% 
  ggplot(aes(cellType, proportion)) +
  geom_boxplot(aes(col = condition)) +
  theme(legend.position = "top") + 
  xlab("Cell type")
sim2_prop
ggsave("./plot/sim2_trueCount_dist.png", bg = "transparent", width = 10, height = 4)
```

```{r}
seurat_count %>% 
  pivot_longer(P1:P4, names_to = "cellType", values_to = "count") %>% 
  mutate(proportion = count/3000) %>% 
  ggplot(aes(cellType, proportion)) +
  geom_boxplot(aes(col = condition)) +
  theme(legend.position = "top") + 
  xlab("Cell type")
ggsave("./plot/sim2_seuratCount_dist.png", bg = "transparent", width = 10, height = 4)
```

```{r}
clusterRes = clusterRes %>% 
    mutate(milo_main = ifelse(milo_less > milo_more, milo_less, milo_more),
           milo_pct = milo_main/(milo_less + neutral + milo_more),
           milo_diff = abs(milo_less - milo_more)) %>% 
    dplyr::select(-milo_less, -milo_more, - neutral, -milo_main)
```

```{r}
prauc_dcats = getPRC(clusterRes$truth, clusterRes$estPhi_emK_pvals)$df %>% 
  mutate(fdr = 1-precision) %>% 
  dplyr::select(recall, fdr, precision) %>% 
  mutate(method = "DCATS")
prauc_fisher = getPRC(clusterRes$truth, clusterRes$fisher_pvals)$df %>% 
  mutate(fdr = 1-precision) %>% 
  dplyr::select(recall, fdr, precision) %>% 
  mutate(method = "fisher")
prauc_scDC = getPRC(clusterRes$truth, clusterRes$scDC_pvals)$df %>% 
  mutate(fdr = 1-precision) %>% 
  dplyr::select(recall, fdr, precision) %>% 
  mutate(method = "scDC")
prauc_speckle = getPRC(clusterRes$truth, clusterRes$speckle_pvals)$df %>% 
  mutate(fdr = 1-precision) %>% 
  dplyr::select(recall, fdr, precision) %>% 
  mutate(method = "speckle")
prauc_diffcyt = getPRC(clusterRes$truth, clusterRes$diffcyt_pvals)$df %>% 
  mutate(fdr = 1-precision) %>% 
  dplyr::select(recall, fdr, precision) %>% 
  mutate(method = "diffcyt")
prauc_milo = getPRC(clusterRes$truth, clusterRes$milo_pct)$df %>% 
  mutate(fdr = 1-precision) %>% 
  dplyr::select(recall, fdr, precision) %>% 
  mutate(method = "milo")
prauc_ancombc = getPRC(clusterRes$truth, clusterRes$ancombc_pvals)$df %>% 
  mutate(fdr = 1-precision) %>% 
  dplyr::select(recall, fdr, precision) %>% 
  mutate(method = "ancombc")
prauc_ancombc_bs = getPRC(clusterRes$truth, clusterRes$ancombc_knn_pvals)$df %>% 
  mutate(fdr = 1-precision) %>% 
  dplyr::select(recall, fdr, precision) %>% 
  mutate(method = "bcancombc")

praucDF = rbind(prauc_dcats, prauc_fisher, prauc_scDC, prauc_speckle, prauc_diffcyt, prauc_milo, prauc_ancombc, prauc_ancombc_bs)
```

```{r}
prcurve = praucDF %>% 
  arrange(desc(recall)) %>% 
  ggplot(aes(x = fdr, y = recall, color = method)) +
    geom_line(orientation = "y", size = 1) +
  geom_vline(xintercept = 0.05, linetype = "dotted") +
  xlab("False discovery rate") +
  ylab("True positive rate")
prcurve
```

```{r}
boxplot = praucDF %>% 
  mutate(group = ifelse(fdr<=0.1, "0.1", "1"),
         group = ifelse(fdr>0.1&fdr<=0.2, "0.2", group),
         group = ifelse(fdr>0.2&fdr<=0.3, "0.3", group),
         group = ifelse(fdr>0.3&fdr<=0.4, "0.4", group),
         group = ifelse(fdr>0.4&fdr<=0.5, "0.5", group),
         group = ifelse(fdr>0.5&fdr<=0.6, "0.6", group),
         group = ifelse(fdr>0.6&fdr<=0.7, "0.7", group),
         group = ifelse(fdr>0.7&fdr<=0.8, "0.8", group)) %>% 
  arrange(desc(recall)) %>% 
  ggplot(aes(x = group, y = recall, color = method)) +
  geom_boxplot() +
  xlab("False discovery rate") +
  ylab("True positive rate")
boxplot
```

## calculate confidence interval

```{r}
res_bootstrap = data.frame()
set.seed(123)
for (idx in 1:50) {
  sampleID = sample(1:nrow(clusterRes), nrow(clusterRes), replace = TRUE)
  clusterResNew = clusterRes[sampleID,]
  methods = colnames(clusterResNew)[colnames(clusterResNew) %>% str_detect("_pvals")] %>% str_remove("_pvals")
  methods = c(methods, "milo")
  numb_mthd = length(methods)
  mcc = rep(NA, numb_mthd)
  auc = rep(NA, numb_mthd)
  prauc = rep(NA, numb_mthd)
  sensitivity = rep(NA, numb_mthd)
  specificity = rep(NA, numb_mthd)
  precision = rep(NA, numb_mthd)
  F1 = rep(NA, numb_mthd)
  truth = clusterResNew$truth
  for (i in 3:(dim(clusterResNew)[2]-1)){
    pred = clusterResNew[,i]
    if (colnames(clusterResNew)[i] == "milo_pct") {
      pred_res = ifelse(clusterResNew$milo_diff > 0, "P", "N")
      auc[i-2] = getROC(clusterResNew$truth, 1-pred)$auc
      prauc[i-2] = getPRC(clusterResNew$truth, 1-pred)$prauc}
    else {
      pred_res = ifelse(pred < 0.1, "P", "N")
      auc[i-2] = getROC(clusterResNew$truth, pred)$auc
      prauc[i-2] = getPRC(clusterResNew$truth, pred)$prauc}
    TP <- sum(pred_res=="P"&truth=="P")
    TN <- sum(pred_res=="N"&truth=="N")
    FP <- sum(pred_res=="P"&truth=="N")
    FN <- sum(pred_res=="N"&truth=="P")
    truthN = TN + FP
    truthP = FN + TP
    predP = TP + FP
    predN = FN + TN
    sensitivity[i-2] = TP/truthP
    specificity[i-2] = TN/truthN
    precision[i-2] = TP/predP
    mcc[i-2] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
    F1[i-2] = 2*TP/(2*TP+FP+FN)
    }
  res = data.frame(method = methods, mcc = mcc, auc = auc, prauc = prauc, sensitivity = sensitivity, specificity = specificity, precision = precision, F1 = F1) %>% 
    mutate(bootstrapID = idx)
  res_bootstrap = rbind(res_bootstrap, res)
  }
```

```{r}
cluster8_CI = res_bootstrap %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_emK", "DCATS", method)) %>% 
  mutate(method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>% 
  select(method, mcc, prauc, F1, auc) %>% 
  pivot_longer(mcc:auc, names_to = "statistics", values_to = "value") %>% 
  mutate(statistics = factor(statistics, levels = c("mcc", "F1", "auc", "prauc"))) %>% 
  ggplot(aes(x = statistics, y = value, color = method)) +
  geom_boxplot() +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank()) +
  theme(legend.position = "top")
cluster8_CI
```


### Figure 2-B

#### Different numbers of replicates

```{r}
## cluster number = 8
filenames = list.files("/Users/linxy29/Documents/Data/DCATS/simulation/current", full.names = TRUE)
#filenames = list.files("/storage/holab/linxy/DCATS/simulation/current", full.names = TRUE)
filenames = filenames[grep("_K8_con100_splatter3000&3000para", filenames)]
filenames
```

```{r, warning=TRUE}
res_all = data.frame()

for (file in filenames) {
  load(file)
  methods = colnames(oper[[1]]$clusterDF)[colnames(oper[[1]]$clusterDF) %>% str_detect("_pvals")] %>% str_remove("_pvals")
  methods = c(methods, "milo")
  numb_mthd = length(methods)
  mcc = rep(NA, numb_mthd)
  auc = rep(NA, numb_mthd)
  prauc = rep(NA, numb_mthd)
  sensitivity = rep(NA, numb_mthd)
  specificity = rep(NA, numb_mthd)
  precision = rep(NA, numb_mthd)
  F1 = rep(NA, numb_mthd)
  clusterRes = data.frame()
  nhoodRes = data.frame()
  for (idx in 1:length(oper)){
    if (!is.na(oper[[idx]][1])) {clusterRes = rbind(clusterRes, oper[[idx]]$clusterDF)}
    if (!is.na(oper[[idx]][1])) {nhoodRes = rbind(nhoodRes, oper[[idx]]$nhoodDF)}
    }
  truth = clusterRes$truth
  clusterRes = clusterRes %>% 
    mutate(milo_main = ifelse(milo_less > milo_more, milo_less, milo_more),
           milo_pct = milo_main/(milo_less + neutral + milo_more),
           milo_diff = abs(milo_less - milo_more)) %>% 
    dplyr::select(-milo_less, -milo_more, - neutral, -milo_main)
  for (i in 3:(dim(clusterRes)[2]-1)){
    pred = clusterRes[,i]
    if (colnames(clusterRes)[i] == "milo_pct") {
      pred_res = ifelse(clusterRes$milo_diff > 0, "P", "N")
      auc[i-2] = getROC(clusterRes$truth, 1-pred)$auc
      prauc[i-2] = getPRC(clusterRes$truth, 1-pred)$prauc}
    else {
      pred_res = ifelse(pred < 0.1, "P", "N")
      auc[i-2] = getROC(clusterRes$truth, pred)$auc
      prauc[i-2] = getPRC(clusterRes$truth, pred)$prauc}
    TP <- sum(pred_res=="P"&truth=="P")
    TN <- sum(pred_res=="N"&truth=="N")
    FP <- sum(pred_res=="P"&truth=="N")
    FN <- sum(pred_res=="N"&truth=="P")
    truthN = TN + FP
    truthP = FN + TP
    predP = TP + FP
    predN = FN + TN
    sensitivity[i-2] = TP/truthP
    specificity[i-2] = TN/truthN
    precision[i-2] = TP/predP
    #mcc[i-2] = sqrt(sensitivity[i]*specificity[i]*precision[i]*(TN/(TN+FN))) - sqrt((1-sensitivity[i])*(1-specificity[i])*(FN/predN)*(FP/predP))
    mcc[i-2] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
    F1[i-2] = 2*TP/(2*TP+FP+FN)
    }
  res = data.frame(method = methods, mcc = mcc, auc = auc, prauc = prauc, sensitivity = sensitivity, specificity = specificity, precision = precision, F1 = F1) %>% 
    arrange(desc(prauc)) %>% 
    mutate(replicates = str_extract(file, "\\d&\\d"))
  res_all = rbind(res_all, res)
  }

res_all %>% 
  filter(method %in% c("estPhi_null", "estPhi_emK", "estPhi_emU", "fisher", "speckle", "diffcyt", "betabin_null", "wtoPhi_emK", "scDC", "milo", "ancombc", "ancombc_knn")) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  arrange(replicates, desc(auc)) %>% 
  dplyr::select(method, mcc, auc, sensitivity, specificity, F1, replicates) %>% 
  mutate(mcc = round(mcc, 3),
         auc = round(auc, 3),
         sensitivity = round(sensitivity, 3),
         specificity = round(specificity, 3),
         F1 = round(F1, 3))
```

```{r, eval=FALSE}
sim2_auc = ggroc(list(DCATS=rocobj_dcats, Fisher=rocobj_fisher, diffcyt=rocobj_diffcyt, speckle=rocobj_speckle, scDC=rocobj_scDC, milo=rocobj_milo))+
  geom_point(aes(x=0.926, y=0.685), colour="black", shape = 4) +
  geom_point(aes(x=0.954, y=0.509), colour="black", shape = 4) +
  geom_point(aes(x=0.944, y=0.509), colour="black", shape = 4) +
  geom_point(aes(x=0.250, y=0.972), colour="black", shape = 4) +
  geom_point(aes(x=0.750, y=0.630), colour="black", shape = 4) +
  geom_point(aes(x=0.333, y=0.861), colour="black", shape = 4) +
  labs(color='method')
sim2_auc
```

```{r, warning=FALSE, eval=FALSE}
sim2_mainAUC1 = res_all %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_emK", "DCATS", method)) %>% 
  mutate(method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>% 
  mutate(method = factor(method, level = c("DCATS", "speckle", "diffcyt", "Fisher", "bcancombc", "ancombc", "milo", "scDC"))) %>% 
  ggplot(aes(x = replicates, y = auc, color = method, group = method)) + 
  geom_point(shape = 0) +
  geom_line(size = 1.5)+
  xlab("# of replicates") +
  theme(legend.position = "none") + 
  ylab("AUC")
sim2_mainAUC1
```

```{r, warning=FALSE, eval=FALSE}
sim2_mainMCC1 = res_all %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_emK", "DCATS", method)) %>% 
  mutate(method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>% 
  mutate(method = factor(method, level = c("DCATS", "speckle", "diffcyt", "Fisher", "bcancombc", "ancombc", "milo", "scDC"))) %>% 
  ggplot(aes(x = replicates, y = mcc, color = method, group = method)) + 
  geom_point(shape = 0) +
  geom_line(size = 1.5)+
  xlab("# of Replicates") +
  theme(legend.position = "none") + 
  ylab("MCC")
sim2_mainMCC1
```

```{r}
short_order = c("scDC", "bcancombc", "ancombc", "Fisher", "milo", "diffcyt", "speckle", "DCATS")
sim2_mainHM1 = res_all %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_emK", "DCATS", method)) %>% 
  mutate(method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>% 
  mutate(method = factor(method, level = short_order)) %>% 
  #dplyr::select(method, auc, mcc, F1, replicates) %>% 
  #pivot_longer(auc:F1, names_to = "statistics", values_to = "value") %>% 
  dplyr::select(method, mcc, replicates) %>% 
  pivot_longer(mcc, names_to = "statistics", values_to = "value") %>% 
  group_by(replicates, statistics) %>% 
  mutate(order_pre = rank(round(value, 3)),
         value_order = 7-ceiling(rank(order_pre))) %>% 
  ggplot(aes(replicates, method)) +
    geom_tile(aes(fill = value)) + 
    geom_text(aes(label = round(value, 3))) +
  #scale_fill_distiller(palette = "RdYIBu") +
    scale_fill_gradient(low = "white", high = "red") +
  xlab("# of Replicates") +
  theme(axis.title.y = element_blank()) +
  theme(legend.position = "top") +
  facet_grid(.~statistics) + labs(fill='value') 
sim2_mainHM1
```

```{r}
sim2_mainHM2 = res_all %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_emK", "DCATS", method)) %>% 
  mutate(method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>% 
  mutate(method = factor(method, level = short_order)) %>% 
  #dplyr::select(method, auc, mcc, F1, replicates) %>% 
  #pivot_longer(auc:F1, names_to = "statistics", values_to = "value") %>% 
  dplyr::select(method, auc, replicates) %>% 
  pivot_longer(auc, names_to = "statistics", values_to = "value") %>% 
  group_by(replicates, statistics) %>% 
  mutate(order_pre = rank(round(value, 3)),
         value_order = 7-ceiling(rank(order_pre))) %>% 
  ggplot(aes(replicates, method)) +
    geom_tile(aes(fill = value)) + 
    geom_text(aes(label = round(value, 3))) +
  #scale_fill_distiller(palette = "RdYIBu") +
    scale_fill_gradient(low = "white", high = "red") +
  xlab("# of Replicates") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank()) +
  theme(legend.position = "top") +
  facet_grid(.~statistics) + labs(fill='value') 
sim2_mainHM2
```

Simulation 2: Supplementary Plots

```{r}
long_order = c("scDC", "ancombc", "bcancombc", "fisher", "milo", "diffcyt", "speckle", "wtoPhi_wtoEM", "wtoPhi_emK", "estPhi_wtoEM", "estPhi_emK")
sim2_statistics_replicates = res_all %>% 
  filter(method %in% c("scDC", "milo", "wtoPhi_emK", "betabin_null", "speckle", "diffcyt", "fisher", "estPhi_emK", "estPhi_null", "ancombc", "ancombc_knn")) %>%
  #mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method),
         method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>%
  mutate(method = factor(method, level = long_order)) %>% 
  dplyr::select(method, mcc, prauc, F1, auc, replicates) %>% 
  pivot_longer(mcc:auc, names_to = "statistics", values_to = "value") %>% 
  mutate(statistics = factor(statistics, levels = c("mcc", "prauc", "F1", "auc"))) %>% 
  group_by(replicates, statistics) %>% 
  mutate(order_pre = rank(round(value, 3)),
         value_order = 10-ceiling(rank(order_pre))) %>% 
  ggplot(aes(replicates, method)) +
    geom_tile(aes(fill = value)) + 
    geom_text(aes(label = round(value, 3))) +
    scale_fill_gradient(low = "white", high = "red") +
  xlab("# of Replicates") +
  theme(axis.title.y = element_blank()) +
  facet_grid(.~statistics) + labs(fill='value')
sim2_statistics_replicates
#ggsave("./plot/sim2_statistics_replicates.png", bg = "transparent")
```

Details of statistics value

```{r}
res_all %>% 
  filter(method %in% c("scDC", "milo", "wtoPhi_emK", "betabin_null", "speckle", "diffcyt", "fisher", "estPhi_emK", "estPhi_null", "ancombc", "ancombc_knn")) %>%
  #mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method),
         method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>%
  mutate(method = factor(method, level = long_order)) %>% 
  mutate(mcc = round(mcc, 3),
         auc = round(auc, 3),
         prauc = round(prauc, 3),
         F1 = round(F1, 3),
         sensitivity = round(sensitivity, 3),
         specificity = round(specificity, 3),
         precision = round(precision, 3)) %>% 
  arrange(replicates, desc(mcc)) %>% 
  knitr::kable()
```

nhoods level

```{r, eval=FALSE}
nhoodsRes_all = data.frame()

for (file in filenames) {
  load(file)
  nhoodRes = data.frame()
  for (idx in 1:length(oper)){
    if (!is.na(oper[[idx]])) {nhoodRes = rbind(nhoodRes, oper[[idx]]$nhoodDF)}
  }
  nhoodRes = nhoodRes %>% 
  dplyr::rename(milo_pvals = SpatialFDR) %>% 
  filter(ident_fraction > 0.8)  # get nhoods mainly contains one cell type -> 90%
  methods = colnames(nhoodRes)[colnames(nhoodRes) %>% str_detect("_pvals")] %>% str_remove("_pvals")
  numb_mthd = length(methods)
  mcc = rep(NA, numb_mthd)
  auc = rep(NA, numb_mthd)
  prauc = rep(NA, numb_mthd)
  sensitivity = rep(NA, numb_mthd)
  specificity = rep(NA, numb_mthd)
  precision = rep(NA, numb_mthd)
  F1 = rep(NA, numb_mthd)
  truth = nhoodRes$truth
  select_col = colnames(nhoodRes)[colnames(nhoodRes) %>% str_detect("_pvals")]
  for (i in 1:length(select_col)){
    pred = nhoodRes[,select_col[i]]
    auc[i] = getROC(truth[!is.na(pred)], pred[!is.na(pred)])$auc
    if (i == 1) {pred_res = ifelse(pred < 0.30, "P", "N")}
    else {pred_res = ifelse(pred < 0.10, "P", "N")}
    TP <- sum(pred_res[!is.na(pred_res)]=="P"&truth[!is.na(pred_res)]=="P")
    TN <- sum(pred_res[!is.na(pred_res)]=="N"&truth[!is.na(pred_res)]=="N")
    FP <- sum(pred_res[!is.na(pred_res)]=="P"&truth[!is.na(pred_res)]=="N")
    FN <- sum(pred_res[!is.na(pred_res)]=="N"&truth[!is.na(pred_res)]=="P")
    truthN = TN + FP
    truthP = FN + TP
    predP = TP + FP
    predN = FN + TN
    sensitivity[i] = TP/truthP
    specificity[i] = TN/truthN
    precision[i] = TP/predP
    mcc[i] = sqrt(sensitivity[i]*specificity[i]*precision[i]*(TN/(TN+FN))) - sqrt((1-sensitivity[i])*(1-specificity[i])*(FN/predN)*(FP/predP))
    #mcc[i] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
    F1[i] = 2*TP/(2*TP+FP+FN)
    prauc[i] = getPRC(truth[!is.na(pred)], pred[!is.na(pred)])$prauc
  }
  res = data.frame(method = methods, mcc = mcc, auc = auc, prauc = prauc, sensitivity = sensitivity, specificity = specificity, precision = precision, F1 = F1) %>% 
    arrange(desc(prauc)) %>% 
    mutate(replicates = str_extract(file, "\\d&\\d"))
  nhoodsRes_all = rbind(nhoodsRes_all, res)
}
save(nhoodsRes_all, file = "/storage/holab/linxy/DCATS/simulation/nhoodsRes_all_replicates.RData")
```

```{r}
load("/storage/holab/linxy/DCATS/simulation/nhoodsRes_all_replicates.RData")
nhoodsRes_all %>% 
  arrange(replicates, desc(auc)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  dplyr::select(method, mcc, auc, sensitivity, specificity, F1, replicates) %>% 
  mutate(mcc = round(mcc, 3),
         prauc = round(auc, 3),
         sensitivity = round(sensitivity, 3),
         specificity = round(specificity, 3),
         F1 = round(F1, 3))
```

```{r}
nhoodsH1_auc = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>% 
  dplyr::select(method, auc, replicates) %>% 
  ggplot(aes(replicates, method)) +
    geom_tile(aes(fill = auc)) + 
    geom_text(aes(label = round(auc, 3))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0.6,0.8)) +
  xlab("# of Replicates") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

nhoodsH1_mcc = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>%
  dplyr::select(method, mcc, replicates) %>% 
  ggplot(aes(replicates, method)) +
    geom_tile(aes(fill = mcc)) + 
    geom_text(aes(label = ifelse(is.na(mcc), "N.A.", as.character(round(mcc, 3))))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0,0.5)) +
  xlab("# of Replicates") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())

nhoodsH1_sensitivity = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>%
  dplyr::select(method, sensitivity, replicates) %>% 
  ggplot(aes(replicates, method)) +
    geom_tile(aes(fill = sensitivity)) + 
    geom_text(aes(label = round(sensitivity, 3))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0,0.6)) +
  xlab("# of Replicates")

nhoodsH1_specificity = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>%
  dplyr::select(method, specificity, replicates) %>% 
  ggplot(aes(replicates, method)) +
    geom_tile(aes(fill = specificity)) + 
    geom_text(aes(label = round(specificity, 3))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0.8,1)) +
  xlab("# of Replicates") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank())

nhoodsH1_precision = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>%
  dplyr::select(method, precision, replicates) %>% 
  ggplot(aes(replicates, method)) +
    geom_tile(aes(fill = precision)) + 
    geom_text(aes(label = ifelse(is.na(precision), "N.A.", as.character(round(precision, 3))))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0.7,1)) +
  xlab("# of Replicates") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank())

nhoodsH1_F1 = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>%
  dplyr::select(method, F1, replicates) %>% 
  ggplot(aes(replicates, method)) +
    geom_tile(aes(fill = F1)) + 
    geom_text(aes(label = round(F1, 3))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0,0.7)) +
  xlab("# of Replicates") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

nhoodsH1_mcc + nhoodsH1_F1 + nhoodsH1_auc + nhoodsH1_sensitivity + nhoodsH1_specificity + nhoodsH1_precision
ggsave("./plot/sim2_nhood1.png", bg = "transparent", width = 10, height = 6)
```

#### Different numbers of clusters

```{r}
## replicates number 3&3
filenames = list.files("/storage/holab/linxy/DCATS/simulation/current", full.names = TRUE)
#filenames = list.files("D:/Data/DCATS/simulation/clusterN", full.names = TRUE)
filenames = filenames[grep("replicates3&3", filenames)]
filenames
```

```{r, warning=FALSE}
res_all = data.frame()

for (file in filenames) {
  load(file)
  methods = colnames(oper[[1]]$clusterDF)[colnames(oper[[1]]$clusterDF) %>% str_detect("_pvals")] %>% str_remove("_pvals")
  methods = c(methods, "milo")
  numb_mthd = length(methods)
  mcc = rep(NA, numb_mthd)
  auc = rep(NA, numb_mthd)
  prauc = rep(NA, numb_mthd)
  sensitivity = rep(NA, numb_mthd)
  specificity = rep(NA, numb_mthd)
  precision = rep(NA, numb_mthd)
  F1 = rep(NA, numb_mthd)
  clusterRes = data.frame()
  nhoodRes = data.frame()
  for (idx in 1:length(oper)){
    if (!is.na(oper[[idx]])) {clusterRes = rbind(clusterRes, oper[[idx]]$clusterDF)}
    if (!is.na(oper[[idx]])) {nhoodRes = rbind(nhoodRes, oper[[idx]]$nhoodDF)}
    }
  truth = clusterRes$truth
  clusterRes = clusterRes %>% 
    mutate(milo_main = ifelse(milo_less > milo_more, milo_less, milo_more),
           milo_pct = milo_main/(milo_less + neutral + milo_more),
           milo_diff = abs(milo_less - milo_more)) %>% 
    dplyr::select(-milo_less, -milo_more, - neutral, -milo_main)
  for (i in 3:(dim(clusterRes)[2]-1)){
    pred = clusterRes[,i]
    if (colnames(clusterRes)[i] == "milo_pct") {
      pred_res = ifelse(clusterRes$milo_diff > 0, "P", "N")
      auc[i-2] = getROC(clusterRes$truth, 1-pred)$auc
      prauc[i-2] = getPRC(clusterRes$truth, 1-pred)$prauc}
    else {
      pred_res = ifelse(pred < 0.1, "P", "N")
      auc[i-2] = getROC(clusterRes$truth, pred)$auc
      prauc[i-2] = getPRC(clusterRes$truth, pred)$prauc}
    TP <- sum(pred_res=="P"&truth=="P")
    TN <- sum(pred_res=="N"&truth=="N")
    FP <- sum(pred_res=="P"&truth=="N")
    FN <- sum(pred_res=="N"&truth=="P")
    truthN = TN + FP
    truthP = FN + TP
    predP = TP + FP
    predN = FN + TN
    sensitivity[i-2] = TP/truthP
    specificity[i-2] = TN/truthN
    precision[i-2] = TP/predP
    #mcc[i-2] = sqrt(sensitivity[i]*specificity[i]*precision[i]*(TN/(TN+FN))) - sqrt((1-sensitivity[i])*(1-specificity[i])*(FN/predN)*(FP/predP))
    mcc[i-2] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
    F1[i-2] = 2*TP/(2*TP+FP+FN)
    }
  res = data.frame(method = methods, mcc = mcc, auc = auc, prauc = prauc, sensitivity = sensitivity, specificity = specificity, precision = precision, F1 = F1) %>% 
    arrange(desc(auc)) %>% 
    mutate(clustersN = str_extract(file, "K\\d\\d"))
  res_all = rbind(res_all, res)
}

res_all = res_all %>% 
  mutate(clustersN = ifelse(is.na(clustersN), "K8", clustersN),
         clustersN = str_remove(clustersN, "K"),
         clustersN = factor(clustersN, levels = c("8", "10", "12")))

res_all %>% 
  filter(method %in% c("estPhi_null", "estPhi_emK", "fisher", "speckle", "diffcyt", "betabin_null", "wtoPhi_emK", "scDC", "milo")) %>% 
  arrange(clustersN, desc(auc)) %>% 
  dplyr::select(method, mcc, auc, sensitivity, specificity, F1, clustersN) %>% 
  mutate(mcc = round(mcc, 3),
         auc = round(auc, 3),
         sensitivity = round(sensitivity, 3),
         specificity = round(specificity, 3),
         F1 = round(F1, 3))
```

```{r, warning=FALSE, eval=FALSE}
sim2_mainAUC2 = res_all %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_emK", "DCATS", method)) %>% 
  mutate(method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>% 
  mutate(method = factor(method, level = c("DCATS", "speckle", "diffcyt", "Fisher", "milo", "bcancombc", "ancombc", "scDC"))) %>% 
  ggplot(aes(x = clustersN, y = auc, color = method, group = method)) + 
  geom_point(shape = 0) +
  geom_line(size = 1.5)+
  xlab("# of Cell Types") + 
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())
sim2_mainAUC2
```

```{r, warning=FALSE, eval=FALSE}
sim2_mainMCC2 = res_all %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_emK", "DCATS", method)) %>% 
  mutate(method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>% 
  mutate(method = factor(method, level = c("DCATS", "speckle", "diffcyt", "Fisher", "milo", "bcancombc", "ancombc", "scDC"))) %>% 
  ggplot(aes(x = clustersN, y = mcc, color = method, group = method)) + 
  geom_point(shape = 0) +
  geom_line(size = 1.5)+
  xlab("# of Cell Types") + 
  theme(axis.title.y = element_blank())
sim2_mainMCC2
```

```{r}
sim2_mainHM3 = res_all %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_emK", "DCATS", method)) %>% 
  mutate(method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>% 
  mutate(method = factor(method, level = short_order)) %>% 
  #dplyr::select(method, auc, mcc, F1, clustersN) %>% 
  #pivot_longer(auc:F1, names_to = "statistics", values_to = "value") %>% 
  dplyr::select(method, mcc, clustersN) %>% 
  pivot_longer(mcc, names_to = "statistics", values_to = "value") %>% 
  group_by(clustersN, statistics) %>% 
  mutate(order_pre = rank(round(value, 3)),
         value_order = 7-ceiling(rank(order_pre))) %>% 
  ggplot(aes(clustersN, method)) +
    geom_tile(aes(fill = value)) + 
    geom_text(aes(label = round(value, 3))) +
  #scale_fill_distiller(palette = "RdYIBu") +
    scale_fill_gradient(low = "white", high = "red") +
  xlab("# of cell types") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "top") +
  facet_grid(.~statistics) + labs(fill='value')
sim2_mainHM3
```

```{r}
sim2_mainHM4 = res_all %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_emK", "DCATS", method)) %>% 
  mutate(method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>% 
  mutate(method = factor(method, level = short_order)) %>% 
  #dplyr::select(method, auc, mcc, F1, clustersN) %>% 
  #pivot_longer(auc:F1, names_to = "statistics", values_to = "value") %>% 
  dplyr::select(method, auc, clustersN) %>% 
  pivot_longer(auc, names_to = "statistics", values_to = "value") %>% 
  group_by(clustersN, statistics) %>% 
  mutate(order_pre = rank(round(value, 3)),
         value_order = 7-ceiling(rank(order_pre))) %>% 
  ggplot(aes(clustersN, method)) +
    geom_tile(aes(fill = value)) + 
    geom_text(aes(label = round(value, 3))) +
  #scale_fill_distiller(palette = "RdYIBu") +
    scale_fill_gradient(low = "white", high = "red") +
  xlab("# of cell types") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        legend.position = "top") +
  facet_grid(.~statistics) + labs(fill='value')
sim2_mainHM4
```

Simulation 2: Supplementary Plot

```{r}
sim2_statistics_clustersN = res_all %>% 
  filter(method %in% c("scDC", "milo", "wtoPhi_emK", "betabin_null", "speckle", "diffcyt", "fisher", "estPhi_emK", "estPhi_null")) %>%
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = long_order)) %>% 
  dplyr::select(method, auc, prauc, mcc, F1, clustersN) %>% 
  pivot_longer(auc:F1, names_to = "statistics", values_to = "value") %>% 
  group_by(clustersN, statistics) %>% 
  mutate(statistics = factor(statistics, levels = c("mcc", "prauc", "F1", "auc"))) %>% 
  mutate(order_pre = rank(round(value, 3)),
         value_order = 10-ceiling(rank(order_pre))) %>% 
  ggplot(aes(clustersN, method)) +
    geom_tile(aes(fill = value)) + 
    geom_text(aes(label = round(value, 3))) +
    scale_fill_gradient(low = "white", high = "red") +
  xlab("# of cell types") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank()) +
  facet_grid(.~statistics) + labs(fill='value') 
sim2_statistics_clustersN
#ggsave("./plot/sim2_statistics_clustersN.png", bg = "transparent")
```

```{r}
sim2_statistics_replicates + theme(legend.position = "none") + sim2_statistics_clustersN
ggsave("./plot/sim2_statistics.png", bg = "transparent", height = 8, width = 16)
```


Details of statistics value

```{r}
res_all %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "betabin_null", "estPhi_null", "wtoPhi_emK", "estPhi_emK", "milo", "ancombc", "ancombc_knn")) %>%
  #mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method),
         method = ifelse(method == "ancombc_knn", "bcancombc", method)) %>% 
  mutate(method = factor(method, level = long_order)) %>% 
  mutate(mcc = round(mcc, 3),
         auc = round(auc, 3),
         F1 = round(F1, 3),
         sensitivity = round(sensitivity, 3),
         prauc = round(prauc,3),
         specificity = round(specificity, 3),
         precision = round(precision, 3)) %>% 
  arrange(clustersN, desc(mcc)) %>% 
  knitr::kable()
```

nhoods level

```{r, eval=FALSE}
nhoodsRes_all = data.frame()

for (file in filenames) {
  load(file)
  nhoodRes = data.frame()
  for (idx in 1:length(oper)){
    if (!is.na(oper[[idx]])) {nhoodRes = rbind(nhoodRes, oper[[idx]]$nhoodDF)}
  }
  nhoodRes = nhoodRes %>% 
  dplyr::rename(milo_pvals = SpatialFDR) %>% 
  filter(ident_fraction > 0.8)  # get nhoods mainly contains one cell type -> 90%
  methods = colnames(nhoodRes)[colnames(nhoodRes) %>% str_detect("_pvals")] %>% str_remove("_pvals")
  numb_mthd = length(methods)
  mcc = rep(NA, numb_mthd)
  auc = rep(NA, numb_mthd)
  prauc = rep(NA, numb_mthd)
  sensitivity = rep(NA, numb_mthd)
  specificity = rep(NA, numb_mthd)
  precision = rep(NA, numb_mthd)
  F1 = rep(NA, numb_mthd)
  truth = nhoodRes$truth
  select_col = colnames(nhoodRes)[colnames(nhoodRes) %>% str_detect("_pvals")]
  for (i in 1:length(select_col)){
    pred = nhoodRes[,select_col[i]]
    auc[i] = getROC(truth[!is.na(pred)], pred[!is.na(pred)])$auc
    if (i == 1) {pred_res = ifelse(pred < 0.30, "P", "N")}
    else {pred_res = ifelse(pred < 0.10, "P", "N")}
    TP <- sum(pred_res[!is.na(pred_res)]=="P"&truth[!is.na(pred_res)]=="P")
    TN <- sum(pred_res[!is.na(pred_res)]=="N"&truth[!is.na(pred_res)]=="N")
    FP <- sum(pred_res[!is.na(pred_res)]=="P"&truth[!is.na(pred_res)]=="N")
    FN <- sum(pred_res[!is.na(pred_res)]=="N"&truth[!is.na(pred_res)]=="P")
    truthN = TN + FP
    truthP = FN + TP
    predP = TP + FP
    predN = FN + TN
    sensitivity[i] = TP/truthP
    specificity[i] = TN/truthN
    precision[i] = TP/predP
    mcc[i] = sqrt(sensitivity[i]*specificity[i]*precision[i]*(TN/(TN+FN))) - sqrt((1-sensitivity[i])*(1-specificity[i])*(FN/predN)*(FP/predP))
    #mcc[i] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
    F1[i] = 2*TP/(2*TP+FP+FN)
    prauc[i] = getPRC(truth[!is.na(pred)], pred[!is.na(pred)])$prauc
  }
  res = data.frame(method = methods, mcc = mcc, auc = auc, prauc = prauc, sensitivity = sensitivity, specificity = specificity, precision = precision, F1 = F1) %>% 
    arrange(desc(prauc)) %>% 
    mutate(clustersN = str_extract(file, "K\\d\\d"))
  nhoodsRes_all = rbind(nhoodsRes_all, res)
}

nhoodsRes_all = nhoodsRes_all %>% 
  mutate(clustersN = ifelse(is.na(clustersN), "K8", clustersN),
         clustersN = str_remove(clustersN, "K"),
         clustersN = factor(clustersN, levels = c("8", "10", "12")))

save(nhoodsRes_all, file = "/storage/holab/linxy/DCATS/simulation/nhoodsRes_all_clustersN.RData")
```

```{r}
load("/storage/holab/linxy/DCATS/simulation/nhoodsRes_all_clustersN.RData")
nhoodsRes_all %>% 
  arrange(clustersN, desc(auc)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  dplyr::select(method, mcc, auc, sensitivity, specificity, F1, clustersN) %>% 
  mutate(mcc = round(mcc, 3),
         prauc = round(auc, 3),
         sensitivity = round(sensitivity, 3),
         specificity = round(specificity, 3),
         F1 = round(F1, 3))
```

```{r}
nhoodsH2_auc = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>% 
  dplyr::select(method, auc, clustersN) %>% 
  ggplot(aes(clustersN, method)) +
    geom_tile(aes(fill = auc)) + 
    geom_text(aes(label = round(auc, 3))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0.6,0.8)) +
  xlab("# of cell types") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

nhoodsH2_mcc = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>% 
  dplyr::select(method, mcc, clustersN) %>% 
  ggplot(aes(clustersN, method)) +
    geom_tile(aes(fill = mcc)) + 
    geom_text(aes(label = ifelse(is.na(mcc), "N.A.", as.character(round(mcc, 3))))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0,0.5)) +
  xlab("# of cell types") +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank())

nhoodsH2_sensitivity = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>% 
  dplyr::select(method, sensitivity, clustersN) %>% 
  ggplot(aes(clustersN, method)) +
    geom_tile(aes(fill = sensitivity)) + 
    geom_text(aes(label = round(sensitivity, 3))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0,0.6)) +
  xlab("# of cell types")

nhoodsH2_specificity = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>% 
  dplyr::select(method, specificity, clustersN) %>% 
  ggplot(aes(clustersN, method)) +
    geom_tile(aes(fill = specificity)) + 
    geom_text(aes(label = round(specificity, 3))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0.8,1)) +
  xlab("# of cell types") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank())

nhoodsH2_precision = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>% 
  dplyr::select(method, precision, clustersN) %>% 
  ggplot(aes(clustersN, method)) +
    geom_tile(aes(fill = precision)) + 
    geom_text(aes(label = ifelse(is.na(precision), "N.A.", as.character(round(precision, 3))))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0.7,1)) +
  xlab("# of cell types") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank())

nhoodsH2_F1 = nhoodsRes_all %>% 
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = c("speckle", "estPhi_emU", "estPhi_wtoEM", "wtoPhi_emU", "wtoPhi_wtoEM", "milo", "Fisher"))) %>% 
  dplyr::select(method, F1, clustersN) %>% 
  ggplot(aes(clustersN, method)) +
    geom_tile(aes(fill = F1)) + 
    geom_text(aes(label = round(F1, 3))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0,0.7)) +
  xlab("# of cell types") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())

nhoodsH2_mcc + nhoodsH2_F1 + nhoodsH2_auc + nhoodsH2_sensitivity + nhoodsH2_specificity + nhoodsH2_precision
ggsave("./plot/sim2_nhood2.png", bg = "transparent", width = 10, height = 6)
```


### Figure 2 - C

```{r}
load("/storage/holab/linxy/DCATS/simulation/replicates10&10_K8_con100_splatter2000&2000_para.RData")
```


```{r}
conditionRes = data.frame()
genderRes = data.frame()
ageRes = data.frame()
for (idx in 1:length(oper)){
  if (!is.na(oper[[idx]])) {
    conditionRes = rbind(conditionRes, oper[[idx]]$conditionDF)
    genderRes = rbind(genderRes, oper[[idx]]$genderDF)
    ageRes = rbind(ageRes, oper[[idx]]$ageDF)}}
conditionRes = conditionRes %>% 
  mutate(factor = "condition") %>% 
  dplyr::select(cluster, truth, factor, everything())
ageRes = ageRes %>% 
  mutate(factor = "age") %>% 
  dplyr::select(cluster, truth, factor, everything())
genderRes = genderRes %>% 
  mutate(factor = "gender") %>% 
  dplyr::select(cluster, truth, factor, everything())
## conditionRes
fileL = list(conditionRes, ageRes, genderRes)
res_all = data.frame()
for (file in fileL) {
  simulationDF = file
  methods = colnames(simulationDF)[colnames(simulationDF) %>% str_detect("_pvals")] %>% str_remove("_pvals")
  if("milo_less" %in% colnames(simulationDF)) {
    methods = c(methods, "milo")
    simulationDF = simulationDF %>% 
      mutate(milo_main = ifelse(milo_less > milo_more, milo_less, milo_more),
           milo_pct = milo_main/(milo_less + neutral + milo_more),
           milo_diff = abs(milo_less - milo_more)) %>% 
      dplyr::select(-milo_less, -milo_more, - neutral, -milo_main)
  }
  numb_mthd = length(methods)
  mcc = rep(NA, numb_mthd)
  auc = rep(NA, numb_mthd)
  prauc = rep(NA, numb_mthd)
  sensitivity = rep(NA, numb_mthd)
  specificity = rep(NA, numb_mthd)
  precision = rep(NA, numb_mthd)
  F1 = rep(NA, numb_mthd)
  truth = simulationDF$truth
  for (i in 4:(3+numb_mthd)) {
    pred = simulationDF[,i]
    if (colnames(simulationDF)[i] == "milo_pct") {
      pred_res = ifelse(simulationDF$milo_diff > 0, "P", "N")
      auc[i-3] = getROC(simulationDF$truth, 1-pred)$auc
      prauc[i-3] = getPRC(simulationDF$truth, 1-pred)$prauc}
    else {
      pred_res = ifelse(pred < 0.1, "P", "N")
      auc[i-3] = getROC(simulationDF$truth, pred)$auc
      prauc[i-3] = getPRC(simulationDF$truth, pred)$prauc}
    TP <- sum(pred_res=="P"&truth=="P")
    TN <- sum(pred_res=="N"&truth=="N")
    FP <- sum(pred_res=="P"&truth=="N")
    FN <- sum(pred_res=="N"&truth=="P")
    truthN = TN + FP
    truthP = FN + TP
    predP = TP + FP
    predN = FN + TN
    sensitivity[i-3] = TP/truthP
    specificity[i-3] = TN/truthN
    precision[i-3] = TP/predP
    #mcc[i-2] = sqrt(sensitivity[i]*specificity[i]*precision[i]*(TN/(TN+FN))) - sqrt((1-sensitivity[i])*(1-specificity[i])*(FN/predN)*(FP/predP))
    mcc[i-3] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
    F1[i-3] = 2*TP/(2*TP+FP+FN)
    }
  res = data.frame(method = methods, mcc = mcc, auc = auc, prauc = prauc, sensitivity = sensitivity, specificity = specificity, precision = precision, F1 = F1) %>% 
    arrange(desc(auc)) %>% 
    mutate(factor = unique(simulationDF$factor))
  res_all = rbind(res_all, res)}
res_all
```

```{r}
sim3_order = c("milo_null", "scDC", "milo_full", "Fisher", "speckle", "diffcyt", "DCATS")
sim3_main = res_all %>% 
  dplyr::select(method, mcc, factor) %>% 
  pivot_wider(names_from = factor, values_from = mcc) %>% 
  pivot_longer(condition:gender, names_to = "factor", values_to = "mcc") %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo_full", "milo_null")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method),
         method = ifelse(method == "estPhi_emK", "DCATS", method)) %>% 
  mutate(method = factor(method, level = sim3_order),
         factor = factor(factor, level = c("condition", "age", "gender"))) %>% 
  ggplot(aes(factor, method)) +
    geom_tile(aes(fill = mcc)) + 
    geom_text(aes(label = ifelse(is.na(mcc), "N.A.", as.character(round(mcc, 3))))) +
    scale_fill_gradient(low = "white", high = "red")+
  xlab("covariates") +
  theme(axis.title.y = element_blank())
sim3_main
ggsave("./plot/sim3_main.png", bg = "transparent")
```

```{r}
res_all %>% 
  dplyr::select(method, auc, factor) %>% 
  pivot_wider(names_from = factor, values_from = auc) %>% 
  pivot_longer(condition:gender, names_to = "factor", values_to = "auc") %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo_full", "milo_null")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = sim3_order),
         factor = factor(factor, level = c("condition", "age", "gender"))) %>% 
  ggplot(aes(factor, method)) +
    geom_tile(aes(fill = auc)) + 
    geom_text(aes(label = ifelse(is.na(auc), "N.A.", as.character(round(auc, 3))))) +
    scale_fill_gradient(low = "white", high = "red")+
  xlab("Covariates")
ggsave("./plot/sim3_auc.png", bg = "transparent")
```

```{r}
sim3_order2 = c("milo_null", "scDC", "milo_full", "Fisher", "speckle", "diffcyt", "wtoPhi_emK", "estPhi_wtoEM", "wtoPhi_wtoEM", "estPhi_emK")
res_all %>% 
  dplyr::select(method, mcc, factor) %>% 
  pivot_wider(names_from = factor, values_from = mcc) %>% 
  pivot_longer(condition:gender, names_to = "factor", values_to = "mcc") %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "betabin_null", "estPhi_null", "wtoPhi_emK", "estPhi_emK", "milo_null", "milo_full")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = sim3_order2),
         factor = factor(factor, level = c("condition", "age", "gender"))) %>% 
  ggplot(aes(factor, method)) +
    geom_tile(aes(fill = mcc)) + 
    geom_text(aes(label = ifelse(is.na(mcc), "N.A.", as.character(round(mcc, 3))))) +
    scale_fill_gradient(low = "white", high = "red")+
  xlab("Covariates")
ggsave("./plot/sim3_mcc.png", bg = "transparent")
```

```{r}
res_all %>% 
  dplyr::select(method, F1, factor) %>% 
  pivot_wider(names_from = factor, values_from = F1) %>% 
  pivot_longer(condition:gender, names_to = "factor", values_to = "F1") %>% 
  filter(method %in% c("speckle", "diffcyt", "fisher", "scDC", "betabin_null", "estPhi_null", "wtoPhi_emK", "estPhi_emK", "milo_null", "milo_full")) %>%
  mutate(method = ifelse(method == "fisher", "Fisher", method)) %>% 
  mutate(method = ifelse(method == "estPhi_null", "estPhi_wtoEM", method),
         method = ifelse(method == "betabin_null", "wtoPhi_wtoEM", method)) %>% 
  mutate(method = factor(method, level = sim3_order2),
         factor = factor(factor, level = c("condition", "age", "gender"))) %>% 
  ggplot(aes(factor, method)) +
    geom_tile(aes(fill = F1)) + 
    geom_text(aes(label = ifelse(is.na(F1), "N.A.", as.character(round(F1, 3))))) +
    scale_fill_gradient(low = "white", high = "red", limits = c(0,0.8))+
  xlab("Covariates")
ggsave("./plot/sim3_f1.png", bg = "transparent")
```

### extreme case1

```{r}
load("/storage/holab/linxy/DCATS/simulation/one_increase.RData")
```

```{r}
## calculate statistics of "three_increase.RData" results
#load(file_name)
clusterRes = resL$clusterRes
methods = colnames(clusterRes)[colnames(clusterRes) %>% str_detect("_pvals")] %>% str_remove("_pvals")
#methods = colnames(clusterRes)[colnames(clusterRes) %>% str_detect("_pvals")] %>% str_remove("_pvals")
methods = c(methods, "milo")
numb_mthd = length(methods)
mcc = rep(NA, numb_mthd)
auc = rep(NA, numb_mthd)
prauc = rep(NA, numb_mthd)
sensitivity = rep(NA, numb_mthd)
specificity = rep(NA, numb_mthd)
precision = rep(NA, numb_mthd)
F1 = rep(NA, numb_mthd)
truth = clusterRes$truth
clusterRes = clusterRes %>% 
  mutate(milo_main = ifelse(milo_less > milo_more, milo_less, milo_more),
         milo_pct = milo_main/(milo_less + neutral + milo_more),
         milo_diff = abs(milo_less - milo_more)) %>% 
  dplyr::select(-milo_less, -milo_more, - neutral, -milo_main)

for (i in 3:(dim(clusterRes)[2]-1)){
  pred = clusterRes[,i]
  if (colnames(clusterRes)[i] == "milo_pct") {
    pred_res = ifelse(clusterRes$milo_diff > 0, "P", "N")
    ## most of them are negative, can't calculate this value
    auc[i-2] = getROC(clusterRes$truth, 1-pred)$auc
    #prauc[i-2] = getPRC(clusterRes$truth, 1-pred)$prauc
    }
  else {
    pred_res = ifelse(pred < 0.1, "P", "N")
    auc[i-2] = getROC(clusterRes$truth, pred)$auc
    prauc[i-2] = getPRC(clusterRes$truth, pred)$prauc}
  TP <- sum(pred_res=="P"&truth=="P")
  TN <- sum(pred_res=="N"&truth=="N")
  FP <- sum(pred_res=="P"&truth=="N")
  FN <- sum(pred_res=="N"&truth=="P")
  truthN = TN + FP
  truthP = FN + TP
  predP = TP + FP
  predN = FN + TN
  sensitivity[i-2] = TP/truthP
  specificity[i-2] = TN/truthN
  precision[i-2] = TP/predP
  #mcc[i-2] = sqrt(sensitivity[i]*specificity[i]*precision[i]*(TN/(TN+FN))) - sqrt((1-sensitivity[i])*(1-specificity[i])*(FN/predN)*(FP/predP))
  mcc[i-2] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
  F1[i-2] = 2*TP/(2*TP+FP+FN)
}
res = data.frame(methods = methods, mcc = mcc, auc = auc, prauc = prauc, sensitivity = sensitivity, specificity = specificity, precision = precision, F1 = F1) %>% 
  arrange(desc(mcc))
  #filter(methods == "wtoPhi_fullK" | methods == "diffcyt" | methods == "speckle" | methods == "fisher" | methods == "scDC")
print(res)
```

```{r}
sim4_mainHM1 = res %>% 
  filter(methods %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn", "emK_org2", "emK_truth2")) %>%
  mutate(methods = ifelse(methods == "fisher", "Fisher", methods)) %>% 
  mutate(methods = ifelse(methods == "estPhi_emK", "DCATS", methods)) %>% 
  mutate(methods = ifelse(methods == "ancombc_knn", "bcancombc", methods)) %>% 
  mutate(methods = ifelse(methods == "emK_org2", "dcats_autoRef", methods)) %>% 
  mutate(methods = ifelse(methods == "emK_truth2", "dcats_defRef", methods)) %>% 
  mutate(methods = factor(methods, level = c("Fisher", "scDC", "ancombc", "bcancombc", "milo", "diffcyt", "speckle", "dcats_defRef", "dcats_autoRef",  "DCATS"))) %>% 
  dplyr::select(methods, mcc, F1, auc) %>% 
  pivot_longer(mcc:auc, names_to = "statistics", values_to = "value") %>% 
  #dplyr::select(method, auc, mcc, clustersN) %>% 
  #pivot_longer(auc, names_to = "statistics", values_to = "value") %>% 
  group_by(statistics) %>% 
  mutate(statistics = factor(statistics, levels = c("mcc", "F1", "auc"))) %>% 
  mutate(order_pre = rank(round(value, 3)),
         value_order = 7-ceiling(rank(order_pre))) %>% 
  ggplot(aes(statistics, methods)) +
    geom_tile(aes(fill = value)) + 
    geom_text(aes(label = round(value, 3))) +
  #scale_fill_distiller(palette = "RdYIBu") +
    scale_fill_gradient(low = "white", high = "red") +
  #xlab("# of cell types") +
  theme(axis.title.x = element_blank()) +
  labs(fill='value') + ggtitle("Special case")
sim4_mainHM1
```

```{r}
res %>% 
  filter(methods %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn", "emK_org2", "emK_truth2")) %>%
  mutate(methods = ifelse(methods == "fisher", "Fisher", methods)) %>% 
  mutate(methods = ifelse(methods == "estPhi_emK", "DCATS", methods)) %>% 
  mutate(methods = ifelse(methods == "ancombc_knn", "bcancombc", methods)) %>% 
  mutate(methods = ifelse(methods == "emK_org2", "emK_autoRef", methods)) %>% 
  mutate(methods = ifelse(methods == "emK_truth2", "emK_defRef", methods)) %>% 
  mutate(methods = factor(methods, level = c("Fisher", "scDC", "ancombc", "bcancombc", "milo", "diffcyt", "speckle", "dcats_defRef", "dcats_autoRef",  "DCATS"))) %>% 
mutate(mcc = round(mcc, 3),
         auc = round(auc, 3),
         F1 = round(F1, 3),
         sensitivity = round(sensitivity, 3),
         prauc = round(prauc,3),
         specificity = round(specificity, 3),
         precision = round(precision, 3)) %>% 
  arrange(desc(auc)) %>% 
  knitr::kable()
```

```{r}
(p1 + sim2_prop + curve + theme(legend.position="top"))/(sim2_mainHM1 + sim2_mainHM2 + sim2_mainHM3 + sim2_mainHM4  + plot_layout(ncol = 4))/(sim4_mainHM1 + sim3_main)
ggsave("./plot/version2/Fig2.png", bg = "transparent", height = 14, width = 12)

#ggsave("./plot/version2/Fig2_sub2.png", bg = "transparent", height = 5, width = 12)
```



### extreme case1

```{r}
load("/storage/holab/linxy/DCATS/simulation/three_increase_conc100.RData")
```

```{r}
## calculate statistics of "three_increase.RData" results
#load(file_name)
clusterRes = resL$clusterRes
methods = colnames(clusterRes)[colnames(clusterRes) %>% str_detect("_pvals")] %>% str_remove("_pvals")
#methods = colnames(clusterRes)[colnames(clusterRes) %>% str_detect("_pvals")] %>% str_remove("_pvals")
methods = c(methods, "milo")
numb_mthd = length(methods)
mcc = rep(NA, numb_mthd)
auc = rep(NA, numb_mthd)
prauc = rep(NA, numb_mthd)
sensitivity = rep(NA, numb_mthd)
specificity = rep(NA, numb_mthd)
precision = rep(NA, numb_mthd)
F1 = rep(NA, numb_mthd)
truth = clusterRes$truth
clusterRes = clusterRes %>% 
  mutate(milo_main = ifelse(milo_less > milo_more, milo_less, milo_more),
         milo_pct = milo_main/(milo_less + neutral + milo_more),
         milo_diff = abs(milo_less - milo_more)) %>% 
  dplyr::select(-milo_less, -milo_more, - neutral, -milo_main)

for (i in 3:(dim(clusterRes)[2]-1)){
  pred = clusterRes[,i]
  if (colnames(clusterRes)[i] == "milo_pct") {
    pred_res = ifelse(clusterRes$milo_diff > 0, "P", "N")
    ## most of them are negative, can't calculate this value
    auc[i-2] = getROC(clusterRes$truth, 1-pred)$auc
    #prauc[i-2] = getPRC(clusterRes$truth, 1-pred)$prauc
    }
  else {
    pred_res = ifelse(pred < 0.1, "P", "N")
    auc[i-2] = getROC(clusterRes$truth, pred)$auc
    prauc[i-2] = getPRC(clusterRes$truth, pred)$prauc}
  TP <- sum(pred_res=="P"&truth=="P")
  TN <- sum(pred_res=="N"&truth=="N")
  FP <- sum(pred_res=="P"&truth=="N")
  FN <- sum(pred_res=="N"&truth=="P")
  truthN = TN + FP
  truthP = FN + TP
  predP = TP + FP
  predN = FN + TN
  sensitivity[i-2] = TP/truthP
  specificity[i-2] = TN/truthN
  precision[i-2] = TP/predP
  #mcc[i-2] = sqrt(sensitivity[i]*specificity[i]*precision[i]*(TN/(TN+FN))) - sqrt((1-sensitivity[i])*(1-specificity[i])*(FN/predN)*(FP/predP))
  mcc[i-2] = (TP*TN-FP*FN)/sqrt(predP*truthP*truthN*predN)
  F1[i-2] = 2*TP/(2*TP+FP+FN)
}
res = data.frame(methods = methods, mcc = mcc, auc = auc, prauc = prauc, sensitivity = sensitivity, specificity = specificity, precision = precision, F1 = F1) %>% 
  arrange(desc(mcc))
  #filter(methods == "wtoPhi_fullK" | methods == "diffcyt" | methods == "speckle" | methods == "fisher" | methods == "scDC")
print(res)
```

```{r}
sim4_mainHM1 = res %>% 
  filter(methods %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn", "emK_org2", "emK_truth2")) %>%
  mutate(methods = ifelse(methods == "fisher", "Fisher", methods)) %>% 
  mutate(methods = ifelse(methods == "estPhi_emK", "DCATS", methods)) %>% 
  mutate(methods = ifelse(methods == "ancombc_knn", "bcancombc", methods)) %>% 
  mutate(methods = ifelse(methods == "emK_org2", "dcats_autoRef", methods)) %>% 
  mutate(methods = ifelse(methods == "emK_truth2", "dcats_defRef", methods)) %>% 
  mutate(methods = factor(methods, level = c("dcats_defRef", "DCATS", "speckle", "diffcyt", "Fisher", "dcats_autoRef", "milo", "bcancombc", "ancombc", "scDC"))) %>% 
  dplyr::select(methods, auc, mcc, F1) %>% 
  pivot_longer(auc:F1, names_to = "statistics", values_to = "value") %>% 
  #dplyr::select(method, auc, mcc, clustersN) %>% 
  #pivot_longer(auc, names_to = "statistics", values_to = "value") %>% 
  mutate(statistics = factor(statistics, levels = c("mcc", "auc", "F1"))) %>% 
  group_by(statistics) %>% 
  mutate(order_pre = rank(round(value, 3)),
         value_order = 7-ceiling(rank(order_pre))) %>% 
  ggplot(aes(statistics, methods)) +
    geom_tile(aes(fill = value)) + 
    geom_text(aes(label = round(value, 3))) +
  #scale_fill_distiller(palette = "RdYIBu") +
    scale_fill_gradient(low = "white", high = "red") +
  #xlab("# of cell types") +
  theme(axis.title.y = element_blank(),
        #axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom") +
  labs(fill='value') + 
  ggtitle("Special case 2")
sim4_mainHM1
```

```{r}
res %>% 
  filter(methods %in% c("speckle", "diffcyt", "fisher", "scDC", "estPhi_emK", "milo", "ancombc", "ancombc_knn", "emK_org2", "emK_truth2")) %>%
  mutate(methods = ifelse(methods == "fisher", "Fisher", methods)) %>% 
  #mutate(method = ifelse(method == "estPhi_emK", "DCATS", method)) %>% 
  mutate(methods = ifelse(methods == "ancombc_knn", "bcancombc", methods)) %>% 
  mutate(methods = ifelse(methods == "emK_org2", "emK_autoRef", methods)) %>% 
  mutate(methods = ifelse(methods == "emK_truth2", "emK_defRef", methods)) %>% 
  mutate(methods = factor(methods, level = c("emK_autoRef", "emK_defRef", "estPhi_emK", "speckle", "diffcyt", "Fisher", "milo", "bcancombc", "ancombc", "scDC"))) %>% 
mutate(mcc = round(mcc, 3),
         auc = round(auc, 3),
         F1 = round(F1, 3),
         sensitivity = round(sensitivity, 3),
         prauc = round(prauc,3),
         specificity = round(specificity, 3),
         precision = round(precision, 3)) %>% 
  arrange(desc(auc)) %>% 
  knitr::kable()
```



## Figure 4

### real-world data 1 - Experiment 7

The 'group' column started with 'B' is the indicators of replicates

```{r, echo=FALSE}
exp7_data <- read.csv("/storage/holab/linxy/DCATS/real_world/Exp7_Adam_2017/celltypelabels_Haber.txt", sep="") %>% 
  rownames_to_column("cell") %>% 
  separate(cell, c("batch", "barcode", "condition", "clusterRes"), sep = "_") 
```

```{r}
cellnumDF = exp7_data %>% 
  group_by(batch, condition, clusterRes) %>% 
  summarise(n = n()) %>% 
  mutate(freq = round(n/sum(n), 3)) %>% 
  mutate(clusterRes = ifelse(clusterRes == "Endocrine", "Edo", clusterRes),
         clusterRes = ifelse(clusterRes == "Enterocyte", "E", clusterRes),
         clusterRes = ifelse(clusterRes == "Enterocyte.Progenitor", "EP", clusterRes),
         clusterRes = ifelse(clusterRes == "Goblet", "Gob", clusterRes),
         clusterRes = ifelse(clusterRes == "TA.Early", "TAE", clusterRes))
```

```{r}
order = cellnumDF %>% 
  filter(condition == "Control" | condition == "Hpoly.Day3") %>% 
  group_by(condition, clusterRes) %>% 
  summarise(mean = mean(freq)) %>% 
  pivot_wider(names_from = condition, values_from = mean) %>% 
  mutate(diff = abs(Control - Hpoly.Day3)) %>% 
  arrange(desc(diff))
haber1 = cellnumDF %>% 
  filter(condition == "Control" | condition == "Hpoly.Day3") %>% 
  mutate(clusterRes = factor(clusterRes, levels = c("Tuft", "Edo", "EP", "Stem", "Gob", "TAE", "E", "TA"))) %>% 
  ggplot(aes(x = clusterRes, y = freq, fill = condition, color = condition)) +
  geom_dotplot(binaxis='y', stackdir='center', 
               dotsize = 0.6,position = position_dodge(0.5)) + 
  ylab("proportion") +
  xlab("Haber2017") +
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        axis.title.y = element_blank()) +
  theme(legend.position="top")
haber2 = cellnumDF %>% 
  filter(condition == "Control" | condition == "Hpoly.Day10") %>% 
  mutate(clusterRes = factor(clusterRes, levels = c("Tuft", "TAE", "Gob", "E", "EP", "Edo", "Stem", "TA"))) %>% 
  ggplot(aes(x = clusterRes, y = freq, fill = condition, color = condition)) +
  geom_dotplot(binaxis='y', stackdir='center', 
               dotsize = 0.6,position = position_dodge(0.5)) + 
  ylab("proportion") +
  xlab("Haber2017") +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(legend.position="top") 
haber3 = cellnumDF %>% 
  filter(condition == "Control" | condition == "Salmonella") %>% 
  mutate(clusterRes = factor(clusterRes, levels = c("E", "Stem", "TA", "TAE", "EP", "Tuft", "Gob", "Edo"))) %>% 
  ggplot(aes(x = clusterRes, y = freq, fill = condition, color = condition)) +
  geom_dotplot(binaxis='y', stackdir='center', 
               dotsize = 0.6,position = position_dodge(0.5)) + 
  ylab("proportion") +
  xlab("Haber2017") +
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        axis.title.y = element_blank()) +
  theme(legend.position="top")
```

```{r}
load("/storage/holab/linxy/DCATS/real_world/Exp7_Adam_2017/Haber2017_res.RData")

all_resC3 %>% 
  mutate(milo_pct = ifelse(milo_more > milo_less, (milo_more-milo_less)/(milo_more+milo_less+neutral), (milo_less-milo_more)/(milo_more+milo_less+neutral))) %>% 
  dplyr::select(cluster, truth, contains('_pvals'), milo_pct) %>% 
  mutate_if(is.numeric, round, 3) %>% 
  mutate(treatment = "Hpoly.Day3") %>% 
  rename_with(~ gsub('_pvals', '', .x)) %>% 
  knitr::kable()
all_resC10 %>% 
  mutate(milo_pct = ifelse(milo_more > milo_less, (milo_more-milo_less)/(milo_more+milo_less+neutral), (milo_less-milo_more)/(milo_more+milo_less+neutral))) %>% 
  dplyr::select(cluster, truth, contains('_pvals'), milo_pct) %>% 
  mutate_if(is.numeric, round, 3) %>% 
  mutate(treatment = "Hpoly.Day10") %>% 
  rename_with(~ gsub('_pvals', '', .x)) %>% 
  knitr::kable()
all_resCS %>% 
  mutate(milo_pct = ifelse(milo_more > milo_less, (milo_more-milo_less)/(milo_more+milo_less+neutral), (milo_less-milo_more)/(milo_more+milo_less+neutral))) %>% 
  dplyr::select(cluster, truth, contains('_pvals'), milo_pct) %>% 
  mutate_if(is.numeric, round, 3) %>% 
  mutate(treatment = "Salmonella") %>% 
  rename_with(~ gsub('_pvals', '', .x)) %>% 
  knitr::kable()
```

```{r}
all_resC3 %>% 
  mutate(milo_pct = ifelse(milo_more > milo_less, (milo_more-milo_less)/(milo_more+milo_less+neutral), (milo_less-milo_more)/(milo_more+milo_less+neutral)),
         milo_Res = ifelse(milo_pct > 0.2, "P", "N")) %>% 
  dplyr::select(cluster, truth, contains('_Res')) %>% 
  dplyr::rename(origin = truth) %>% 
  pivot_longer(origin:milo_Res, names_to = "method", values_to = "res") %>% 
  pivot_wider(names_from = cluster, values_from = res) %>% 
  mutate(method = str_remove(method, "_Res")) %>% 
  filter(method %in% c("origin", "estPhi_emSVM", "fisher", "scDC", "speckle", "milo")) %>% 
  mutate(method = ifelse(method == "estPhi_emSVM", "DCATS", method)) %>% 
  column_to_rownames("method") %>% 
  dplyr::select(Tuft, Endocrine, Enterocyte.Progenitor, Stem, Goblet, TA.Early, Enterocyte, TA) %>% 
  knitr::kable()

all_resC10 %>% 
  mutate(milo_pct = ifelse(milo_more > milo_less, (milo_more-milo_less)/(milo_more+milo_less+neutral), (milo_less-milo_more)/(milo_more+milo_less+neutral)),
         milo_Res = ifelse(milo_pct > 0.2, "P", "N")) %>% 
  dplyr::select(cluster, truth, contains('_Res')) %>% 
  dplyr::rename(origin = truth) %>% 
  pivot_longer(origin:milo_Res, names_to = "method", values_to = "res") %>% 
  pivot_wider(names_from = cluster, values_from = res) %>% 
  mutate(method = str_remove(method, "_Res")) %>% 
  filter(method %in% c("origin", "estPhi_emSVM", "fisher", "scDC", "speckle", "milo")) %>% 
  mutate(method = ifelse(method == "estPhi_emSVM", "DCATS", method)) %>% 
  column_to_rownames("method") %>% 
  dplyr::select(Tuft, TA.Early, Goblet, Enterocyte, Enterocyte.Progenitor, Endocrine, Stem, TA) %>% 
  knitr::kable()

all_resCS %>% 
  mutate(milo_pct = ifelse(milo_more > milo_less, (milo_more-milo_less)/(milo_more+milo_less+neutral), (milo_less-milo_more)/(milo_more+milo_less+neutral)),
         milo_Res = ifelse(milo_pct > 0.2, "P", "N")) %>% 
  dplyr::select(cluster, truth, contains('_Res')) %>% 
  dplyr::rename(origin = truth) %>% 
  pivot_longer(origin:milo_Res, names_to = "method", values_to = "res") %>% 
  pivot_wider(names_from = cluster, values_from = res) %>% 
  mutate(method = str_remove(method, "_Res")) %>% 
  filter(method %in% c("origin", "estPhi_emSVM", "fisher", "scDC", "speckle", "milo")) %>% 
  mutate(method = ifelse(method == "estPhi_emSVM", "DCATS", method)) %>% 
  column_to_rownames("method") %>% 
  dplyr::select(Enterocyte, Stem, TA, TA.Early, Enterocyte.Progenitor, Tuft, Goblet, Endocrine) %>% 
  knitr::kable()
```

```{r}
data("Haber2017")
Haber2017$svm_mat %>% knitr::kable()
```

Supplementary Figures: Distribution of each cell type after bias correction

```{r}
haberM = cellnumDF %>% 
  ungroup() %>% 
  dplyr::select(batch, clusterRes, n) %>% 
  pivot_wider(names_from = clusterRes, values_from = n) %>% 
  column_to_rownames("batch") %>% 
  as.matrix()

count_use = haberM
similarity_mat = Haber2017$svm_mat
  if(!is.null(similarity_mat)) {
    for (i in seq_len(nrow(haberM))) {
      count_use[i, ] <- sum(haberM[i, ]) *
        multinom_EM(haberM[i, ], similarity_mat, verbose = FALSE)$mu
    }
  }

corrected_cellnumDF = count_use %>% as.data.frame() %>% 
  rownames_to_column("batch") %>% 
  pivot_longer(Edo:Tuft, names_to = "clusterRes", values_to = "n") %>% 
  group_by(batch) %>% 
  mutate(freq = round(n/sum(n), 3)) %>% 
  ungroup() %>% 
  mutate(condition = cellnumDF$condition)
```

```{r}
haber1 = corrected_cellnumDF %>% 
  filter(condition == "Control" | condition == "Hpoly.Day3") %>% 
  mutate(clusterRes = factor(clusterRes, levels = c("Tuft", "Edo", "EP", "Stem", "Gob", "TAE", "E", "TA"))) %>% 
  ggplot(aes(x = clusterRes, y = freq, fill = condition, color = condition)) +
  geom_dotplot(binaxis='y', stackdir='center', 
               dotsize = 0.6,position = position_dodge(0.5)) + 
  ylab("proportion") +
  xlab("Haber2017") +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(legend.position="top")
haber2 = corrected_cellnumDF %>% 
  filter(condition == "Control" | condition == "Hpoly.Day10") %>% 
  mutate(clusterRes = factor(clusterRes, levels = c("Tuft", "TAE", "Gob", "E", "EP", "Edo", "Stem", "TA"))) %>% 
  ggplot(aes(x = clusterRes, y = freq, fill = condition, color = condition)) +
  geom_dotplot(binaxis='y', stackdir='center', 
               dotsize = 0.6,position = position_dodge(0.5)) + 
  ylab("proportion") +
  xlab("Haber2017") +
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        axis.title.y = element_blank()) +
  theme(legend.position="top") 
haber3 = corrected_cellnumDF %>% 
  filter(condition == "Control" | condition == "Salmonella") %>% 
  mutate(clusterRes = factor(clusterRes, levels = c("E", "Stem", "TA", "TAE", "EP", "Tuft", "Gob", "Edo"))) %>% 
  ggplot(aes(x = clusterRes, y = freq, fill = condition, color = condition)) +
  geom_dotplot(binaxis='y', stackdir='center', 
               dotsize = 0.6,position = position_dodge(0.5)) + 
  ylab("proportion") +
  xlab("Haber2017") +
  theme(axis.text.x = element_text(angle = 45, hjust=1),
        axis.title.y = element_blank()) +
  theme(legend.position="top")
haber1 + haber2 + haber3
ggsave("./plot/haber_corrected.png", bg = "transparent", height = 4, width = 15)
```


## real-world data2 

```{r, echo=FALSE}
exp6_clusterInfo = read.delim("/storage/holab/linxy/DCATS/real_world/Exp6_Kang/GSE96583_batch2.total.tsne.df.tsv") %>% 
  dplyr::rename(clusterRes = cell, condition = stim) %>% 
  rownames_to_column("cell") %>% 
  filter(!is.na(clusterRes))
head(exp6_clusterInfo)
exp6_clusterInfo %>% group_by(condition, clusterRes) %>% 
  summarise(n = n())
## check whether exist duplicate barcode -> no
exp6_clusterInfo %>% 
  group_by(cell) %>% 
  summarise(n = n()) %>% 
  filter(n > 1)
```

```{r}
ctrl_repInfo <- read.delim("/storage/holab/linxy/DCATS/real_world/Exp6_Kang/ye1.ctrl.8.10.sm.best")
stim_repInfo <- read.delim("/storage/holab/linxy/DCATS/real_world/Exp6_Kang/ye2.stim.8.10.sm.best")
head(ctrl_repInfo)
head(stim_repInfo)

exp6_repInfo = rbind(ctrl_repInfo, stim_repInfo) %>% 
  dplyr::rename(cell = BARCODE, batch = BEST) %>% 
  filter(str_detect(batch, 'SNG')) %>% 
  dplyr::select(cell, batch)
head(exp6_repInfo)
```

```{r}
exp6DF = exp6_clusterInfo %>% 
  merge(exp6_repInfo) %>% 
  group_by(condition, clusterRes, batch) %>% 
  summarise(n = n()) %>% 
  mutate(freq = round(n/sum(n), 3)) %>% 
  mutate(clusterRes = ifelse(clusterRes == "B cells", "B", clusterRes),
         clusterRes = ifelse(clusterRes == "CD14+ Monocytes", "cM", clusterRes),
         clusterRes = ifelse(clusterRes == "CD4 T cells", "Th", clusterRes),
         clusterRes = ifelse(clusterRes == "CD8 T cells", "Tc", clusterRes),
         clusterRes = ifelse(clusterRes == "FCGR3A+ Monocytes", "ncM", clusterRes),
         clusterRes = ifelse(clusterRes == "Megakaryocytes", "Mkc", clusterRes),
         clusterRes = ifelse(clusterRes == "NK cells", "NK", clusterRes),
         clusterRes = ifelse(clusterRes == "Dendritic cells", "DC", clusterRes))
kang_main = exp6DF %>% 
  mutate(condition = ifelse(condition == "stim", "Stimulated", "Control")) %>% 
  mutate(clusterRes = factor(clusterRes, levels = c("NK", "Tc", "cM", "ncM", "B", "Th", "DC", "Mkc"))) %>% 
  ggplot(aes(x = clusterRes, y = freq)) +
  geom_boxplot(aes(color = condition)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(legend.position="top") +
  ylab("proportion") + 
  xlab("Kang2017")
```

```{r}
load("/storage/holab/linxy/DCATS/real_world/Exp6_Kang/Kang2017_res.RData")
all_res %>% 
  mutate(milo_pct = ifelse(milo_more > milo_less, (milo_more-milo_less)/(milo_more+milo_less+neutral), (milo_less-milo_more)/(milo_more+milo_less+neutral))) %>% 
  dplyr::select(cluster, truth, contains('_pvals'), milo_pct) %>% 
  mutate_if(is.numeric, round, 3) %>% 
  rename_with(~ gsub('_pvals', '', .x)) %>% 
  knitr::kable()
  
```

```{r}
all_res %>% 
  mutate(milo_pct = ifelse(milo_more > milo_less, (milo_more-milo_less)/(milo_more+milo_less+neutral), (milo_less-milo_more)/(milo_more+milo_less+neutral)),
         milo_Res = ifelse(milo_pct > 0.2, "P", "N")) %>% 
  dplyr::select(cluster, truth, contains('_Res')) %>% 
  dplyr::rename(origin = truth) %>% 
  mutate(cluster = ifelse(cluster == "B cells", "B", cluster),
         cluster = ifelse(cluster == "CD14+ Monocytes", "cM", cluster),
         cluster = ifelse(cluster == "CD4 T cells", "Th", cluster),
         cluster = ifelse(cluster == "CD8 T cells", "Tc", cluster),
         cluster = ifelse(cluster == "FCGR3A+ Monocytes", "ncM", cluster),
         cluster = ifelse(cluster == "Megakaryocytes", "Mkc", cluster),
         cluster = ifelse(cluster == "NK cells", "NK", cluster),
         cluster = ifelse(cluster == "Dendritic cells", "DC", cluster)) %>% 
  pivot_longer(origin:milo_Res, names_to = "method", values_to = "res") %>% 
  pivot_wider(names_from = cluster, values_from = res) %>% 
  mutate(method = str_remove(method, "_Res")) %>% 
  filter(method %in% c("origin", "estPhi_emSVM", "fisher", "scDC", "speckle", "milo")) %>% 
  mutate(method = ifelse(method == "estPhi_emSVM", "DCATS", method)) %>% 
  dplyr::select(method, NK, Tc, cM, ncM, B, Th, DC, Mkc) %>% 
  column_to_rownames("method") %>% 
  knitr::kable()
```

```{r}
kang_main + haber1 + haber2 + haber3
ggsave("./plot/Fig3.png", bg = "transparent", height = 7.5, width = 10)
```

## Figure 4

### real-world data 3

```{r}
theme_set(theme_classic()+
            theme(panel.border = element_blank(),
          legend.key = element_blank(),
          axis.ticks = element_blank(),
          panel.grid = element_blank(),
          panel.grid.minor = element_blank(), 
          panel.grid.major = element_blank(),
          panel.background = element_blank(),
          legend.background = element_blank(),
          plot.background = element_rect(fill = "transparent",colour = NA)) + 
            theme(axis.text=element_text(size=12), axis.title=element_text(size=13))+
            theme(strip.text.x = element_text(size = 13), strip.text.y = element_text(size = 13)) +
            theme(plot.title = element_text(size = 15),plot.subtitle = element_text(size = 15)) +
            theme(legend.title = element_text(size=13), #change legend title font size
                  legend.text = element_text(size=13)))
```


```{r}
load("/storage/holab/linxy/DCATS/real_world/Ren_2021/Ren2021_res.RData")
data(Ren2021)
```

Test between different groups

control vs mild/moderate_progression

```{r, eval=FALSE, warning=FALSE}
designM_sub = Ren2021$designM %>% 
  filter(state == "control" | state == "mild/moderate_progression")
countM_sub = Ren2021$countM[rownames(designM_sub),]

simil_mat = create_simMat(dim(countM_sub)[2], confuse_rate=0.10)
betabin_null = dcats_GLM(countM_sub, designM_sub, base_model = 'FULL')
wtoPhi_emU = dcats_GLM(countM_sub, designM_sub, similarity_mat = simil_mat, base_model = 'FULL', pseudo_count = 1)
phi = getPhi(countM_sub, designM_sub)
estPhi_null = dcats_GLM(countM_sub, designM_sub, fix_phi = phi, base_model = 'FULL')
estPhi_emU = dcats_GLM(countM_sub, designM_sub, similarity_mat = simil_mat, fix_phi = phi, base_model = 'FULL', pseudo_count = 1)

stat.test1 = data.frame(group1 = "control", group2 = "mild/moderate (progression)", p = estPhi_emU$LRT_pvals[,4]) %>% 
  rownames_to_column("clusterRes")

wtoPhi_emU$LRT_pvals
estPhi_emU$LRT_pvals
```

control vs severe/critical_progression

```{r, eval=FALSE, warning=FALSE}
designM_sub = Ren2021$designM %>% 
  filter(state == "control" | state == "severe/critical_progression")
countM_sub = Ren2021$countM[rownames(designM_sub),]

simil_mat = create_simMat(dim(countM_sub)[2], confuse_rate=0.1)
betabin_null = dcats_GLM(countM_sub, designM_sub, base_model = 'FULL')
wtoPhi_emU = dcats_GLM(countM_sub, designM_sub, similarity_mat = simil_mat, base_model = 'FULL', pseudo_count = 1)
phi = getPhi(countM_sub, designM_sub)
estPhi_null = dcats_GLM(countM_sub, designM_sub, fix_phi = phi, base_model = 'FULL')
estPhi_emU = dcats_GLM(countM_sub, designM_sub, similarity_mat = simil_mat, fix_phi = phi, base_model = 'FULL', pseudo_count = 1)

stat.test2 = data.frame(group1 = "control", group2 = "severe/critical (progression)", p = estPhi_emU$LRT_pvals[,4]) %>% 
  rownames_to_column("clusterRes")
```

mild/moderate_convalescence vs mild/moderate_progression

```{r, eval=FALSE, warning=FALSE}
designM_sub = Ren2021$designM %>% 
  filter(state == "mild/moderate_convalescence" | state == "mild/moderate_progression")
countM_sub = Ren2021$countM[rownames(designM_sub),]

simil_mat = create_simMat(dim(countM_sub)[2], confuse_rate=0.1)
betabin_null = dcats_GLM(countM_sub, designM_sub, base_model = 'FULL')
wtoPhi_emU = dcats_GLM(countM_sub, designM_sub, similarity_mat = simil_mat, base_model = 'FULL', pseudo_count = 1)
phi = getPhi(countM_sub, designM_sub)
estPhi_null = dcats_GLM(countM_sub, designM_sub, fix_phi = phi, base_model = 'FULL')
estPhi_emU = dcats_GLM(countM_sub, designM_sub, similarity_mat = simil_mat, fix_phi = phi, base_model = 'FULL', pseudo_count = 1)
betabin_null$LRT_pvals < 0.05
wtoPhi_emU$LRT_pvals < 0.05
estPhi_null$LRT_pvals < 0.05
estPhi_emU$LRT_pvals < 0.05

stat.test3 = data.frame(group1 = "mild/moderate (convalescence)", group2 = "mild/moderate (progression)", p = estPhi_emU$LRT_pvals[,4]) %>% 
  rownames_to_column("clusterRes")

stat.test3
```

severe/critical_convalescence vs severe/critical_progression

```{r, eval=FALSE, warning=FALSE}
designM_sub = Ren2021$designM %>% 
  filter(state == "severe/critical_convalescence" | state == "severe/critical_progression")
countM_sub = Ren2021$countM[rownames(designM_sub),]

simil_mat = create_simMat(dim(countM_sub)[2], confuse_rate=0.1)
betabin_null = dcats_GLM(countM_sub, designM_sub, base_model = 'FULL')
wtoPhi_emU = dcats_GLM(countM_sub, designM_sub, similarity_mat = simil_mat, base_model = 'FULL', pseudo_count = 1)
phi = getPhi(countM_sub, designM_sub)
estPhi_null = dcats_GLM(countM_sub, designM_sub, fix_phi = phi, base_model = 'FULL')
estPhi_emU = dcats_GLM(countM_sub, designM_sub, similarity_mat = simil_mat, fix_phi = phi, base_model = 'FULL', pseudo_count = 1)
betabin_null$LRT_pvals < 0.05
wtoPhi_emU$LRT_pvals < 0.05
estPhi_null$LRT_pvals < 0.05
estPhi_emU$LRT_pvals < 0.05

stat.test4 = data.frame(group1 = "severe/critical (convalescence)", group2 = "severe/critical (progression)", p = estPhi_emU$LRT_pvals[,4]) %>% 
  rownames_to_column("clusterRes")
```


```{r}
Ren2021_plotDF = Ren2021$countM %>% 
  as.data.frame() %>% 
  merge(Ren2021$designM, by = 0) %>% 
  pivot_longer(B:Neu, names_to = "clusterRes", values_to = "count") %>% 
  group_by(Row.names) %>% 
  mutate(state = str_replace(state, "_convalescence", " (convalescence)"),
         state = str_replace(state, "_progression", " (progression)")) %>% 
  mutate(proportion = count / sum(count)) %>% 
  mutate(clusterRes = ifelse(clusterRes=="B", "B cells", clusterRes),
         clusterRes = ifelse(clusterRes=="CD4", "CD4+T cells", clusterRes),
         clusterRes = ifelse(clusterRes=="CD8", "CD8+ T cells", clusterRes),
         clusterRes = ifelse(clusterRes=="NK", "NK cells", clusterRes),
         clusterRes = ifelse(clusterRes=="Mono", "Monocytes", clusterRes),
         clusterRes = ifelse(clusterRes=="DC", "Dendritic cells", clusterRes),
         clusterRes = ifelse(clusterRes=="Mega", "Megakaryocytes", clusterRes),
         clusterRes = ifelse(clusterRes=="Macro", "Macrophages", clusterRes),
         clusterRes = ifelse(clusterRes=="Neu", "Neutrophils", clusterRes))
```

```{r}
p1 = ggplot(data = Ren2021_plotDF[Ren2021_plotDF$clusterRes %in% c("CD8+ T cells", "Monocytes", "CD4+T cells", "B cells", "Megakaryocytes", "Plasma"),], aes(x = state, y = proportion)) +
    geom_boxplot(aes(color = state)) +
    theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    facet_grid(.~factor(clusterRes, levels=c("CD8+ T cells", "Monocytes", "CD4+T cells", "B cells", "Megakaryocytes", "Plasma"))) +
    theme(legend.position="none")


p2 = ggplot(data = Ren2021_plotDF[Ren2021_plotDF$clusterRes %in% c("NK cells", "Macrophages", "Dendritic cells", "Neutrophils"),], aes(x = state, y = proportion)) +
    geom_boxplot(aes(color = state)) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank()) +
    facet_grid(.~factor(clusterRes, levels=c("NK cells", "Macrophages", "Dendritic cells", "Neutrophils"))) + 
    theme(legend.position="bottom") +
  guides(color = guide_legend(nrow = 2))
p1/p2
```

```{r,eval=FALSE}
stat.test = stat.test1 %>% rbind(stat.test2) %>% rbind(stat.test3) %>% rbind(stat.test4) %>% 
  mutate(p.signif = ifelse(p < 0.01, "***", "n.s."),
         p.signif = ifelse(0.01<p&p<0.05, "**", p.signif),
         p.signif = ifelse(0.05<p&p<0.1, "*", p.signif)) %>% 
  filter(p.signif != 'n.s.') %>% 
  mutate(clusterRes = ifelse(clusterRes=="B", "B cells", clusterRes),
         clusterRes = ifelse(clusterRes=="CD4", "CD4+T cells", clusterRes),
         clusterRes = ifelse(clusterRes=="CD8", "CD8+ T cells", clusterRes),
         clusterRes = ifelse(clusterRes=="NK", "NK cells", clusterRes),
         clusterRes = ifelse(clusterRes=="Mono", "Monocytes", clusterRes),
         clusterRes = ifelse(clusterRes=="DC", "Dendritic cells", clusterRes),
         clusterRes = ifelse(clusterRes=="Mega", "Megakaryocytes", clusterRes),
         clusterRes = ifelse(clusterRes=="Macro", "Macrophages", clusterRes),
         clusterRes = ifelse(clusterRes=="Neu", "Neutrophils", clusterRes)) %>% 
  mutate(color = ifelse(!((clusterRes == "CD8+ T cells"&group1 == "control"&group2 == "mild/moderate (progression)") | (clusterRes == "Monocytes"&group1 == "mild/moderate (convalescence)"&group2 == "mild/moderate (progression)") | (clusterRes == "B cells"&group1 == "control"&group2 == "mild/moderate (progression)") | (clusterRes == "B cells"&group1 == "mild/moderate (convalescence)"&group2 == "mild/moderate (progression)")), "y1", "y2"))
save(stat.test, file = "/storage/holab/linxy/DCATS/real_world/Ren_2021/Ren2021_res.RData")
```

```{r}
#load("./data/real_world/Ren2021.RData")
pB1 = ggplot(data = Ren2021_plotDF[Ren2021_plotDF$clusterRes %in% c("CD8+ T cells", "Monocytes", "CD4+T cells", "B cells", "Megakaryocytes", "Plasma"),], aes(x = state, y = proportion)) +
    geom_boxplot(aes(color = state)) +
    theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
    facet_grid(.~factor(clusterRes, levels=c("CD8+ T cells", "Monocytes", "CD4+T cells", "B cells", "Megakaryocytes", "Plasma"))) +
    theme(legend.position="bottom")

pB2 = ggplot(data = Ren2021_plotDF[Ren2021_plotDF$clusterRes %in% c("NK cells", "Macrophages", "Dendritic cells", "Neutrophils"),], aes(x = state, y = proportion)) +
    geom_boxplot(aes(color = state)) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank()) +
    facet_grid(.~factor(clusterRes, levels=c("NK cells", "Macrophages", "Dendritic cells", "Neutrophils"))) + 
    theme(legend.position="bottom") +
  guides(color = guide_legend(nrow = 2))

stat.testp1 = stat.test %>% 
  mutate(y.position = ifelse(group1 == "control" & group2 == "severe/critical_progression", 0.95, 0.9),
         y.position = ifelse(group1 == "mild/moderate_convalescence" & group2 == "mild/moderate_progression", 0.1, y.position),
         y.position = ifelse(group1 == "severe/critical_convalescence" & group2 == "severe/critical_progression", 0.15, y.position)) %>% 
  filter(clusterRes %in% c("CD8+ T cells", "Monocytes", "CD4+T cells", "B cells", "Megakaryocytes", "Plasma"))
stat.testp2 = stat.test %>% 
  mutate(y.position = ifelse(group1 == "control" & group2 == "severe/critical_progression", 0.4, 0.35),
         y.position = ifelse(group1 == "mild/moderate_convalescence" & group2 == "mild/moderate_progression", 0.45, y.position),
         y.position = ifelse(group1 == "severe/critical_convalescence" & group2 == "severe/critical_progression", 0.5, y.position)) %>% 
  filter(clusterRes %in% c("NK cells", "Macrophages", "Dendritic cells", "Neutrophils"))

library(ggprism)
#p1 + add_pvalue(stat.testp1, tip.length = 0.02)
#p2 + add_pvalue(stat.testp2, tip.length = 0.002)

pB1 + add_pvalue(stat.testp1, tip.length = 0.015, step.increase = 0.03, colour = "color") + scale_color_manual(values=c("#F8766D", "#A3A500", "#00BF7D", "#00B0F6", "#E76BF3", "black", "red"))
ggsave("./plot/Ren_main.png", height = 8, width = 10)
```

### Real world data 4

```{r}
load("/storage/holab/linxy/DCATS/real_world/Schiller_2019/dcats_input.RData")
betabin_null = dcats_GLM(countM, designM)
betabin_null_ref = dcats_GLM(countM, designM, reference = "Club_cells")
```

```{r}
cbind(betabin_null$LRT_pvals %>% round(4) , betabin_null$fdr %>% round(4) , betabin_null_ref$LRT_pvals %>% round(4) , betabin_null_ref$fdr %>% round(4)) %>% knitr::kable()
cbind(betabin_null$LRT_pvals < 0.05 , betabin_null$fdr < 0.05 , betabin_null_ref$LRT_pvals < 0.05 , betabin_null_ref$fdr < 0.05)
```


