---
title: "Real word data"
author: "Xinyi Lin"
date: "10/27/2020"
output: html_document
---

* Simulation data: experiment 1, 2, 4

* real word data: experiment 3, 5, 6, 7

* no data of exp6

* Exp 3, 5, 7 only fisher works, don’t have batches-> speckle and diffcyt don’t work

* Exp5: BM1, BM2, BM3 have far more less cells than AML

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r,message=FALSE,warning=FALSE}
library(splatter)
library(Seurat)
library(speckle)
library(DCATS)
library(ggplot2)
library(tidyverse)
library(diffcyt)
```

```{r}
source("functions.r")
```

Fisher's exact test

```{r}
get_fisherP = function(data = data){
  data_sum = data %>% 
    group_by(condition) %>% 
    summarise(n = n())
  
  data_count = data %>% 
    group_by(cluster, condition) %>% 
    summarise(n = n()) %>% 
    pivot_wider(names_from = "cluster", values_from = "n") %>% 
    mutate_all(~replace(., is.na(.), 0))

  fisher_pvals = rep(NA,ncol(data_count)-1)
  cluster_name = colnames(data_count)[-1]
  for (i in 2:ncol(data_count)) {
    cot_table = cbind(data_count[, i], data_sum$n-data_count[, i])
    fisher_pvals[i-1] = fisher.test(cot_table)$p.value
    }
  
  fisherP = data.frame(cluster = cluster_name, fisher_pvals = fisher_pvals)
  return(fisherP)
}
```

## Experiment 3

TIP is the one Hepheas used

```{r}
exp3_GFP <- read.delim("./data/real_word/Exp3_Farbehi_2019/GFP_tSNE_cluster_ID_table.txt") %>% 
  mutate(cluster = as.factor(cluster),
         experiment = as.factor(experiment))
exp3_TIP <- read.delim("./data/real_word/Exp3_Farbehi_2019/TIP_tSNE_cluster_ID_table.txt") %>% 
  mutate(cluster = as.factor(cluster),
         experiment = as.factor(experiment))
head(exp3_GFP)
head(exp3_TIP)
summary(exp3_GFP)
summary(exp3_TIP)
```

diffcyt cannot works without batch

```{r, eval=FALSE}
cell_numberL = exp3_TIP_37_sum$n
# Function to create random data (one sample)
d_random <- function(cell_number, mean = 0, sd = 1, ncol = 20, cofactor = 5) {
  d <- sinh(matrix(rnorm(cell_number*20, mean, sd), ncol = ncol)) * cofactor
  colnames(d) <- paste0("marker", sprintf("%02d", 1:ncol))
  return(d)
}
# Create random data (without differential signal)
set.seed(123)
d_input <- list(
  sample1 = d_random(cell_number = cell_numberL[1]), 
  sample2 = d_random(cell_number = cell_numberL[2])
)
experiment_info <- data.frame(
  sample_id = factor(exp3_TIP_37_sum$experiment), 
  stringsAsFactors = FALSE
)
marker_info <- data.frame(
  channel_name = paste0("channel", sprintf("%03d", 1:20)), 
  marker_name = paste0("marker", sprintf("%02d", 1:20)), 
  marker_class = factor(c(rep("type", 10), rep("state", 10)), 
                          levels = c("type", "state", "none")), 
  stringsAsFactors = FALSE
)
# Prepare data
d_se <- prepareData(d_input, experiment_info, marker_info)
# Transform data
d_se <- transformData(d_se)
# Generate clusters
d_se <- generateClusters(d_se)
# Replace with our simulated data info
d_se@elementMetadata$sample_id = exp3_TIP_37$experiment
d_se@elementMetadata$cluster_id = exp3_TIP_37$cluster
# Calculate counts
d_counts <- calcCounts(d_se)
# Create design matrix
design <- createDesignMatrix(experiment_info, cols_design = "sample_id")
# Create contrast matrix
contrast <- createContrast(c(0, 1))
# Test for differential abundance (DA) of clusters
res_DA <- testDA_edgeR(d_counts, design, contrast)
diffcytP = topTable(res_DA, format_vals = TRUE) %>% 
  as.data.frame() %>% 
  rownames_to_column("cluster") %>% 
  dplyr::rename(diffcyt_pvals = p_adj) %>% 
  select(cluster, diffcyt_pvals)
```

```{r}
## MI-Day3 vs MI-Day7
exp3_TIP_37 = exp3_TIP %>% 
  filter(experiment != "Sham") %>% 
  dplyr::rename(condition = experiment)
fisherP = get_fisherP(exp3_TIP_37)
print(fisherP)

## Sham vs MI-Day7
exp3_TIP_S3 = exp3_TIP %>% 
  filter(experiment != "MI-Day 7") %>% 
  dplyr::rename(condition = experiment)
fisherP = get_fisherP(exp3_TIP_S3)
print(fisherP)

## Sham vs MI-Day3
exp3_TIP_S7 = exp3_TIP %>% 
  filter(experiment != "MI-Day 3") %>% 
  dplyr::rename(condition = experiment)
fisherP = get_fisherP(exp3_TIP_S7)
print(fisherP)
```

## Experiment 5

```{r}
exp5_AML <- read.delim("./data/real_word/Exp5_Galen/GSM3587924_AML1012-D0.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "AML")
head(exp5_AML)
summary(exp5_AML)

exp5_BM1 <- read.delim("./data/real_word/Exp5_Galen/GSM3587996_BM1.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM1")
head(exp5_BM1)
summary(exp5_BM1)

exp5_BM2 <- read.delim("./data/real_word/Exp5_Galen/GSM3587997_BM2.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM2")
head(exp5_BM2)
summary(exp5_BM2)

exp5_BM3 <- read.delim("./data/real_word/Exp5_Galen/GSM3587999_BM3.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM3")
head(exp5_BM3)
summary(exp5_BM3)

exp5_BM4 <- read.delim("./data/real_word/Exp5_Galen/GSM3588001_BM4.anno.txt") %>% 
  select(Cell, CellType) %>% 
  mutate(cluster = as.factor(CellType),
         condition = "BM4")
head(exp5_BM4)
summary(exp5_BM4)
```

BM1, BM2, BM3 have far more less cells than AML

```{r}
## AML vs BM1
exp5_A1 = rbind(exp5_AML, exp5_BM1)
fisherP = get_fisherP(exp5_A1)
print(fisherP)

## AML vs BM2
exp5_A2 = rbind(exp5_AML, exp5_BM2)
fisherP = get_fisherP(exp5_A2)
print(fisherP)

## AML vs BM3
exp5_A3 = rbind(exp5_AML, exp5_BM3)
fisherP = get_fisherP(exp5_A3)
print(fisherP)

## AML vs BM4
exp5_A4 = rbind(exp5_AML, exp5_BM4)
fisherP = get_fisherP(exp5_A4)
print(fisherP)
```

## Experiment 6

```{r}
matrix1 = readMM(gzfile("./data/real_word/Exp6_Kang/GSM2560248_2.1.mtx.gz")) %>% 
  as.matrix()
matrix2 = readMM(gzfile("./data/real_word/Exp6_Kang/GSM2560249_2.2.mtx.gz")) %>% 
  as.matrix()
```

```{r}
data_dir1 = "./data/real_word/Exp6_Kang/GSM2560248"
list.files(data_dir1) # Should show barcodes.tsv, genes.tsv, and matrix.mtx
expression_matrix1 <- Read10X(data.dir = data_dir1)
seuratObj1 = CreateSeuratObject(counts = expression_matrix1)
seuratObj1 = AddMetaData(object = seuratObj1, metadata = rep("ctrl1", dim(seuratObj1)[2]), col.name = 'sample')

data_dir2 = "./data/real_word/Exp6_Kang/GSM2560249"
list.files(data_dir2) # Should show barcodes.tsv, genes.tsv, and matrix.mtx
expression_matrix2 <- Read10X(data.dir = data_dir2)
seuratObj2 = CreateSeuratObject(counts = expression_matrix2)
seuratObj2 = AddMetaData(object = seuratObj2, metadata = rep("ctrl2", dim(seuratObj2)[2]), col.name = 'sample')
```

```{r}
cluster_info = read.delim("./data/real_word/Exp6_Kang/GSE96583_batch2.total.tsne.df.tsv")
head(cluster_info)
summary(as.factor(cluster_info$cell))
```

```{r}
ggplot(cluster_info, aes(x = tsne1, y = tsne2, color = cell)) +
  geom_point() +
  facet_grid(. ~ stim)
```

```{r}
ctrl1 = cluster_info %>% 
  filter(cell %in% c("CD4 T cells", "CD14+ Monocytes", "FCGR3A+ Monocytes")) %>% 
  filter(stim == "ctrl")
ctrl2 = cluster_info %>% 
  filter(cell %in% c("CD4 T cells", "CD14+ Monocytes", "FCGR3A+ Monocytes")) %>% 
  filter(stim == "stim")

mat1 = subset(seuratObj1, cells = rownames(ctrl1))@assays$RNA@counts %>% 
  as.matrix()
mat2 = subset(seuratObj2, cells = rownames(ctrl2))@assays$RNA@counts %>% 
  as.matrix()
```


## Experiment 7

The 'group' column started with 'B' is not useful here.

```{r}
exp7_data <- read.csv("./data/real_word/Adam_2017/celltypelabels_Haber.txt", sep="") %>% 
  rownames_to_column("cell") %>% 
  separate(cell, c("group", "barcode", "condition", "cluster"), sep = "_") %>% 
  mutate(group = as.factor(group),
         condition = as.factor(condition),
         cluster = as.factor(cluster))

head(exp7_data)
summary(exp7_data)

exp7_data %>% 
  group_by(group, condition) %>% 
  summarise(n = n())
```

```{r}
## control vs Hpoly.Day3
exp7_C3 = exp7_data %>% 
  filter(condition == "Control" | condition == "Hpoly.Day3") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_C3)
print(fisherP)

## control vs Hpoly.Day10
exp7_C10 = exp7_data %>% 
  filter(condition == "Control" | condition == "Hpoly.Day10") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_C10)
print(fisherP)

## control vs Salmonella
exp7_CS = exp7_data %>% 
  filter(condition == "Control" | condition == "Salmonella") %>% 
  select(condition, cluster)
fisherP = get_fisherP(exp7_CS)
print(fisherP)
```



## Codes

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```
