---
title: "Simulation_plus4"
author: "Xinyi Lin"
date: "10/28/2020"
output: html_document
---

Try to add noise by myself.

Question: What kind of noise distribution

1. Different number of cells

2. Amplify(uniform distribution)

3. Different drop-out rate

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r,message=FALSE,warning=FALSE}
library(splatter)
library(Seurat)
library(speckle)
library(DCATS)
library(ggplot2)
library(tidyverse)
library(diffcyt)
```

```{r}
source("functions.r")
```

```{r,warning=FALSE, message=FALSE}
library(future)
# check the current active plan
plan()
# change the current plan to access parallelization
plan("multiprocess", workers = 4)
plan()
options(future.globals.maxSize = 2000 * 1024^2)
```

## different batch size

```{r}
## Six clusters
set.seed(123)
probNor = c(0.1, 0.2, 0.2, 0.1, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.3, 0.15, 0.1, 0.15)
batch_size = 5000
de_prob = runif(6, 0.01, 0.6)
setresolu = 0.2
```

```{r}
mnnCT7params = readRDS("./data/mnnCT7params.rds")
set.seed(123)
# simulate normal
param.groups <- setParams(mnnCT7params, batchCells = round(batch_size*runif(3, 0.8, 1.2)), nGenes = 1000)
simNor <- splatSimulateGroups(param.groups, group.prob = probNor, de.prob = de_prob, verbose = FALSE)
simNor@colData@rownames = str_replace(simNor@colData@rownames, "Cell", "NorCell")
simNor_mat <- counts(simNor)
# simulate mutate
param.groups <- setParams(mnnCT7params, batchCells = round(batch_size*runif(3, 0.8, 1.2)), nGenes = 1000)
simMut <- splatSimulateGroups(param.groups, group.prob = probMut, de.prob = de_prob, verbose = FALSE)
simMut@colData@rownames = str_replace(simMut@colData@rownames, "Cell", "MutCell")
simMut_mat <- counts(simMut)
  
# batch information
batchNor = simNor@colData@listData$Batch %>% 
  str_replace("Batch", "Nor")
batchMut = simMut@colData@listData$Batch %>% 
  str_replace("Batch", "Mut")
  
origLabels = c(simNor@colData@listData$Group, simMut@colData@listData$Group)

sim_list = list(simNor_mat = simNor_mat, simMut_mat = simMut_mat, batchNor = batchNor, batchMut = batchMut, origLabels = origLabels)
```

```{r}
#integratedSamples = runSeurat(sim_list, batch_size, setresolu)
#saveRDS(integratedSamples, "./data/integratedSamples_addnoise1.rds")
integratedSamples = readRDS("./data/integratedSamples_addnoise1.rds")
```

```{r}
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
```

The results is weird.

## Add more noise in expression matrix

```{r}
set.seed(123)
probNor = c(0.1, 0.2, 0.2, 0.1, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.3, 0.15, 0.1, 0.15)
batch_size = 5000
de_prob = runif(6, 0.01, 0.6)
setresolu = 0.2

mnnCT7params = readRDS("./data/mnnCT7params.rds")
sim_list = simualtionRWD(probNor, probMut, de_prob, batch_size, params = mnnCT7params)
```

```{r}
sim_list$simNor_mat[c(1:10), c(1:10)]
```

Add noise: 1 multiple factors across samples

```{r}
set.seed(123)
new_simNor_mat = runif(dim(sim_list$simNor_mat)[1], 0.8, 1.2)*sim_list$simNor_mat
new_simNor_mat = round(new_simNor_mat*runif(dim(sim_list$simNor_mat)[2], 0.6, 1.4))
```

```{r}
set.seed(345)
new_simMut_mat = runif(dim(sim_list$simMut_mat)[1], 0.8, 1.2)*sim_list$simMut_mat
new_simMut_mat = round(new_simMut_mat*runif(dim(sim_list$simMut_mat)[2], 0.6, 1.4))
```

```{r}
#integratedSamples = runSeurat(sim_list, batch_size, setresolu)
#saveRDS(integratedSamples, "./data/integratedSamples_addnoise2.rds")
integratedSamples = readRDS("./data/integratedSamples_addnoise2.rds")
sendEmail("Simulation is done!")
```

```{r}
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
```

Try to sample different batch sizes from simulated data. And this also result in different drop-out pattern in different batches.

```{r}
set.seed(123)
probNor = c(0.1, 0.2, 0.2, 0.1, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.3, 0.15, 0.1, 0.15)
batch_size = 10000
de_prob = runif(6, 0.01, 0.6)
setresolu = 0.3

mnnCT7params = readRDS("./data/mnnCT7params.rds")
sim_list = simualtionRWD(probNor, probMut, de_prob, batch_size, params = mnnCT7params)
```

```{r}
# normal sample
set.seed(123)
sample_sizeNor = runif(3, 0.4, 0.6)
Norbatch1_idx = sample(batch_size, sample_sizeNor[1]*batch_size)
Norbatch2_idx = batch_size + sample(batch_size, sample_sizeNor[2]*batch_size)
Norbatch3_idx = batch_size*2 + sample(batch_size, sample_sizeNor[3]*batch_size)
Nor_idx = c(Norbatch1_idx, Norbatch2_idx, Norbatch3_idx)

simNor_mat = sim_list$simNor_mat[,Nor_idx]
batchNor = sim_list$batchNor[Nor_idx]
origLabels_Nor = sim_list$origLabels[c(1:batch_size*3)][Nor_idx]

# mutate sample
sample_sizeMut = runif(3, 0.4, 0.6)
Mutbatch1_idx = sample(batch_size, sample_sizeMut[1]*batch_size)
Mutbatch2_idx = batch_size + sample(batch_size, sample_sizeMut[2]*batch_size)
Mutbatch3_idx = batch_size*2 + sample(batch_size, sample_sizeMut[3]*batch_size)
Mut_idx = c(Mutbatch1_idx, Mutbatch2_idx, Mutbatch3_idx)

simMut_mat = sim_list$simMut_mat[,Mut_idx]
batchMut = sim_list$batchMut[Mut_idx]
origLabels_Mut = sim_list$origLabels[c(1:batch_size*3)][Mut_idx]

origLabels = c(origLabels_Nor, origLabels_Mut)
sim_list = list(simNor_mat = simNor_mat, simMut_mat = simMut_mat, batchNor = batchNor, batchMut = batchMut, origLabels = origLabels)
```

```{r}
#integratedSamples = runSeurat(sim_list, batch_size, setresolu)
#saveRDS(integratedSamples, "./data/integratedSamples_addnoise3.rds")
integratedSamples = readRDS("./data/integratedSamples_addnoise3.rds")
sendEmail("Simulation is done!")
```

```{r}
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
```

Try using HCC parameters

```{r}
set.seed(123)
probNor = c(0.1, 0.2, 0.2, 0.1, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.3, 0.15, 0.1, 0.15)
batch_size = 10000
de_prob = runif(6, 0.01, 0.6)
setresolu = 0.2

HCCparams = readRDS("./data/HCCparams.rds")
sim_list = simualtionRWD(probNor, probMut, de_prob, batch_size, params = HCCparams)
```

```{r}
# normal sample
set.seed(123)
sample_sizeNor = runif(3, 0.4, 0.6)
Norbatch1_idx = sample(batch_size, sample_sizeNor[1]*batch_size)
Norbatch2_idx = batch_size + sample(batch_size, sample_sizeNor[2]*batch_size)
Norbatch3_idx = batch_size*2 + sample(batch_size, sample_sizeNor[3]*batch_size)
Nor_idx = c(Norbatch1_idx, Norbatch2_idx, Norbatch3_idx)

simNor_mat = sim_list$simNor_mat[,Nor_idx]
batchNor = sim_list$batchNor[Nor_idx]
origLabels_Nor = sim_list$origLabels[c(1:batch_size*3)][Nor_idx]

# mutate sample
sample_sizeMut = runif(3, 0.4, 0.6)
Mutbatch1_idx = sample(batch_size, sample_sizeMut[1]*batch_size)
Mutbatch2_idx = batch_size + sample(batch_size, sample_sizeMut[2]*batch_size)
Mutbatch3_idx = batch_size*2 + sample(batch_size, sample_sizeMut[3]*batch_size)
Mut_idx = c(Mutbatch1_idx, Mutbatch2_idx, Mutbatch3_idx)

simMut_mat = sim_list$simMut_mat[,Mut_idx]
batchMut = sim_list$batchMut[Mut_idx]
origLabels_Mut = sim_list$origLabels[c(1:batch_size*3)][Mut_idx]

origLabels = c(origLabels_Nor, origLabels_Mut)
sim_list = list(simNor_mat = simNor_mat, simMut_mat = simMut_mat, batchNor = batchNor, batchMut = batchMut, origLabels = origLabels)
```

```{r}
integratedSamples = runSeurat(sim_list, batch_size, setresolu)
saveRDS(integratedSamples, "./data/integratedSamples_addnoise4.rds")
integratedSamples = readRDS("./data/integratedSamples_addnoise4.rds")
sendEmail("Simulation is done!")
```

```{r}
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
```

## Codes

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```
