---
title: "Simulation_plus4"
author: "Xinyi Lin"
date: "10/28/2020"
output: html_document
---

Try to add noise by myself.

Question: What kind of noise distribution

1. Different number of cells

2. Amplify(uniform distribution)

3. Different drop-out rate

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r,message=FALSE,warning=FALSE}
library(splatter)
library(Seurat)
library(speckle)
library(DCATS)
library(ggplot2)
library(tidyverse)
library(diffcyt)
```

```{r}
source("functions.r")
```

```{r,warning=FALSE, message=FALSE}
library(future)
# check the current active plan
plan()
# change the current plan to access parallelization
plan("multiprocess", workers = 4)
plan()
options(future.globals.maxSize = 2000 * 1024^2)
```

## different batch size

```{r}
## Six clusters
set.seed(123)
probNor = c(0.1, 0.2, 0.2, 0.1, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.3, 0.15, 0.1, 0.15)
batch_size = 5000
de_prob = runif(6, 0.01, 0.6)
setresolu = 0.2
```

```{r}
mnnCT7params = readRDS("./data/mnnCT7params.rds")
set.seed(123)
# simulate normal
param.groups <- setParams(mnnCT7params, batchCells = round(batch_size*runif(3, 0.8, 1.2)), nGenes = 1000)
simNor <- splatSimulateGroups(param.groups, group.prob = probNor, de.prob = de_prob, verbose = FALSE)
simNor@colData@rownames = str_replace(simNor@colData@rownames, "Cell", "NorCell")
simNor_mat <- counts(simNor)
# simulate mutate
param.groups <- setParams(mnnCT7params, batchCells = round(batch_size*runif(3, 0.8, 1.2)), nGenes = 1000)
simMut <- splatSimulateGroups(param.groups, group.prob = probMut, de.prob = de_prob, verbose = FALSE)
simMut@colData@rownames = str_replace(simMut@colData@rownames, "Cell", "MutCell")
simMut_mat <- counts(simMut)
  
# batch information
batchNor = simNor@colData@listData$Batch %>% 
  str_replace("Batch", "Nor")
batchMut = simMut@colData@listData$Batch %>% 
  str_replace("Batch", "Mut")
  
origLabels = c(simNor@colData@listData$Group, simMut@colData@listData$Group)

sim_list = list(simNor_mat = simNor_mat, simMut_mat = simMut_mat, batchNor = batchNor, batchMut = batchMut, origLabels = origLabels)
```

```{r}
#integratedSamples = runSeurat(sim_list, batch_size, setresolu)
#saveRDS(integratedSamples, "./data/integratedSamples_addnoise1.rds")
integratedSamples = readRDS("./data/integratedSamples_addnoise1.rds")
```

```{r}
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
```

The results is weird.

## Add more noise in expression matrix

```{r}
set.seed(123)
probNor = c(0.1, 0.2, 0.2, 0.1, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.3, 0.15, 0.1, 0.15)
batch_size = 5000
de_prob = runif(6, 0.01, 0.6)
setresolu = 0.2

mnnCT7params = readRDS("./data/mnnCT7params.rds")
sim_list = simualtionRWD(probNor, probMut, de_prob, batch_size, params = mnnCT7params)
```

```{r}
sim_list$simNor_mat[c(1:10), c(1:10)]
```

Add noise: 1 multiple factors across samples

```{r}
set.seed(123)
new_simNor_mat = runif(dim(sim_list$simNor_mat)[1], 0.8, 1.2)*sim_list$simNor_mat
new_simNor_mat = round(new_simNor_mat*runif(dim(sim_list$simNor_mat)[2], 0.6, 1.4))
```

```{r}
set.seed(345)
new_simMut_mat = runif(dim(sim_list$simMut_mat)[1], 0.8, 1.2)*sim_list$simMut_mat
new_simMut_mat = round(new_simMut_mat*runif(dim(sim_list$simMut_mat)[2], 0.6, 1.4))
```

```{r}
#integratedSamples = runSeurat(sim_list, batch_size, setresolu)
#saveRDS(integratedSamples, "./data/integratedSamples_addnoise2.rds")
integratedSamples = readRDS("./data/integratedSamples_addnoise2.rds")
sendEmail("Simulation is done!")
```

```{r}
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
```

Try to sample different batch sizes from simulated data. And this also result in different drop-out pattern in different batches.

```{r}
set.seed(123)
probNor = c(0.1, 0.2, 0.2, 0.1, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.3, 0.15, 0.1, 0.15)
batch_size = 10000
de_prob = runif(6, 0.01, 0.6)
setresolu = 0.21

mnnCT7params = readRDS("./data/mnnCT7params.rds")
sim_list = simualtionRWD(probNor, probMut, de_prob, batch_size, params = mnnCT7params)
```

```{r}
# normal sample
set.seed(234)
sample_sizeNor = runif(3, 0.4, 0.6) %>% round(4)
Norbatch1_idx = sample(batch_size, sample_sizeNor[1]*batch_size)
Norbatch2_idx = batch_size + sample(batch_size, sample_sizeNor[2]*batch_size)
Norbatch3_idx = batch_size*2 + sample(batch_size, sample_sizeNor[3]*batch_size)
Nor_idx = c(Norbatch1_idx, Norbatch2_idx, Norbatch3_idx)

simNor_mat = sim_list$simNor_mat[,Nor_idx]
batchNor = sim_list$batchNor[Nor_idx]
origLabels_Nor = sim_list$origLabels[c(1:batch_size*3)][Nor_idx]

# mutate sample
sample_sizeMut = runif(3, 0.4, 0.6) %>% round(4)
Mutbatch1_idx = sample(batch_size, sample_sizeMut[1]*batch_size+1)
Mutbatch2_idx = batch_size + sample(batch_size, sample_sizeMut[2]*batch_size)
Mutbatch3_idx = batch_size*2 + sample(batch_size, sample_sizeMut[3]*batch_size)
Mut_idx = c(Mutbatch1_idx, Mutbatch2_idx, Mutbatch3_idx)

simMut_mat = sim_list$simMut_mat[,Mut_idx]
batchMut = sim_list$batchMut[Mut_idx]
origLabels_Mut = sim_list$origLabels[c(1:batch_size*3)][Mut_idx]

origLabels = c(origLabels_Nor, origLabels_Mut)
sim_list = list(simNor_mat = simNor_mat, simMut_mat = simMut_mat, batchNor = batchNor, batchMut = batchMut, origLabels = origLabels)
```

```{r}
#integratedSamples = runSeurat(sim_list, batch_size, setresolu)
#saveRDS(integratedSamples, "./data/integratedSamples_addnoise3.rds")
integratedSamples = readRDS("./data/integratedSamples_addnoise3.rds")
#sendEmail("Simulation is done!")
```

```{r}
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
```

```{r}
Res = getPandTimeFSDD6(integratedSamples, sim_list, batch_size)
print(Res$time_df)
print(Res$knn_mat)
  
cluster_map = apply(conf.mat, 2, which.max) %>% 
  plyr::mapvalues(from = c(1:6), to = c("A", "B", "C", "D", "E", "F")) %>% 
  as_tibble() %>% 
  mutate(truth = c("N", "N", "P", "P", "P", "P")) %>% 
  dplyr::rename(cluster = value)
Res$Res_df %>% 
    mutate(speckle_res = ifelse(speckle_pvals < 0.05, "P", "N"),
           dcatsT_res = ifelse(dcats_pvalsT < 0.05, "P", "N"),
           dcatsI_res = ifelse(dcats_pvalsI < 0.05, "P", "N"),
           dcatsU_res = ifelse(dcats_pvalsU < 0.05, "P", "N"),
           dcatsK_res = ifelse(dcats_pvalsK < 0.05, "P", "N"),
           fisher_res = ifelse(fisher_pvals < 0.05, "P", "N")) %>% 
    merge(cluster_map, by = "cluster") %>% 
    print()
```

```{r}
dfRes = data.frame(clusterRes = integratedSamples@active.ident, batch = integratedSamples$batch, condition = integratedSamples$condition) %>% 
  tibble::rownames_to_column("cellID")
  
## Fisher's exact test
dfCount = dfRes %>% 
  group_by(condition, clusterRes) %>% 
  summarise(n = n()) %>% 
  pivot_wider(names_from = "clusterRes", values_from = "n") %>% 
  mutate(nonA = batch_size*6 - A,
         nonB = batch_size*6 - B,
         nonC = batch_size*6 - C,
         nonD = batch_size*6 - D,
         nonE = batch_size*6 - E,
         nonF = batch_size*6 - F)
fisher_pvals = rep(NA,3)
for (i in 1:6){
  fisher_pvals[i] = fisher.test(dfCount[,c(i+1,i+7)])$p.value}
fisherP = data.frame(cluster = c("A", "B", "C", "D", "E", "F"), fisher_pvals = fisher_pvals)
  
## speckle
speckleRes = propeller(clusters = dfRes$clusterRes, sample = dfRes$batch, group = dfRes$condition)
speckleP = data.frame(cluster = speckleRes$BaselineProp.clusters, speckle_pvals = speckleRes$FDR)
  
## DCATS
celllabels_orig = sim_list$origLabels
conf.mat<-table(Idents(integratedSamples), celllabels_orig)
true.conf<-t(t(conf.mat)/apply(conf.mat,2,sum))
library(clue)
order = as.vector(solve_LSAP(true.conf, maximum = TRUE))
condition = integratedSamples@meta.data$condition
condNor<-Idents(integratedSamples)[condition == "Normal"]
condMut<-Idents(integratedSamples)[condition == "Mutate"]
countNor = table(sim_list$batchNor, condNor)
countMut = table(sim_list$batchMut, condMut)
dcatsResT = dcats_fit(countNor, countMut, true.conf[,order])  # true similarity matrix
dcatsResI = dcats_fit(countNor, countMut, diag(6))  # identity matrix
dcatsResU = dcats_fit(countNor, countMut, get_similarity_mat(6, 0.05)) # uniform matrix
graphs = integratedSamples@graphs$integrated_snn
labels = Idents(integratedSamples)
knn_mat = KNN_transition(graphs, labels)
order = colnames(countNor)
dcatsResK = dcats_fit(countNor, countMut, knn_mat[order, order])
dcatsPT = data.frame(cluster = rownames(dcatsResT), dcats_pvalsT = dcatsResT$pvals)
dcatsPI = data.frame(cluster = rownames(dcatsResI), dcats_pvalsI = dcatsResI$pvals)
dcatsPU = data.frame(cluster = rownames(dcatsResU), dcats_pvalsU = dcatsResU$pvals)
dcatsPK = data.frame(cluster = rownames(dcatsResK), dcats_pvalsK = dcatsResK$pvals)
  
## diffcyt
# Function to create random data (one sample)
d_random <- function(cell_number, mean = 0, sd = 1, ncol = 20, cofactor = 5) {
  d <- sinh(matrix(rnorm(cell_number*20, mean, sd), ncol = ncol)) * cofactor
  colnames(d) <- paste0("marker", sprintf("%02d", 1:ncol))
  d
}
# Create random data (without differential signal)
d_input <- list(
  Nor1 = d_random(sample_sizeNor[1]*batch_size), 
  Nor2 = d_random(sample_sizeNor[2]*batch_size), 
  Nor3 = d_random(sample_sizeNor[3]*batch_size), 
  Mut1 = d_random(sample_sizeMut[1]*batch_size),
  Mut2 = d_random(sample_sizeMut[2]*batch_size),
  Mut3 = d_random(sample_sizeMut[3]*batch_size)
)
experiment_info <- data.frame(
  sample_id = factor(c("Nor1", "Nor2", "Nor3", "Mut1", "Mut2", "Mut3")), 
  group_id = factor(c(rep("Normal", 3), rep("Mutate", 3))), 
  stringsAsFactors = FALSE
)
marker_info <- data.frame(
  channel_name = paste0("channel", sprintf("%03d", 1:20)), 
  marker_name = paste0("marker", sprintf("%02d", 1:20)), 
  marker_class = factor(c(rep("type", 10), rep("state", 10)), levels = c("type", "state", "none")), 
  stringsAsFactors = FALSE
)
# Prepare data
d_se <- prepareData(d_input, experiment_info, marker_info)
# Transform data
d_se <- transformData(d_se)
# Generate clusters
d_se <- generateClusters(d_se)
# Replace with our simulated data info
d_se@elementMetadata$sample_id = integratedSamples$batch
d_se@elementMetadata$group_id = integratedSamples$condition
d_se@elementMetadata$cluster_id = integratedSamples@active.ident
# Calculate counts
d_counts <- calcCounts(d_se)
# Create design matrix
design <- createDesignMatrix(experiment_info, cols_design = "group_id")
# Create contrast matrix
contrast <- createContrast(c(0, 1))
# Test for differential abundance (DA) of clusters
res_DA <- testDA_edgeR(d_counts, design, contrast)
diffcytP = topTable(res_DA, format_vals = TRUE) %>% 
  as.data.frame() %>% 
  rownames_to_column("cluster") %>% 
  dplyr::rename(diffcyt_pvals = p_adj) %>% 
  select(cluster, diffcyt_pvals)
  
## results
Res_df = merge(dcatsPT, speckleP, by = "cluster") %>% 
  merge(dcatsPI, by = "cluster") %>% 
  merge(dcatsPU, by = "cluster") %>% 
  merge(dcatsPK, by = "cluster") %>%
  merge(fisherP, by = "cluster") %>% 
  merge(diffcytP, by = "cluster")

```


Try using HCC parameters

```{r}
set.seed(123)
probNor = c(0.1, 0.2, 0.2, 0.1, 0.2, 0.2)
probMut = c(0.1, 0.2, 0.3, 0.15, 0.1, 0.15)
batch_size = 10000
de_prob = runif(6, 0.01, 0.6)
setresolu = 0.1

HCCparams = readRDS("./data/HCCparams.rds")
sim_list = simualtionRWD(probNor, probMut, de_prob, batch_size, params = HCCparams)
```

```{r}
# normal sample
set.seed(123)
sample_sizeNor = runif(3, 0.4, 0.6)
Norbatch1_idx = sample(batch_size, sample_sizeNor[1]*batch_size)
Norbatch2_idx = batch_size + sample(batch_size, sample_sizeNor[2]*batch_size)
Norbatch3_idx = batch_size*2 + sample(batch_size, sample_sizeNor[3]*batch_size)
Nor_idx = c(Norbatch1_idx, Norbatch2_idx, Norbatch3_idx)

simNor_mat = sim_list$simNor_mat[,Nor_idx]
batchNor = sim_list$batchNor[Nor_idx]
origLabels_Nor = sim_list$origLabels[c(1:batch_size*3)][Nor_idx]

# mutate sample
sample_sizeMut = runif(3, 0.4, 0.6)
Mutbatch1_idx = sample(batch_size, sample_sizeMut[1]*batch_size)
Mutbatch2_idx = batch_size + sample(batch_size, sample_sizeMut[2]*batch_size)
Mutbatch3_idx = batch_size*2 + sample(batch_size, sample_sizeMut[3]*batch_size)
Mut_idx = c(Mutbatch1_idx, Mutbatch2_idx, Mutbatch3_idx)

simMut_mat = sim_list$simMut_mat[,Mut_idx]
batchMut = sim_list$batchMut[Mut_idx]
origLabels_Mut = sim_list$origLabels[c(1:batch_size*3)][Mut_idx]

origLabels = c(origLabels_Nor, origLabels_Mut)
sim_list = list(simNor_mat = simNor_mat, simMut_mat = simMut_mat, batchNor = batchNor, batchMut = batchMut, origLabels = origLabels)
```

```{r}
#integratedSamples = runSeurat(sim_list, batch_size, setresolu)
#saveRDS(integratedSamples, "./data/integratedSamples_addnoise4.rds")
integratedSamples = readRDS("./data/integratedSamples_addnoise4.rds")
sendEmail("Simulation is done!")
```

```{r}
conf.mat<-table(Idents(integratedSamples), sim_list$origLabels)
print(conf.mat)
plot = DimPlot(integratedSamples, ncol = 3, reduction = "umap", split.by = "batch") + ggtitle("Cluster Results of Different Clusters in Different Samples")
print(plot)
```

## Codes

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE}
```
